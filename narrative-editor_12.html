<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Narrative Game Forum Editor</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/reactflow@11.10.1/dist/umd/index.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reactflow@11.10.1/dist/style.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .toolbar {
            background: #252526;
            padding: 12px 20px;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .toolbar button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .toolbar button:hover {
            background: #1177bb;
        }

        .toolbar button.secondary {
            background: #3e3e42;
        }

        .toolbar button.secondary:hover {
            background: #505050;
        }

        .toolbar .view-toggle {
            margin-left: auto;
            display: flex;
            gap: 8px;
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .tree-panel {
            width: 300px;
            background: #252526;
            border-right: 1px solid #3e3e42;
            overflow-y: auto;
            padding: 12px;
        }

        .tree-item {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            margin-bottom: 4px;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tree-item:hover {
            background: #2a2d2e;
        }

        .tree-item.selected {
            background: #094771;
        }

        .tree-item.category {
            font-weight: 600;
            color: #4ec9b0;
        }

        .tree-item.thread {
            padding-left: 24px;
            color: #dcdcaa;
        }

        .tree-item.post {
            padding-left: 48px;
            color: #ce9178;
        }

        .tree-expand {
            width: 16px;
            text-align: center;
            font-size: 12px;
        }

        .editor-panel {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .graph-panel {
            flex: 1;
            background: #1e1e1e;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #9cdcfe;
            font-size: 14px;
            font-weight: 500;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group textarea {
            width: 100%;
            background: #3c3c3c;
            border: 1px solid #3e3e42;
            color: #d4d4d4;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .form-group select {
            width: 100%;
            background: #3c3c3c;
            border: 1px solid #3e3e42;
            color: #d4d4d4;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-section {
            background: #2d2d30;
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 16px;
            border: 1px solid #3e3e42;
        }

        .form-section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #4ec9b0;
        }

        .option-item {
            background: #252526;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 8px;
            border: 1px solid #3e3e42;
        }

        .option-item button {
            background: #c73131;
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 8px;
        }

        .add-button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
        }

        .add-button:hover {
            background: #1177bb;
        }

        .json-editor {
            width: 100%;
            height: calc(100vh - 200px);
            background: #1e1e1e;
            color: #d4d4d4;
            border: 1px solid #3e3e42;
            padding: 16px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            border-radius: 4px;
        }

        .error-message {
            background: #5a1d1d;
            border: 1px solid #be1100;
            color: #f48771;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 16px;
        }

        .success-message {
            background: #1e3a1e;
            border: 1px solid #14892c;
            color: #89d185;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 16px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .react-flow__node {
            background: #252526;
            border: 2px solid #3e3e42;
            border-radius: 6px;
            padding: 12px;
            color: #d4d4d4;
            font-size: 12px;
        }

        .react-flow__node.selected {
            border-color: #0e639c;
        }

        .react-flow__node-category {
            background: #1e4d3a;
            border-color: #4ec9b0;
        }

        .react-flow__node-thread {
            background: #3d3a1e;
            border-color: #dcdcaa;
        }

        .react-flow__node-post-original {
            background: #2d3d4d;
            border-color: #9cdcfe;
        }

        .react-flow__node-post-reply {
            background: #4d2d3d;
            border-color: #ce9178;
        }

        .react-flow__node-post-alert {
            background: #4d3d1e;
            border-color: #dcdcaa;
        }

        .react-flow__node.highlighted {
            border-color: #f48771 !important;
            border-width: 3px !important;
            box-shadow: 0 0 20px rgba(244, 135, 113, 0.6);
        }

        .react-flow__node.dimmed {
            opacity: 0.3;
        }

        .flag-badge {
            display: inline-block;
            background: #0e639c;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            margin-left: 4px;
            cursor: pointer;
        }

        .flag-badge:hover {
            background: #1177bb;
        }

        .flag-badge.sets-flag {
            background: #4ec9b0;
        }

        .flag-badge.requires-flag {
            background: #ce9178;
        }

        .minimap-container {
            position: absolute;
            bottom: 60px;
            right: 10px;
            width: 200px;
            height: 150px;
            background: rgba(37, 37, 38, 0.9);
            border: 1px solid #3e3e42;
            border-radius: 6px;
            overflow: hidden;
        }

        .node-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .node-subtitle {
            font-size: 10px;
            opacity: 0.7;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #858585;
        }

        .empty-state h2 {
            margin-bottom: 12px;
            color: #9cdcfe;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #0e639c;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useCallback, useEffect } = React;
        const ReactFlow = window.ReactFlow;
        const { MarkerType } = window.ReactFlow;

        // Sample data structure
        const SAMPLE_DATA = [
            {
                id: "cat_general",
                title: "General Discussion",
                subtitle: "General topics and announcements",
                icon: "spr_icon_general",
                threads: [
                    {
                        id: "thread_welcome",
                        title: "Welcome to the Forum!",
                        subtitle: "Admin • Pinned",
                        icon: "spr_icon_pin",
                        pinned: true,
                        posts: [
                            {
                                id: "post_welcome_1",
                                type: "original",
                                timestamp: 100,
                                user_name: "Admin",
                                user_rank: "Administrator",
                                avatar: "spr_avatar_admin",
                                body: "Welcome everyone! Please read the rules before posting.",
                                options: [
                                    {
                                        text: "Thanks!",
                                        reply_body: "Thanks for the welcome! I'll make sure to follow the rules.",
                                        set_flag: "FLAG_READ_WELCOME"
                                    },
                                    {
                                        text: "I have questions",
                                        reply_body: "I have some questions about how things work here. Can someone help?",
                                        set_flag: "FLAG_NEED_HELP"
                                    }
                                ]
                            }
                        ]
                    }
                ]
            }
        ];

        function App() {
            const [data, setData] = useState(() => {
                // Try to load auto-saved data first
                try {
                    const saved = localStorage.getItem('narrative-editor-data-autosave');
                    if (saved) {
                        console.log('Loaded auto-saved data');
                        return JSON.parse(saved);
                    }
                } catch (e) {
                    console.error('Failed to load auto-save:', e);
                }
                return SAMPLE_DATA;
            });
            const [selectedItem, setSelectedItem] = useState(null);
            const [view, setView] = useState('tree'); // 'tree', 'graph', 'json', 'utilities', 'preview'
            const [expandedItems, setExpandedItems] = useState(new Set(['cat_general']));
            const [message, setMessage] = useState(null);
            const [currentDay, setCurrentDay] = useState(0);
            const [nextTimestamp, setNextTimestamp] = useState(1000);
            const [detailModalItem, setDetailModalItem] = useState(null);
            const [notes, setNotes] = useState(() => {
                // Load notes from localStorage
                try {
                    const saved = localStorage.getItem('narrative-editor-notes');
                    return saved ? JSON.parse(saved) : {};
                } catch (e) {
                    console.error('Failed to load notes:', e);
                    return {};
                }
            });
            const [selectedNodes, setSelectedNodes] = useState(new Set()); // for multi-select
            const [searchTerm, setSearchTerm] = useState('');
            const [replaceTerm, setReplaceTerm] = useState('');
            const [simulatedFlags, setSimulatedFlags] = useState(new Set()); // for preview simulation
            const [simulatedDay, setSimulatedDay] = useState(0); // for preview simulation
            const [itemTags, setItemTags] = useState(() => {
                // Load tags from localStorage
                try {
                    const saved = localStorage.getItem('narrative-editor-tags');
                    return saved ? JSON.parse(saved) : {};
                } catch (e) {
                    console.error('Failed to load tags:', e);
                    return {};
                }
            });
            const [userLibrary, setUserLibrary] = useState(() => {
                // Load user library from localStorage
                try {
                    const saved = localStorage.getItem('narrative-editor-users');
                    return saved ? JSON.parse(saved) : [];
                } catch (e) {
                    console.error('Failed to load user library:', e);
                    return [];
                }
            });
            
            // Undo/Redo state
            const [history, setHistory] = useState([]);
            const [historyIndex, setHistoryIndex] = useState(-1);
            const [snapshots, setSnapshots] = useState(() => {
                // Load snapshots from localStorage
                try {
                    const saved = localStorage.getItem('narrative-editor-snapshots');
                    return saved ? JSON.parse(saved) : [];
                } catch (e) {
                    console.error('Failed to load snapshots:', e);
                    return [];
                }
            });

            // Save notes to localStorage whenever they change
            useEffect(() => {
                try {
                    localStorage.setItem('narrative-editor-notes', JSON.stringify(notes));
                } catch (e) {
                    console.error('Failed to save notes:', e);
                }
            }, [notes]);

            // Save tags to localStorage whenever they change
            useEffect(() => {
                try {
                    localStorage.setItem('narrative-editor-tags', JSON.stringify(itemTags));
                } catch (e) {
                    console.error('Failed to save tags:', e);
                }
            }, [itemTags]);

            // Save user library to localStorage whenever it changes
            useEffect(() => {
                try {
                    localStorage.setItem('narrative-editor-users', JSON.stringify(userLibrary));
                } catch (e) {
                    console.error('Failed to save user library:', e);
                }
            }, [userLibrary]);

            // Save snapshots to localStorage whenever they change
            useEffect(() => {
                try {
                    localStorage.setItem('narrative-editor-snapshots', JSON.stringify(snapshots));
                } catch (e) {
                    console.error('Failed to save snapshots:', e);
                }
            }, [snapshots]);

            // Add to history when data changes (for undo/redo)
            useEffect(() => {
                // Don't add to history if we're undoing/redoing
                if (historyIndex >= 0 && historyIndex < history.length - 1) {
                    return;
                }
                
                // Don't add duplicate entries
                if (history.length > 0 && JSON.stringify(history[history.length - 1]) === JSON.stringify(data)) {
                    return;
                }

                const newHistory = [...history.slice(0, historyIndex + 1), JSON.parse(JSON.stringify(data))];
                
                // Limit history to 50 entries
                if (newHistory.length > 50) {
                    newHistory.shift();
                    setHistory(newHistory);
                    setHistoryIndex(49);
                } else {
                    setHistory(newHistory);
                    setHistoryIndex(newHistory.length - 1);
                }
            }, [data]);

            // Auto-save data to localStorage every 30 seconds or on change
            useEffect(() => {
                const timer = setTimeout(() => {
                    try {
                        localStorage.setItem('narrative-editor-data-autosave', JSON.stringify(data));
                        localStorage.setItem('narrative-editor-data-autosave-time', new Date().toISOString());
                    } catch (e) {
                        console.error('Failed to auto-save:', e);
                    }
                }, 30000); // 30 seconds

                return () => clearTimeout(timer);
            }, [data]);

            // Expose data to window for project save
            useEffect(() => {
                window.narrativeData = data;
            }, [data]);

            // Smart ID generation
            const generateId = (type, text, existingIds) => {
                const stopWords = ['the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'is', 'was', 'are'];
                const words = text.toLowerCase()
                    .replace(/[^a-z0-9\s]/g, '')
                    .split(/\s+/)
                    .filter(w => w.length > 2 && !stopWords.includes(w))
                    .slice(0, 3);
                
                let baseId = '';
                if (type === 'category') {
                    baseId = 'cat_' + words.join('_');
                } else if (type === 'thread') {
                    baseId = 'th_' + words.join('_');
                } else if (type === 'post') {
                    baseId = 'p_' + words.join('_');
                }
                
                // Ensure uniqueness
                let finalId = baseId;
                let counter = 1;
                while (existingIds.has(finalId)) {
                    finalId = baseId + '_' + counter;
                    counter++;
                }
                
                return finalId;
            };

            // Undo/Redo functions
            const undo = () => {
                if (historyIndex > 0) {
                    setHistoryIndex(historyIndex - 1);
                    setData(JSON.parse(JSON.stringify(history[historyIndex - 1])));
                    showMessage('Undo', 'info');
                }
            };

            const redo = () => {
                if (historyIndex < history.length - 1) {
                    setHistoryIndex(historyIndex + 1);
                    setData(JSON.parse(JSON.stringify(history[historyIndex + 1])));
                    showMessage('Redo', 'info');
                }
            };

            // Keyboard shortcuts for undo/redo
            useEffect(() => {
                const handleKeyDown = (e) => {
                    // Ctrl+Z or Cmd+Z for undo
                    if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                        e.preventDefault();
                        undo();
                    }
                    // Ctrl+Shift+Z or Cmd+Shift+Z or Ctrl+Y for redo
                    if (((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'z') || 
                        (e.ctrlKey && e.key === 'y')) {
                        e.preventDefault();
                        redo();
                    }
                };

                document.addEventListener('keydown', handleKeyDown);
                return () => document.removeEventListener('keydown', handleKeyDown);
            }, [historyIndex, history]);

            // Snapshot functions
            const createSnapshot = (name) => {
                const snapshot = {
                    id: Date.now(),
                    name: name || `Snapshot ${snapshots.length + 1}`,
                    timestamp: new Date().toISOString(),
                    data: JSON.parse(JSON.stringify(data)),
                    notes: JSON.parse(JSON.stringify(notes)),
                    tags: JSON.parse(JSON.stringify(itemTags))
                };
                setSnapshots([...snapshots, snapshot]);
                showMessage(`Snapshot "${snapshot.name}" created`, 'success');
            };

            const restoreSnapshot = (snapshotId) => {
                const snapshot = snapshots.find(s => s.id === snapshotId);
                if (snapshot) {
                    if (confirm(`Restore snapshot "${snapshot.name}"? Current work will be added to undo history.`)) {
                        setData(JSON.parse(JSON.stringify(snapshot.data)));
                        setNotes(JSON.parse(JSON.stringify(snapshot.notes)));
                        setItemTags(JSON.parse(JSON.stringify(snapshot.tags)));
                        showMessage(`Restored "${snapshot.name}"`, 'success');
                    }
                }
            };

            const deleteSnapshot = (snapshotId) => {
                const snapshot = snapshots.find(s => s.id === snapshotId);
                if (snapshot && confirm(`Delete snapshot "${snapshot.name}"?`)) {
                    setSnapshots(snapshots.filter(s => s.id !== snapshotId));
                    showMessage(`Deleted "${snapshot.name}"`, 'success');
                }
            };

            const getAllIds = () => {
                const ids = new Set();
                data.forEach(cat => {
                    ids.add(cat.id);
                    cat.threads.forEach(thread => {
                        ids.add(thread.id);
                        thread.posts.forEach(post => {
                            ids.add(post.id);
                        });
                    });
                });
                return ids;
            };

            const getAllFlags = () => {
                const flags = new Map(); // flag -> { setBy: [], requiredBy: [] }
                data.forEach((cat, catIdx) => {
                    cat.threads.forEach((thread, threadIdx) => {
                        // Check thread conditions
                        if (thread.conditions?.requires_flag) {
                            const flag = thread.conditions.requires_flag;
                            if (!flags.has(flag)) flags.set(flag, { setBy: [], requiredBy: [] });
                            flags.get(flag).requiredBy.push({ type: 'thread', path: [catIdx, threadIdx], title: thread.title });
                        }
                        
                        thread.posts.forEach((post, postIdx) => {
                            // Check post conditions
                            if (post.conditions?.requires_flag) {
                                const flag = post.conditions.requires_flag;
                                if (!flags.has(flag)) flags.set(flag, { setBy: [], requiredBy: [] });
                                flags.get(flag).requiredBy.push({ type: 'post', path: [catIdx, threadIdx, postIdx], title: `${post.user_name}: ${post.body.substring(0, 30)}...` });
                            }
                            
                            // Check options that set flags
                            if (post.options) {
                                post.options.forEach((opt, optIdx) => {
                                    const flag = opt.set_flag;
                                    if (!flags.has(flag)) flags.set(flag, { setBy: [], requiredBy: [] });
                                    flags.get(flag).setBy.push({ type: 'post', path: [catIdx, threadIdx, postIdx], title: `${post.user_name}: "${opt.text}"` });
                                });
                            }
                        });
                    });
                });
                return flags;
            };

            const getAllUsers = () => {
                const users = new Map(); // user_name -> { rank: Set, avatars: Set, postCount: number }
                data.forEach(cat => {
                    cat.threads.forEach(thread => {
                        thread.posts.forEach(post => {
                            if (!users.has(post.user_name)) {
                                users.set(post.user_name, { ranks: new Set(), avatars: new Set(), postCount: 0 });
                            }
                            const user = users.get(post.user_name);
                            user.ranks.add(post.user_rank);
                            user.avatars.add(post.avatar);
                            user.postCount++;
                        });
                    });
                });
                return users;
            };

            const runValidation = () => {
                const issues = [];
                const allIds = new Set();
                const setFlags = new Set();
                const requiredFlags = new Set();

                data.forEach((cat, catIdx) => {
                    if (allIds.has(cat.id)) {
                        issues.push({ type: 'error', category: 'Duplicate ID', message: `Category ID "${cat.id}" is used multiple times`, path: [catIdx] });
                    }
                    allIds.add(cat.id);

                    cat.threads.forEach((thread, threadIdx) => {
                        if (allIds.has(thread.id)) {
                            issues.push({ type: 'error', category: 'Duplicate ID', message: `Thread ID "${thread.id}" is used multiple times`, path: [catIdx, threadIdx] });
                        }
                        allIds.add(thread.id);

                        if (thread.conditions?.requires_flag) {
                            requiredFlags.add(thread.conditions.requires_flag);
                        }

                        if (thread.posts.length === 0) {
                            issues.push({ type: 'warning', category: 'Dead End', message: `Thread "${thread.title}" has no posts`, path: [catIdx, threadIdx] });
                        }

                        thread.posts.forEach((post, postIdx) => {
                            if (allIds.has(post.id)) {
                                issues.push({ type: 'error', category: 'Duplicate ID', message: `Post ID "${post.id}" is used multiple times`, path: [catIdx, threadIdx, postIdx] });
                            }
                            allIds.add(post.id);

                            if (!post.user_name) {
                                issues.push({ type: 'error', category: 'Missing Field', message: `Post missing user_name`, path: [catIdx, threadIdx, postIdx] });
                            }
                            if (!post.body) {
                                issues.push({ type: 'warning', category: 'Missing Field', message: `Post has empty body`, path: [catIdx, threadIdx, postIdx] });
                            }

                            if (post.conditions?.requires_flag) {
                                requiredFlags.add(post.conditions.requires_flag);
                            }

                            if (post.options) {
                                post.options.forEach((opt) => {
                                    setFlags.add(opt.set_flag);
                                    if (!opt.reply_body) {
                                        issues.push({ type: 'warning', category: 'Missing Field', message: `Option "${opt.text}" missing reply_body`, path: [catIdx, threadIdx, postIdx] });
                                    }

                                    let used = false;
                                    data.forEach(c => {
                                        c.threads.forEach(t => {
                                            if (t.conditions?.requires_flag === opt.set_flag) used = true;
                                            t.posts.forEach(p => {
                                                if (p.conditions?.requires_flag === opt.set_flag) used = true;
                                            });
                                        });
                                    });
                                    if (!used) {
                                        issues.push({ type: 'warning', category: 'Unreachable', message: `Option "${opt.text}" sets flag "${opt.set_flag}" but nothing requires it`, path: [catIdx, threadIdx, postIdx] });
                                    }
                                });
                            } else if (postIdx === thread.posts.length - 1 && post.type !== 'alert') {
                                issues.push({ type: 'info', category: 'Dead End', message: `Post by ${post.user_name} is last in thread with no options (conversation ends)`, path: [catIdx, threadIdx, postIdx] });
                            }

                            if (post.type === 'reply' && (!post.quote_user || !post.quote_text)) {
                                issues.push({ type: 'warning', category: 'Missing Field', message: `Reply post missing quote information`, path: [catIdx, threadIdx, postIdx] });
                            }
                        });
                    });
                });

                requiredFlags.forEach(flag => {
                    if (!setFlags.has(flag)) {
                        issues.push({ type: 'error', category: 'Missing Flag', message: `Flag "${flag}" is required but never set anywhere`, flag });
                    }
                });

                data.forEach((cat, catIdx) => {
                    cat.threads.forEach((thread, threadIdx) => {
                        if (thread.conditions?.requires_flag && !setFlags.has(thread.conditions.requires_flag)) {
                            issues.push({ type: 'error', category: 'Unreachable', message: `Thread "${thread.title}" requires flag "${thread.conditions.requires_flag}" which is never set`, path: [catIdx, threadIdx] });
                        }

                        thread.posts.forEach((post, postIdx) => {
                            if (post.conditions?.requires_flag && !setFlags.has(post.conditions.requires_flag)) {
                                issues.push({ type: 'error', category: 'Unreachable', message: `Post by ${post.user_name} requires flag "${post.conditions.requires_flag}" which is never set`, path: [catIdx, threadIdx, postIdx] });
                            }
                        });
                    });
                });

                // Conflict Detection - Check if same flag is set by multiple incompatible options
                const flagSetters = new Map(); // flag -> [{category, thread, post, option}]
                data.forEach((cat, catIdx) => {
                    cat.threads.forEach((thread, threadIdx) => {
                        thread.posts.forEach((post, postIdx) => {
                            post.options?.forEach(opt => {
                                if (opt.set_flag) {
                                    if (!flagSetters.has(opt.set_flag)) {
                                        flagSetters.set(opt.set_flag, []);
                                    }
                                    flagSetters.get(opt.set_flag).push({
                                        category: cat.title,
                                        thread: thread.title,
                                        post: post.user_name,
                                        option: opt.text,
                                        path: [catIdx, threadIdx, postIdx]
                                    });
                                }
                            });
                        });
                    });
                });

                // Warn if same flag is set by multiple different choices
                flagSetters.forEach((setters, flag) => {
                    if (setters.length > 1) {
                        // Check if they're mutually exclusive (different posts with different conditions)
                        const uniquePosts = new Set(setters.map(s => `${s.path[0]}-${s.path[1]}-${s.path[2]}`));
                        if (uniquePosts.size > 1) {
                            const locations = setters.map(s => `"${s.option}" in ${s.thread}`).join(', ');
                            issues.push({
                                type: 'warning',
                                category: 'Flag Conflict',
                                message: `Flag "${flag}" is set by multiple choices: ${locations}. Ensure these are mutually exclusive or intentional.`,
                                flag
                            });
                        }
                    }
                });

                // Circular Dependency Detection
                const buildDependencyGraph = () => {
                    const graph = new Map(); // postId -> [postIds it depends on]
                    const postLookup = new Map(); // postId -> {path, post}
                    
                    data.forEach((cat, catIdx) => {
                        cat.threads.forEach((thread, threadIdx) => {
                            thread.posts.forEach((post, postIdx) => {
                                postLookup.set(post.id, {
                                    path: [catIdx, threadIdx, postIdx],
                                    post,
                                    thread: thread.title
                                });
                                
                                if (post.conditions?.requires_flag) {
                                    const flag = post.conditions.requires_flag;
                                    const dependencies = [];
                                    
                                    // Find posts that set this flag
                                    data.forEach((c2, c2Idx) => {
                                        c2.threads.forEach((t2, t2Idx) => {
                                            t2.posts.forEach((p2, p2Idx) => {
                                                if (p2.options?.some(opt => opt.set_flag === flag)) {
                                                    dependencies.push(p2.id);
                                                }
                                            });
                                        });
                                    });
                                    
                                    if (dependencies.length > 0) {
                                        graph.set(post.id, dependencies);
                                    }
                                }
                            });
                        });
                    });
                    
                    return { graph, postLookup };
                };

                const { graph, postLookup } = buildDependencyGraph();

                // Detect cycles using DFS
                const detectCycle = (nodeId, visited, recStack, path) => {
                    if (recStack.has(nodeId)) {
                        // Found a cycle
                        const cycleStart = path.indexOf(nodeId);
                        const cycle = path.slice(cycleStart);
                        return cycle;
                    }
                    
                    if (visited.has(nodeId)) return null;
                    
                    visited.add(nodeId);
                    recStack.add(nodeId);
                    path.push(nodeId);
                    
                    const dependencies = graph.get(nodeId) || [];
                    for (const depId of dependencies) {
                        const cycle = detectCycle(depId, visited, recStack, [...path]);
                        if (cycle) return cycle;
                    }
                    
                    recStack.delete(nodeId);
                    return null;
                };

                const visited = new Set();
                graph.forEach((_, nodeId) => {
                    if (!visited.has(nodeId)) {
                        const cycle = detectCycle(nodeId, visited, new Set(), []);
                        if (cycle) {
                            const cycleDesc = cycle.map(id => {
                                const info = postLookup.get(id);
                                return info ? `"${info.post.user_name}" in ${info.thread}` : id;
                            }).join(' → ');
                            
                            issues.push({
                                type: 'error',
                                category: 'Circular Dependency',
                                message: `Circular dependency detected: ${cycleDesc} → (back to start). Posts depend on each other in a loop.`
                            });
                        }
                    }
                });

                return issues;
            };

            const toggleExpand = (id) => {
                const newExpanded = new Set(expandedItems);
                if (newExpanded.has(id)) {
                    newExpanded.delete(id);
                } else {
                    newExpanded.add(id);
                }
                setExpandedItems(newExpanded);
            };

            const searchAndReplace = (searchText, replaceText, scope = 'all') => {
                if (!searchText) return 0;
                
                const newData = JSON.parse(JSON.stringify(data));
                let replacements = 0;
                
                newData.forEach(cat => {
                    if (scope === 'all' || scope === 'categories') {
                        if (cat.title.includes(searchText)) {
                            cat.title = cat.title.replaceAll(searchText, replaceText);
                            replacements++;
                        }
                        if (cat.subtitle && cat.subtitle.includes(searchText)) {
                            cat.subtitle = cat.subtitle.replaceAll(searchText, replaceText);
                            replacements++;
                        }
                    }
                    
                    cat.threads.forEach(thread => {
                        if (scope === 'all' || scope === 'threads') {
                            if (thread.title.includes(searchText)) {
                                thread.title = thread.title.replaceAll(searchText, replaceText);
                                replacements++;
                            }
                            if (thread.subtitle && thread.subtitle.includes(searchText)) {
                                thread.subtitle = thread.subtitle.replaceAll(searchText, replaceText);
                                replacements++;
                            }
                        }
                        
                        if (scope === 'all' || scope === 'posts') {
                            thread.posts.forEach(post => {
                                if (post.body && post.body.includes(searchText)) {
                                    post.body = post.body.replaceAll(searchText, replaceText);
                                    replacements++;
                                }
                                if (post.user_name && post.user_name.includes(searchText)) {
                                    post.user_name = post.user_name.replaceAll(searchText, replaceText);
                                    replacements++;
                                }
                                if (post.options) {
                                    post.options.forEach(opt => {
                                        if (opt.text && opt.text.includes(searchText)) {
                                            opt.text = opt.text.replaceAll(searchText, replaceText);
                                            replacements++;
                                        }
                                        if (opt.reply_body && opt.reply_body.includes(searchText)) {
                                            opt.reply_body = opt.reply_body.replaceAll(searchText, replaceText);
                                            replacements++;
                                        }
                                    });
                                }
                            });
                        }
                    });
                });
                
                setData(newData);
                return replacements;
            };

            const bulkEdit = (nodePaths, updates) => {
                const newData = JSON.parse(JSON.stringify(data));
                
                nodePaths.forEach(path => {
                    const [catIdx, threadIdx, postIdx] = path;
                    let target;
                    
                    if (postIdx !== undefined) {
                        target = newData[catIdx].threads[threadIdx].posts[postIdx];
                    } else if (threadIdx !== undefined) {
                        target = newData[catIdx].threads[threadIdx];
                    } else {
                        target = newData[catIdx];
                    }
                    
                    Object.keys(updates).forEach(key => {
                        if (updates[key] !== undefined) {
                            target[key] = updates[key];
                        }
                    });
                });
                
                setData(newData);
                showMessage(`Updated ${nodePaths.length} item(s)`, 'success');
            };

            const addCategory = () => {
                const existingIds = getAllIds();
                const newCat = {
                    id: generateId('category', 'New Category', existingIds),
                    title: "New Category",
                    subtitle: "Description",
                    icon: "spr_icon_default",
                    threads: []
                };
                setData([...data, newCat]);
                setSelectedItem({ type: 'category', path: [data.length] });
                showMessage('Category added', 'success');
            };

            const addThread = (catIndex) => {
                const existingIds = getAllIds();
                const newThread = {
                    id: generateId('thread', 'New Thread', existingIds),
                    title: "New Thread",
                    subtitle: "Author • Status",
                    icon: "spr_icon_default",
                    pinned: false,
                    posts: [],
                    conditions: currentDay > 0 ? { min_day: currentDay } : {}
                };
                const newData = [...data];
                newData[catIndex].threads.push(newThread);
                setData(newData);
                setSelectedItem({ type: 'thread', path: [catIndex, newData[catIndex].threads.length - 1] });
                showMessage('Thread added', 'success');
            };

            const addPost = (catIndex, threadIndex) => {
                const existingIds = getAllIds();
                const newPost = {
                    id: generateId('post', 'New post content', existingIds),
                    type: "original",
                    timestamp: nextTimestamp,
                    user_name: "User",
                    user_rank: "Member",
                    avatar: "spr_avatar_default",
                    body: "New post content",
                    conditions: currentDay > 0 ? { min_day: currentDay } : {}
                };
                const newData = [...data];
                newData[catIndex].threads[threadIndex].posts.push(newPost);
                setData(newData);
                setNextTimestamp(nextTimestamp + 1);
                setSelectedItem({ type: 'post', path: [catIndex, threadIndex, newData[catIndex].threads[threadIndex].posts.length - 1] });
                showMessage('Post added', 'success');
            };

            const createReplyPosts = (catIndex, threadIndex, postIndex) => {
                const newData = [...data];
                const post = newData[catIndex].threads[threadIndex].posts[postIndex];
                
                if (!post.options || post.options.length === 0) {
                    showMessage('No reply options to create posts from', 'error');
                    return;
                }

                const existingIds = getAllIds();
                let timestamp = nextTimestamp;
                
                post.options.forEach((option, idx) => {
                    const replyPost = {
                        id: generateId('post', `${post.body} reply ${option.text}`, existingIds),
                        type: "reply",
                        timestamp: timestamp,
                        user_name: "Player",
                        user_rank: "Player",
                        avatar: "spr_avatar_player",
                        body: option.reply_body || option.text,
                        quote_user: post.user_name,
                        quote_text: post.body,
                        conditions: {
                            requires_flag: option.set_flag,
                            ...(currentDay > 0 ? { min_day: currentDay } : {})
                        }
                    };
                    
                    existingIds.add(replyPost.id);
                    newData[catIndex].threads[threadIndex].posts.push(replyPost);
                    timestamp++;
                });

                setData(newData);
                setNextTimestamp(timestamp);
                showMessage(`Created ${post.options.length} reply post(s)`, 'success');
            };

            const deleteItem = () => {
                if (!selectedItem) return;
                
                const newData = [...data];
                const [catIndex, threadIndex, postIndex] = selectedItem.path;

                if (selectedItem.type === 'category') {
                    newData.splice(catIndex, 1);
                } else if (selectedItem.type === 'thread') {
                    newData[catIndex].threads.splice(threadIndex, 1);
                } else if (selectedItem.type === 'post') {
                    newData[catIndex].threads[threadIndex].posts.splice(postIndex, 1);
                }

                setData(newData);
                setSelectedItem(null);
                showMessage('Item deleted', 'success');
            };

            const updateItem = (updates) => {
                if (!selectedItem) return;

                const newData = JSON.parse(JSON.stringify(data));
                const [catIndex, threadIndex, postIndex] = selectedItem.path;

                if (selectedItem.type === 'category') {
                    Object.assign(newData[catIndex], updates);
                } else if (selectedItem.type === 'thread') {
                    Object.assign(newData[catIndex].threads[threadIndex], updates);
                } else if (selectedItem.type === 'post') {
                    Object.assign(newData[catIndex].threads[threadIndex].posts[postIndex], updates);
                }

                setData(newData);
            };

            const showMessage = (text, type) => {
                setMessage({ text, type });
                setTimeout(() => setMessage(null), 3000);
            };

            const exportJSON = () => {
                const jsonStr = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'forum-data.json';
                a.click();
                showMessage('JSON exported', 'success');
            };

            const importJSON = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const imported = JSON.parse(e.target.result);
                            setData(imported);
                            setSelectedItem(null);
                            showMessage('JSON imported successfully', 'success');
                        } catch (error) {
                            showMessage('Invalid JSON file: ' + error.message, 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            };

            return (
                <div className="app-container">
                    <Toolbar 
                        onAddCategory={addCategory}
                        onAddThread={() => selectedItem?.type === 'category' && addThread(selectedItem.path[0])}
                        onAddPost={() => selectedItem?.type === 'thread' && addPost(selectedItem.path[0], selectedItem.path[1])}
                        onDelete={deleteItem}
                        onExport={exportJSON}
                        onImport={importJSON}
                        view={view}
                        setView={setView}
                        selectedItem={selectedItem}
                        currentDay={currentDay}
                        setCurrentDay={setCurrentDay}
                        nextTimestamp={nextTimestamp}
                        onShowUtilities={() => setView('utilities')}
                        onUndo={undo}
                        onRedo={redo}
                        canUndo={historyIndex > 0}
                        canRedo={historyIndex < history.length - 1}
                    />
                    {message && (
                        <div className={message.type === 'error' ? 'error-message' : 'success-message'}>
                            {message.text}
                        </div>
                    )}
                    <div className="main-content">
                        {view === 'tree' && (
                            <>
                                <TreePanel 
                                    data={data}
                                    selectedItem={selectedItem}
                                    setSelectedItem={setSelectedItem}
                                    expandedItems={expandedItems}
                                    toggleExpand={toggleExpand}
                                    onNodeDoubleClick={setDetailModalItem}
                                />
                                <EditorPanel 
                                    data={data}
                                    selectedItem={selectedItem}
                                    updateItem={updateItem}
                                    createReplyPosts={createReplyPosts}
                                    notes={notes}
                                    setNotes={setNotes}
                                    itemTags={itemTags}
                                    setItemTags={setItemTags}
                                    userLibrary={userLibrary}
                                />
                            </>
                        )}
                        {view === 'graph' && (
                            <GraphPanel 
                                data={data} 
                                setSelectedItem={setSelectedItem} 
                                onNodeDoubleClick={setDetailModalItem} 
                                runValidation={runValidation} 
                                notes={notes} 
                                itemTags={itemTags}
                                onAddCategory={addCategory}
                                onAddThread={addThread}
                                onAddPost={addPost}
                            />
                        )}
                        {view === 'screenplay' && (
                            <ScreenplayPanel data={data} setData={setData} setSelectedItem={setSelectedItem} userLibrary={userLibrary} showMessage={showMessage} />
                        )}
                        {view === 'json' && (
                            <JSONPanel data={data} setData={setData} showMessage={showMessage} />
                        )}
                        {view === 'utilities' && (
                            <UtilitiesPanel 
                                data={data} 
                                getAllFlags={getAllFlags} 
                                getAllUsers={getAllUsers} 
                                setSelectedItem={setSelectedItem} 
                                setView={setView} 
                                runValidation={runValidation} 
                                searchAndReplace={searchAndReplace} 
                                bulkEdit={bulkEdit} 
                                notes={notes} 
                                setNotes={setNotes} 
                                itemTags={itemTags} 
                                setItemTags={setItemTags}
                                userLibrary={userLibrary}
                                setUserLibrary={setUserLibrary}
                                snapshots={snapshots}
                                onCreateSnapshot={createSnapshot}
                                onRestoreSnapshot={restoreSnapshot}
                                onDeleteSnapshot={deleteSnapshot}
                            />
                        )}
                        {view === 'preview' && (
                            <div style={{flex: 1, display: 'flex', overflow: 'hidden'}}>
                                <ForumPreviewPanel data={data} simulatedDay={simulatedDay} setSimulatedDay={setSimulatedDay} simulatedFlags={simulatedFlags} setSimulatedFlags={setSimulatedFlags} />
                            </div>
                        )}
                    </div>
                    {detailModalItem && (
                        <DetailModal 
                            item={detailModalItem} 
                            onClose={() => setDetailModalItem(null)} 
                            data={data} 
                            updateItem={(updates) => {
                                updateItem(updates);
                                setDetailModalItem(null);
                            }}
                            notes={notes}
                            itemTags={itemTags}
                            runValidation={runValidation}
                        />
                    )}
                </div>
            );
        }

        function Toolbar({ onAddCategory, onAddThread, onAddPost, onDelete, onExport, onImport, view, setView, selectedItem, currentDay, setCurrentDay, nextTimestamp, onShowUtilities, onUndo, onRedo, canUndo, canRedo }) {
            const fileInputRef = React.useRef(null);
            const projectFileInputRef = React.useRef(null);
            
            return (
                <div className="toolbar">
                    <button onClick={onAddCategory}>+ Category</button>
                    <button onClick={onAddThread} disabled={!selectedItem || selectedItem.type !== 'category'}>
                        + Thread
                    </button>
                    <button onClick={onAddPost} disabled={!selectedItem || selectedItem.type !== 'thread'}>
                        + Post
                    </button>
                    <button onClick={onDelete} className="secondary" disabled={!selectedItem}>
                        Delete Selected
                    </button>
                    
                    <div style={{borderLeft: '1px solid #3e3e42', height: '30px', margin: '0 8px'}}></div>
                    
                    <button 
                        onClick={onUndo} 
                        className="secondary" 
                        disabled={!canUndo}
                        title="Undo (Ctrl+Z)"
                    >
                        ↶ Undo
                    </button>
                    <button 
                        onClick={onRedo} 
                        className="secondary" 
                        disabled={!canRedo}
                        title="Redo (Ctrl+Y)"
                    >
                        ↷ Redo
                    </button>
                    
                    <div style={{borderLeft: '1px solid #3e3e42', height: '30px', margin: '0 8px'}}></div>
                    
                    <button onClick={onExport} className="secondary">Export JSON</button>
                    <button className="secondary" onClick={() => fileInputRef.current?.click()}>
                        Import JSON
                    </button>
                    
                    <div style={{borderLeft: '1px solid #3e3e42', height: '30px', margin: '0 8px'}}></div>
                    
                    <button className="secondary" onClick={() => {
                        try {
                            // Gather all project data
                            const projectData = {
                                version: '1.0',
                                timestamp: new Date().toISOString(),
                                data: window.narrativeData, // The JSON data
                                notes: JSON.parse(localStorage.getItem('narrative-editor-notes') || '{}'),
                                tags: JSON.parse(localStorage.getItem('narrative-editor-tags') || '{}'),
                                assets: JSON.parse(localStorage.getItem('narrative-editor-assets') || '{}')
                            };
                            
                            const blob = new Blob([JSON.stringify(projectData, null, 2)], { type: 'application/json' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `narrative-project-${new Date().toISOString().split('T')[0]}.neproj`;
                            a.click();
                            URL.revokeObjectURL(url);
                        } catch (e) {
                            alert('Failed to save project: ' + e.message);
                        }
                    }} title="Save complete project (JSON + notes + tags + assets)">
                        💾 Save Project
                    </button>
                    
                    <button className="secondary" onClick={() => projectFileInputRef.current?.click()} title="Load complete project file">
                        📂 Load Project
                    </button>
                    
                    <button className="secondary" onClick={() => {
                        try {
                            const saved = localStorage.getItem('narrative-editor-data-autosave');
                            const time = localStorage.getItem('narrative-editor-data-autosave-time');
                            if (saved) {
                                if (confirm(`Load auto-saved data from ${time ? new Date(time).toLocaleString() : 'unknown time'}?`)) {
                                    window.location.reload();
                                }
                            } else {
                                alert('No auto-saved data found');
                            }
                        } catch (e) {
                            alert('Failed to load auto-save: ' + e.message);
                        }
                    }} title="Load auto-saved data from browser storage">
                        ⏮️ Load Auto-save
                    </button>
                    
                    <input 
                        ref={fileInputRef}
                        type="file" 
                        accept=".json" 
                        onChange={onImport} 
                        style={{display: 'none'}} 
                    />
                    <input 
                        ref={projectFileInputRef}
                        type="file" 
                        accept=".neproj,.json" 
                        onChange={(e) => {
                            const file = e.target.files[0];
                            if (file) {
                                const reader = new FileReader();
                                reader.onload = (event) => {
                                    try {
                                        const projectData = JSON.parse(event.target.result);
                                        
                                        // Check if it's a project file or just JSON
                                        if (projectData.version && projectData.data) {
                                            // It's a project file - restore everything
                                            if (confirm('This will replace all current data, notes, tags, and assets. Continue?')) {
                                                // Save data
                                                localStorage.setItem('narrative-editor-data-autosave', JSON.stringify(projectData.data));
                                                
                                                // Save notes
                                                if (projectData.notes) {
                                                    localStorage.setItem('narrative-editor-notes', JSON.stringify(projectData.notes));
                                                }
                                                
                                                // Save tags
                                                if (projectData.tags) {
                                                    localStorage.setItem('narrative-editor-tags', JSON.stringify(projectData.tags));
                                                }
                                                
                                                // Save assets
                                                if (projectData.assets) {
                                                    localStorage.setItem('narrative-editor-assets', JSON.stringify(projectData.assets));
                                                }
                                                
                                                alert('Project loaded successfully! Refreshing...');
                                                window.location.reload();
                                            }
                                        } else {
                                            // It's just JSON data - treat as regular import
                                            onImport(e);
                                        }
                                    } catch (error) {
                                        alert('Failed to load project: ' + error.message);
                                    }
                                };
                                reader.readAsText(file);
                            }
                        }} 
                        style={{display: 'none'}} 
                    />
                    
                    <div style={{marginLeft: '20px', display: 'flex', alignItems: 'center', gap: '8px'}}>
                        <label style={{fontSize: '14px', color: '#9cdcfe'}}>Current Day:</label>
                        <input 
                            type="number" 
                            value={currentDay} 
                            onChange={(e) => setCurrentDay(parseInt(e.target.value) || 0)}
                            style={{width: '80px', background: '#3c3c3c', border: '1px solid #3e3e42', color: '#d4d4d4', padding: '6px', borderRadius: '4px'}}
                        />
                        <label style={{fontSize: '12px', color: '#858585', marginLeft: '12px'}}>Next TS: {nextTimestamp}</label>
                    </div>

                    <button onClick={onShowUtilities} className="secondary" style={{marginLeft: '12px'}}>
                        📊 Utilities
                    </button>
                    
                    <div className="view-toggle">
                        <button onClick={() => setView('tree')} className={view === 'tree' ? '' : 'secondary'}>
                            Tree View
                        </button>
                        <button onClick={() => setView('graph')} className={view === 'graph' ? '' : 'secondary'}>
                            Graph View
                        </button>
                        <button onClick={() => setView('screenplay')} className={view === 'screenplay' ? '' : 'secondary'}>
                            📖 Screenplay
                        </button>
                        <button onClick={() => setView('preview')} className={view === 'preview' ? '' : 'secondary'}>
                            👁️ Preview
                        </button>
                        <button onClick={() => setView('json')} className={view === 'json' ? '' : 'secondary'}>
                            JSON View
                        </button>
                    </div>
                </div>
            );
        }

        function EditorPanel({ data, selectedItem, updateItem, createReplyPosts, notes, setNotes, itemTags, setItemTags, userLibrary }) {
            if (!selectedItem) {
                return (
                    <div className="editor-panel">
                        <div className="empty-state">
                            <h2>No Item Selected</h2>
                            <p>Select a category, thread, or post from the tree to edit it</p>
                        </div>
                    </div>
                );
            }

            const [catIndex, threadIndex, postIndex] = selectedItem.path;
            let item;

            if (selectedItem.type === 'category') {
                item = data[catIndex];
                return <CategoryEditor item={item} updateItem={updateItem} notes={notes} setNotes={setNotes} itemTags={itemTags} setItemTags={setItemTags} />;
            } else if (selectedItem.type === 'thread') {
                item = data[catIndex].threads[threadIndex];
                return <ThreadEditor item={item} updateItem={updateItem} notes={notes} setNotes={setNotes} itemTags={itemTags} setItemTags={setItemTags} />;
            } else if (selectedItem.type === 'post') {
                item = data[catIndex].threads[threadIndex].posts[postIndex];
                return <PostEditor 
                    item={item} 
                    updateItem={updateItem} 
                    data={data}
                    catIndex={catIndex}
                    threadIndex={threadIndex}
                    postIndex={postIndex}
                    createReplyPosts={createReplyPosts}
                    notes={notes}
                    setNotes={setNotes}
                    itemTags={itemTags}
                    setItemTags={setItemTags}
                    userLibrary={userLibrary}
                />;
            }
        }

        function TreePanel({ data, selectedItem, setSelectedItem, expandedItems, toggleExpand, onNodeDoubleClick }) {
            const [groupByChapter, setGroupByChapter] = React.useState(false);

            return (
                <div className="tree-panel">
                    {/* Group by Chapter Toggle */}
                    <div style={{
                        padding: '8px 12px',
                        marginBottom: '12px',
                        background: '#2d2d30',
                        borderRadius: '4px',
                        border: '1px solid #3e3e42'
                    }}>
                        <label style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: '8px',
                            cursor: 'pointer',
                            fontSize: '13px',
                            color: '#d4d4d4'
                        }}>
                            <input
                                type="checkbox"
                                checked={groupByChapter}
                                onChange={(e) => setGroupByChapter(e.target.checked)}
                                style={{cursor: 'pointer'}}
                            />
                            <span>📚 Group by Chapter</span>
                        </label>
                    </div>

                    {data.map((category, catIndex) => (
                        <div key={category.id}>
                            <div 
                                className={`tree-item category ${selectedItem?.type === 'category' && selectedItem?.path[0] === catIndex ? 'selected' : ''}`}
                                onClick={() => setSelectedItem({ type: 'category', path: [catIndex] })}
                                onDoubleClick={() => onNodeDoubleClick && onNodeDoubleClick({ type: 'category', path: [catIndex] })}
                            >
                                <span className="tree-expand" onClick={(e) => { e.stopPropagation(); toggleExpand(category.id); }}>
                                    {expandedItems.has(category.id) ? '▼' : '▶'}
                                </span>
                                {category.title}
                            </div>
                            {expandedItems.has(category.id) && (() => {
                                if (!groupByChapter) {
                                    // Normal view - show all threads
                                    return category.threads.map((thread, threadIndex) => (
                                        <div key={thread.id}>
                                            <div 
                                                className={`tree-item thread ${selectedItem?.type === 'thread' && selectedItem?.path[0] === catIndex && selectedItem?.path[1] === threadIndex ? 'selected' : ''}`}
                                                onClick={() => setSelectedItem({ type: 'thread', path: [catIndex, threadIndex] })}
                                                onDoubleClick={() => onNodeDoubleClick && onNodeDoubleClick({ type: 'thread', path: [catIndex, threadIndex] })}
                                            >
                                                <span className="tree-expand" onClick={(e) => { e.stopPropagation(); toggleExpand(thread.id); }}>
                                                    {expandedItems.has(thread.id) ? '▼' : '▶'}
                                                </span>
                                                {thread.title} {thread.pinned && '📌'}
                                            </div>
                                            {expandedItems.has(thread.id) && thread.posts.map((post, postIndex) => (
                                                <div 
                                                    key={post.id}
                                                    className={`tree-item post ${selectedItem?.type === 'post' && selectedItem?.path[0] === catIndex && selectedItem?.path[1] === threadIndex && selectedItem?.path[2] === postIndex ? 'selected' : ''}`}
                                                    onClick={() => setSelectedItem({ type: 'post', path: [catIndex, threadIndex, postIndex] })}
                                                    onDoubleClick={() => onNodeDoubleClick && onNodeDoubleClick({ type: 'post', path: [catIndex, threadIndex, postIndex] })}
                                                >
                                                    {post.user_name}: {post.body.substring(0, 30)}...
                                                </div>
                                            ))}
                                        </div>
                                    ));
                                } else {
                                    // Grouped view - organize by chapter
                                    const grouped = {};
                                    const noChapter = [];
                                    
                                    category.threads.forEach((thread, threadIndex) => {
                                        if (thread.chapter) {
                                            if (!grouped[thread.chapter]) {
                                                grouped[thread.chapter] = [];
                                            }
                                            grouped[thread.chapter].push({ thread, threadIndex });
                                        } else {
                                            noChapter.push({ thread, threadIndex });
                                        }
                                    });

                                    const chapters = Object.keys(grouped).sort();

                                    return (
                                        <>
                                            {chapters.map(chapterName => (
                                                <div key={`chapter-${chapterName}`}>
                                                    <div 
                                                        style={{
                                                            padding: '6px 12px 6px 32px',
                                                            fontSize: '12px',
                                                            fontWeight: 'bold',
                                                            color: '#4ec9b0',
                                                            marginTop: '8px',
                                                            marginBottom: '4px',
                                                            cursor: 'pointer',
                                                            borderRadius: '4px',
                                                            background: expandedItems.has(`chapter-${chapterName}`) ? '#2d3d2d' : 'transparent'
                                                        }}
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            toggleExpand(`chapter-${chapterName}`);
                                                        }}
                                                    >
                                                        <span style={{marginRight: '6px'}}>
                                                            {expandedItems.has(`chapter-${chapterName}`) ? '▼' : '▶'}
                                                        </span>
                                                        📚 {chapterName} ({grouped[chapterName].length})
                                                    </div>
                                                    {expandedItems.has(`chapter-${chapterName}`) && grouped[chapterName].map(({thread, threadIndex}) => (
                                                        <div key={thread.id}>
                                                            <div 
                                                                className={`tree-item thread ${selectedItem?.type === 'thread' && selectedItem?.path[0] === catIndex && selectedItem?.path[1] === threadIndex ? 'selected' : ''}`}
                                                                style={{paddingLeft: '52px'}}
                                                                onClick={() => setSelectedItem({ type: 'thread', path: [catIndex, threadIndex] })}
                                                                onDoubleClick={() => onNodeDoubleClick && onNodeDoubleClick({ type: 'thread', path: [catIndex, threadIndex] })}
                                                            >
                                                                <span className="tree-expand" onClick={(e) => { e.stopPropagation(); toggleExpand(thread.id); }}>
                                                                    {expandedItems.has(thread.id) ? '▼' : '▶'}
                                                                </span>
                                                                {thread.title} {thread.pinned && '📌'}
                                                            </div>
                                                            {expandedItems.has(thread.id) && thread.posts.map((post, postIndex) => (
                                                                <div 
                                                                    key={post.id}
                                                                    className={`tree-item post ${selectedItem?.type === 'post' && selectedItem?.path[0] === catIndex && selectedItem?.path[1] === threadIndex && selectedItem?.path[2] === postIndex ? 'selected' : ''}`}
                                                                    style={{paddingLeft: '72px'}}
                                                                    onClick={() => setSelectedItem({ type: 'post', path: [catIndex, threadIndex, postIndex] })}
                                                                    onDoubleClick={() => onNodeDoubleClick && onNodeDoubleClick({ type: 'post', path: [catIndex, threadIndex, postIndex] })}
                                                                >
                                                                    {post.user_name}: {post.body.substring(0, 30)}...
                                                                </div>
                                                            ))}
                                                        </div>
                                                    ))}
                                                </div>
                                            ))}
                                            {noChapter.length > 0 && (
                                                <div key="no-chapter">
                                                    <div 
                                                        style={{
                                                            padding: '6px 12px 6px 32px',
                                                            fontSize: '12px',
                                                            fontWeight: 'bold',
                                                            color: '#858585',
                                                            marginTop: '8px',
                                                            marginBottom: '4px',
                                                            cursor: 'pointer',
                                                            borderRadius: '4px',
                                                            background: expandedItems.has('no-chapter') ? '#2d2d2d' : 'transparent'
                                                        }}
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            toggleExpand('no-chapter');
                                                        }}
                                                    >
                                                        <span style={{marginRight: '6px'}}>
                                                            {expandedItems.has('no-chapter') ? '▼' : '▶'}
                                                        </span>
                                                        📝 Ungrouped ({noChapter.length})
                                                    </div>
                                                    {expandedItems.has('no-chapter') && noChapter.map(({thread, threadIndex}) => (
                                                        <div key={thread.id}>
                                                            <div 
                                                                className={`tree-item thread ${selectedItem?.type === 'thread' && selectedItem?.path[0] === catIndex && selectedItem?.path[1] === threadIndex ? 'selected' : ''}`}
                                                                style={{paddingLeft: '52px'}}
                                                                onClick={() => setSelectedItem({ type: 'thread', path: [catIndex, threadIndex] })}
                                                                onDoubleClick={() => onNodeDoubleClick && onNodeDoubleClick({ type: 'thread', path: [catIndex, threadIndex] })}
                                                            >
                                                                <span className="tree-expand" onClick={(e) => { e.stopPropagation(); toggleExpand(thread.id); }}>
                                                                    {expandedItems.has(thread.id) ? '▼' : '▶'}
                                                                </span>
                                                                {thread.title} {thread.pinned && '📌'}
                                                            </div>
                                                            {expandedItems.has(thread.id) && thread.posts.map((post, postIndex) => (
                                                                <div 
                                                                    key={post.id}
                                                                    className={`tree-item post ${selectedItem?.type === 'post' && selectedItem?.path[0] === catIndex && selectedItem?.path[1] === threadIndex && selectedItem?.path[2] === postIndex ? 'selected' : ''}`}
                                                                    style={{paddingLeft: '72px'}}
                                                                    onClick={() => setSelectedItem({ type: 'post', path: [catIndex, threadIndex, postIndex] })}
                                                                    onDoubleClick={() => onNodeDoubleClick && onNodeDoubleClick({ type: 'post', path: [catIndex, threadIndex, postIndex] })}
                                                                >
                                                                    {post.user_name}: {post.body.substring(0, 30)}...
                                                                </div>
                                                            ))}
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </>
                                    );
                                }
                            })()}
                        </div>
                    ))}
                </div>
            );
        }

        function CategoryEditor({ item, updateItem, notes, setNotes, itemTags, setItemTags }) {
            return (
                <div className="editor-panel">
                    <h2 style={{marginBottom: '24px', color: '#4ec9b0'}}>Edit Category</h2>
                    <div className="form-group">
                        <label>ID</label>
                        <input type="text" value={item.id} onChange={(e) => updateItem({ id: e.target.value })} />
                    </div>
                    <div className="form-group">
                        <label>Title</label>
                        <input type="text" value={item.title} onChange={(e) => updateItem({ title: e.target.value })} />
                    </div>
                    <div className="form-group">
                        <label>Subtitle</label>
                        <input type="text" value={item.subtitle} onChange={(e) => updateItem({ subtitle: e.target.value })} />
                    </div>
                    <div className="form-group">
                        <label>Icon</label>
                        <input type="text" value={item.icon} onChange={(e) => updateItem({ icon: e.target.value })} />
                    </div>

                    <div className="form-section" style={{marginTop: '24px', background: '#2d2d30', borderLeft: '3px solid #dcdcaa'}}>
                        <h3 style={{marginBottom: '12px', color: '#dcdcaa', fontSize: '14px'}}>🏷️ Tags (Not Exported)</h3>
                        <div style={{display: 'flex', flexWrap: 'wrap', gap: '6px', marginBottom: '12px'}}>
                            {(itemTags[item.id] || []).map((tag, idx) => (
                                <div key={idx} style={{
                                    padding: '4px 10px',
                                    background: '#dcdcaa',
                                    color: '#1e1e1e',
                                    borderRadius: '12px',
                                    fontSize: '12px',
                                    fontWeight: '500',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '6px'
                                }}>
                                    {tag}
                                    <button
                                        onClick={() => {
                                            const newTags = [...(itemTags[item.id] || [])];
                                            newTags.splice(idx, 1);
                                            setItemTags({...itemTags, [item.id]: newTags});
                                        }}
                                        style={{
                                            background: 'transparent',
                                            border: 'none',
                                            color: '#1e1e1e',
                                            cursor: 'pointer',
                                            fontSize: '16px',
                                            lineHeight: 1,
                                            padding: 0
                                        }}
                                    >
                                        ×
                                    </button>
                                </div>
                            ))}
                        </div>
                        <div style={{display: 'flex', gap: '8px'}}>
                            <input
                                type="text"
                                placeholder="Add tag..."
                                onKeyDown={(e) => {
                                    if (e.key === 'Enter' && e.target.value.trim()) {
                                        const newTag = e.target.value.trim();
                                        const currentTags = itemTags[item.id] || [];
                                        if (!currentTags.includes(newTag)) {
                                            setItemTags({...itemTags, [item.id]: [...currentTags, newTag]});
                                        }
                                        e.target.value = '';
                                    }
                                }}
                                style={{
                                    flex: 1,
                                    padding: '8px',
                                    background: '#1e1e1e',
                                    border: '1px solid #3e3e42',
                                    borderRadius: '4px',
                                    color: '#d4d4d4',
                                    fontSize: '13px'
                                }}
                            />
                        </div>
                        <div style={{fontSize: '11px', color: '#858585', marginTop: '6px'}}>
                            💡 Press Enter to add tags. Use tags to organize and filter content.
                        </div>
                    </div>

                    <div className="form-section" style={{marginTop: '24px', background: '#2d2d30', borderLeft: '3px solid #569cd6'}}>
                        <h3 style={{marginBottom: '12px', color: '#569cd6', fontSize: '14px'}}>📝 Internal Notes (Not Exported)</h3>
                        <textarea
                            value={notes[item.id] || ''}
                            onChange={(e) => setNotes({...notes, [item.id]: e.target.value})}
                            placeholder="Add notes, reminders, or comments about this category..."
                            style={{
                                width: '100%',
                                minHeight: '80px',
                                padding: '10px',
                                background: '#1e1e1e',
                                border: '1px solid #3e3e42',
                                borderRadius: '4px',
                                color: '#d4d4d4',
                                fontSize: '13px',
                                fontFamily: 'inherit',
                                resize: 'vertical'
                            }}
                        />
                        <div style={{fontSize: '11px', color: '#858585', marginTop: '6px'}}>
                            💡 Notes are saved in your browser and won't be included in JSON exports
                        </div>
                    </div>
                </div>
            );
        }

        function ThreadEditor({ item, updateItem, notes, setNotes, itemTags, setItemTags }) {
            const handleConditionChange = (field, value) => {
                const newConditions = { ...(item.conditions || {}) };
                if (value === '' || value === null) {
                    delete newConditions[field];
                } else {
                    newConditions[field] = value;
                }
                updateItem({ conditions: Object.keys(newConditions).length > 0 ? newConditions : undefined });
            };

            return (
                <div className="editor-panel">
                    <h2 style={{marginBottom: '24px', color: '#dcdcaa'}}>Edit Thread</h2>
                    <div className="form-group">
                        <label>ID</label>
                        <input type="text" value={item.id} onChange={(e) => updateItem({ id: e.target.value })} />
                    </div>
                    <div className="form-group">
                        <label>Title</label>
                        <input type="text" value={item.title} onChange={(e) => updateItem({ title: e.target.value })} />
                    </div>
                    <div className="form-group">
                        <label>Subtitle</label>
                        <input type="text" value={item.subtitle} onChange={(e) => updateItem({ subtitle: e.target.value })} />
                    </div>
                    <div className="form-group">
                        <label>Icon</label>
                        <input type="text" value={item.icon} onChange={(e) => updateItem({ icon: e.target.value })} />
                    </div>
                    <div className="form-group">
                        <label>Chapter/Group (Optional)</label>
                        <input 
                            type="text" 
                            value={item.chapter || ''} 
                            onChange={(e) => updateItem({ chapter: e.target.value || undefined })}
                            placeholder="e.g., Chapter 1, Act 2, Tutorial" 
                        />
                        <small style={{color: '#858585', fontSize: '12px', marginTop: '4px', display: 'block'}}>
                            Organize threads into chapters or story arcs
                        </small>
                    </div>
                    <div className="form-group">
                        <label className="checkbox-group">
                            <input 
                                type="checkbox" 
                                checked={item.pinned || false} 
                                onChange={(e) => updateItem({ pinned: e.target.checked })} 
                            />
                            Pinned
                        </label>
                    </div>

                    <div className="form-section">
                        <div className="form-section-title">Conditions (Optional)</div>
                        <div className="form-group">
                            <label>Minimum Day</label>
                            <input 
                                type="number" 
                                value={item.conditions?.min_day || ''} 
                                onChange={(e) => handleConditionChange('min_day', e.target.value ? parseInt(e.target.value) : null)}
                                placeholder="Leave empty for no restriction"
                            />
                        </div>
                        <div className="form-group">
                            <label>Required Flag</label>
                            <input 
                                type="text" 
                                value={item.conditions?.requires_flag || ''} 
                                onChange={(e) => handleConditionChange('requires_flag', e.target.value || null)}
                                placeholder="e.g. FLAG_QUEST_COMPLETE"
                            />
                        </div>
                    </div>

                    <div className="form-section" style={{marginTop: '24px', background: '#2d2d30', borderLeft: '3px solid #dcdcaa'}}>
                        <h3 style={{marginBottom: '12px', color: '#dcdcaa', fontSize: '14px'}}>🏷️ Tags (Not Exported)</h3>
                        <div style={{display: 'flex', flexWrap: 'wrap', gap: '6px', marginBottom: '12px'}}>
                            {(itemTags[item.id] || []).map((tag, idx) => (
                                <div key={idx} style={{
                                    padding: '4px 10px',
                                    background: '#dcdcaa',
                                    color: '#1e1e1e',
                                    borderRadius: '12px',
                                    fontSize: '12px',
                                    fontWeight: '500',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '6px'
                                }}>
                                    {tag}
                                    <button
                                        onClick={() => {
                                            const newTags = [...(itemTags[item.id] || [])];
                                            newTags.splice(idx, 1);
                                            setItemTags({...itemTags, [item.id]: newTags});
                                        }}
                                        style={{
                                            background: 'transparent',
                                            border: 'none',
                                            color: '#1e1e1e',
                                            cursor: 'pointer',
                                            fontSize: '16px',
                                            lineHeight: 1,
                                            padding: 0
                                        }}
                                    >
                                        ×
                                    </button>
                                </div>
                            ))}
                        </div>
                        <div style={{display: 'flex', gap: '8px'}}>
                            <input
                                type="text"
                                placeholder="Add tag..."
                                onKeyDown={(e) => {
                                    if (e.key === 'Enter' && e.target.value.trim()) {
                                        const newTag = e.target.value.trim();
                                        const currentTags = itemTags[item.id] || [];
                                        if (!currentTags.includes(newTag)) {
                                            setItemTags({...itemTags, [item.id]: [...currentTags, newTag]});
                                        }
                                        e.target.value = '';
                                    }
                                }}
                                style={{
                                    flex: 1,
                                    padding: '8px',
                                    background: '#1e1e1e',
                                    border: '1px solid #3e3e42',
                                    borderRadius: '4px',
                                    color: '#d4d4d4',
                                    fontSize: '13px'
                                }}
                            />
                        </div>
                        <div style={{fontSize: '11px', color: '#858585', marginTop: '6px'}}>
                            💡 Press Enter to add tags. Use tags to organize and filter content.
                        </div>
                    </div>

                    <div className="form-section" style={{marginTop: '24px', background: '#2d2d30', borderLeft: '3px solid #569cd6'}}>
                        <h3 style={{marginBottom: '12px', color: '#569cd6', fontSize: '14px'}}>📝 Internal Notes (Not Exported)</h3>
                        <textarea
                            value={notes[item.id] || ''}
                            onChange={(e) => setNotes({...notes, [item.id]: e.target.value})}
                            placeholder="Add notes, reminders, or comments about this thread..."
                            style={{
                                width: '100%',
                                minHeight: '80px',
                                padding: '10px',
                                background: '#1e1e1e',
                                border: '1px solid #3e3e42',
                                borderRadius: '4px',
                                color: '#d4d4d4',
                                fontSize: '13px',
                                fontFamily: 'inherit',
                                resize: 'vertical'
                            }}
                        />
                        <div style={{fontSize: '11px', color: '#858585', marginTop: '6px'}}>
                            💡 Notes are saved in your browser and won't be included in JSON exports
                        </div>
                    </div>
                </div>
            );
        }

        function PostEditor({ item, updateItem, data, catIndex, threadIndex, postIndex, createReplyPosts, notes, setNotes, itemTags, setItemTags, userLibrary }) {
            const [parentPost, setParentPost] = React.useState(null);

            // When type changes to reply, find the previous post to quote
            React.useEffect(() => {
                if (item.type === 'reply' && !item.quote_user) {
                    // This would need access to the full data structure to find parent
                    // For now, we'll just note that it should be populated
                }
            }, [item.type]);

            const handleConditionChange = (field, value) => {
                const newConditions = { ...(item.conditions || {}) };
                if (value === '' || value === null) {
                    delete newConditions[field];
                } else {
                    newConditions[field] = value;
                }
                updateItem({ conditions: Object.keys(newConditions).length > 0 ? newConditions : undefined });
            };

            const addOption = () => {
                const newOptions = [...(item.options || []), { text: "New Option", reply_body: "Reply text here", set_flag: "FLAG_NEW" }];
                updateItem({ options: newOptions });
            };

            const updateOption = (index, field, value) => {
                const newOptions = [...(item.options || [])];
                newOptions[index][field] = value;
                updateItem({ options: newOptions });
            };

            const deleteOption = (index) => {
                const newOptions = [...(item.options || [])];
                newOptions.splice(index, 1);
                updateItem({ options: newOptions.length > 0 ? newOptions : undefined });
            };

            const handleTypeChange = (newType) => {
                updateItem({ type: newType });
                
                // If changing to reply and no quote is set, prompt user to fill it
                if (newType === 'reply' && !item.quote_user) {
                    updateItem({ 
                        type: newType,
                        quote_user: item.quote_user || '[Previous User]',
                        quote_text: item.quote_text || '[Quote the post being replied to]'
                    });
                }
            };

            const handleUserSelect = (userId) => {
                if (userId === 'custom') {
                    // Keep current values, allow manual editing
                    return;
                }
                const user = userLibrary.find(u => u.id === userId);
                if (user) {
                    updateItem({
                        user_name: user.name,
                        user_rank: user.rank,
                        avatar: user.avatar
                    });
                }
            };

            return (
                <div className="editor-panel">
                    <h2 style={{marginBottom: '24px', color: '#ce9178'}}>Edit Post</h2>
                    <div className="form-group">
                        <label>ID</label>
                        <input type="text" value={item.id} onChange={(e) => updateItem({ id: e.target.value })} />
                    </div>
                    <div className="form-group">
                        <label>Type</label>
                        <select value={item.type} onChange={(e) => handleTypeChange(e.target.value)}>
                            <option value="original">Original</option>
                            <option value="reply">Reply</option>
                            <option value="alert">Alert</option>
                        </select>
                        {item.type === 'reply' && (
                            <small style={{color: '#858585', marginTop: '4px', display: 'block'}}>
                                Tip: Fill in the quote fields below to show what this post is replying to
                            </small>
                        )}
                    </div>
                    <div className="form-group">
                        <label>Timestamp</label>
                        <input type="number" value={item.timestamp} onChange={(e) => updateItem({ timestamp: parseInt(e.target.value) })} />
                    </div>
                    
                    {/* User Picker */}
                    {userLibrary && userLibrary.length > 0 && (
                        <div className="form-group">
                            <label>Select User from Library</label>
                            <select 
                                value=""
                                onChange={(e) => handleUserSelect(e.target.value)}
                                style={{marginBottom: '8px'}}
                            >
                                <option value="">-- Quick Select --</option>
                                {userLibrary.filter(u => u.status === 'active').map(user => (
                                    <option key={user.id} value={user.id}>
                                        {user.name} {user.rank ? `(${user.rank})` : ''}
                                    </option>
                                ))}
                                <option value="custom">-- Manual Entry --</option>
                            </select>
                        </div>
                    )}
                    
                    <div className="form-group">
                        <label>User Name</label>
                        <input type="text" value={item.user_name} onChange={(e) => updateItem({ user_name: e.target.value })} />
                    </div>
                    <div className="form-group">
                        <label>User Rank</label>
                        <input type="text" value={item.user_rank} onChange={(e) => updateItem({ user_rank: e.target.value })} />
                    </div>
                    <div className="form-group">
                        <label>Avatar</label>
                        <input type="text" value={item.avatar} onChange={(e) => updateItem({ avatar: e.target.value })} />
                    </div>
                    <div className="form-group">
                        <label>Body</label>
                        <textarea value={item.body} onChange={(e) => updateItem({ body: e.target.value })} />
                    </div>

                    <div className="form-section">
                        <div className="form-section-title">Quote (Optional - Required for Reply type)</div>
                        <div className="form-group">
                            <label>Quote User</label>
                            <input 
                                type="text" 
                                value={item.quote_user || ''} 
                                onChange={(e) => updateItem({ quote_user: e.target.value || undefined })}
                                placeholder="User being quoted"
                            />
                        </div>
                        <div className="form-group">
                            <label>Quote Text</label>
                            <textarea 
                                value={item.quote_text || ''} 
                                onChange={(e) => updateItem({ quote_text: e.target.value || undefined })}
                                placeholder="Text from the post being quoted"
                            />
                        </div>
                    </div>

                    <div className="form-section">
                        <div className="form-section-title">Conditions (Optional)</div>
                        <div className="form-group">
                            <label>Minimum Day</label>
                            <input 
                                type="number" 
                                value={item.conditions?.min_day || ''} 
                                onChange={(e) => handleConditionChange('min_day', e.target.value ? parseInt(e.target.value) : null)}
                                placeholder="Leave empty for no restriction"
                            />
                        </div>
                        <div className="form-group">
                            <label>Required Flag</label>
                            <input 
                                type="text" 
                                value={item.conditions?.requires_flag || ''} 
                                onChange={(e) => handleConditionChange('requires_flag', e.target.value || null)}
                                placeholder="e.g. FLAG_QUEST_COMPLETE"
                            />
                        </div>
                    </div>

                    <div className="form-section">
                        <div className="form-section-title">Reply Options</div>
                        <small style={{color: '#858585', marginBottom: '12px', display: 'block'}}>
                            Each option creates a player choice. Use "Create Reply Posts" button to auto-generate reply posts for each option.
                        </small>
                        {(item.options || []).map((option, index) => (
                            <div key={index} className="option-item">
                                <div className="form-group">
                                    <label>Button Text (shown to player)</label>
                                    <input 
                                        type="text" 
                                        value={option.text} 
                                        onChange={(e) => updateOption(index, 'text', e.target.value)}
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Reply Body (what the player's character says)</label>
                                    <textarea 
                                        value={option.reply_body || ''} 
                                        onChange={(e) => updateOption(index, 'reply_body', e.target.value)}
                                        placeholder="The actual reply text that will be shown when this option is selected"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Set Flag (triggered when selected)</label>
                                    <input 
                                        type="text" 
                                        value={option.set_flag} 
                                        onChange={(e) => updateOption(index, 'set_flag', e.target.value)}
                                    />
                                </div>
                                <button onClick={() => deleteOption(index)}>Remove Option</button>
                            </div>
                        ))}
                        <button className="add-button" onClick={addOption} style={{marginBottom: '12px'}}>+ Add Option</button>
                        {(item.options && item.options.length > 0) && (
                            <button 
                                className="add-button" 
                                onClick={() => createReplyPosts(catIndex, threadIndex, postIndex)}
                                style={{background: '#0e9c63'}}
                            >
                                ✨ Create Reply Posts from Options
                            </button>
                        )}

                        <div className="form-section" style={{marginTop: '24px', background: '#2d2d30', borderLeft: '3px solid #dcdcaa'}}>
                            <h3 style={{marginBottom: '12px', color: '#dcdcaa', fontSize: '14px'}}>🏷️ Tags (Not Exported)</h3>
                            <div style={{display: 'flex', flexWrap: 'wrap', gap: '6px', marginBottom: '12px'}}>
                                {(itemTags[item.id] || []).map((tag, idx) => (
                                    <div key={idx} style={{
                                        padding: '4px 10px',
                                        background: '#dcdcaa',
                                        color: '#1e1e1e',
                                        borderRadius: '12px',
                                        fontSize: '12px',
                                        fontWeight: '500',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '6px'
                                    }}>
                                        {tag}
                                        <button
                                            onClick={() => {
                                                const newTags = [...(itemTags[item.id] || [])];
                                                newTags.splice(idx, 1);
                                                setItemTags({...itemTags, [item.id]: newTags});
                                            }}
                                            style={{
                                                background: 'transparent',
                                                border: 'none',
                                                color: '#1e1e1e',
                                                cursor: 'pointer',
                                                fontSize: '16px',
                                                lineHeight: 1,
                                                padding: 0
                                            }}
                                        >
                                            ×
                                        </button>
                                    </div>
                                ))}
                            </div>
                            <div style={{display: 'flex', gap: '8px'}}>
                                <input
                                    type="text"
                                    placeholder="Add tag..."
                                    onKeyDown={(e) => {
                                        if (e.key === 'Enter' && e.target.value.trim()) {
                                            const newTag = e.target.value.trim();
                                            const currentTags = itemTags[item.id] || [];
                                            if (!currentTags.includes(newTag)) {
                                                setItemTags({...itemTags, [item.id]: [...currentTags, newTag]});
                                            }
                                            e.target.value = '';
                                        }
                                    }}
                                    style={{
                                        flex: 1,
                                        padding: '8px',
                                        background: '#1e1e1e',
                                        border: '1px solid #3e3e42',
                                        borderRadius: '4px',
                                        color: '#d4d4d4',
                                        fontSize: '13px'
                                    }}
                                />
                            </div>
                            <div style={{fontSize: '11px', color: '#858585', marginTop: '6px'}}>
                                💡 Press Enter to add tags. Use tags to organize and filter content.
                            </div>
                        </div>

                        <div className="form-section" style={{marginTop: '24px', background: '#2d2d30', borderLeft: '3px solid #569cd6'}}>
                            <h3 style={{marginBottom: '12px', color: '#569cd6', fontSize: '14px'}}>📝 Internal Notes (Not Exported)</h3>
                            <textarea
                                value={notes[item.id] || ''}
                                onChange={(e) => setNotes({...notes, [item.id]: e.target.value})}
                                placeholder="Add notes, reminders, or comments about this post..."
                                style={{
                                    width: '100%',
                                    minHeight: '80px',
                                    padding: '10px',
                                    background: '#1e1e1e',
                                    border: '1px solid #3e3e42',
                                    borderRadius: '4px',
                                    color: '#d4d4d4',
                                    fontSize: '13px',
                                    fontFamily: 'inherit',
                                    resize: 'vertical'
                                }}
                            />
                            <div style={{fontSize: '11px', color: '#858585', marginTop: '6px'}}>
                                💡 Notes are saved in your browser and won't be included in JSON exports
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function GraphPanel({ data, setSelectedItem, onNodeDoubleClick, runValidation, notes, itemTags, onAddCategory, onAddThread, onAddPost }) {
            const [nodes, setNodes] = useState([]);
            const [edges, setEdges] = useState([]);
            const [highlightedFlag, setHighlightedFlag] = useState(null);
            const [collapsedBranches, setCollapsedBranches] = useState(new Set());
            const [validationIssues, setValidationIssues] = useState([]);
            const [simulatedFlags, setSimulatedFlags] = useState(new Set());
            const [showFlagDebugger, setShowFlagDebugger] = useState(false);
            const [layoutDirection, setLayoutDirection] = useState(() => {
                // Load saved layout preference
                try {
                    const saved = localStorage.getItem('narrative-editor-layout');
                    return saved || 'horizontal';
                } catch (e) {
                    return 'horizontal';
                }
            });
            const [contextMenu, setContextMenu] = useState(null); // { x, y, nodeId, nodeType, path }
            const reactFlowInstance = React.useRef(null);

            // Save layout preference when it changes
            useEffect(() => {
                try {
                    localStorage.setItem('narrative-editor-layout', layoutDirection);
                } catch (e) {
                    console.error('Failed to save layout preference:', e);
                }
            }, [layoutDirection]);

            // Close context menu when clicking elsewhere
            useEffect(() => {
                const handleClick = () => setContextMenu(null);
                document.addEventListener('click', handleClick);
                return () => document.removeEventListener('click', handleClick);
            }, []);

            // Handle right-click on nodes
            const onNodeContextMenu = (event, node) => {
                event.preventDefault();
                
                // Parse node ID to get path
                let nodeType, path;
                if (node.id.startsWith('cat-')) {
                    nodeType = 'category';
                    const catIndex = parseInt(node.id.split('-')[1]);
                    path = [catIndex];
                } else if (node.id.startsWith('thread-')) {
                    nodeType = 'thread';
                    const parts = node.id.split('-');
                    path = [parseInt(parts[1]), parseInt(parts[2])];
                } else if (node.id.startsWith('post-')) {
                    nodeType = 'post';
                    const parts = node.id.split('-');
                    path = [parseInt(parts[1]), parseInt(parts[2]), parseInt(parts[3])];
                }

                setContextMenu({
                    x: event.clientX,
                    y: event.clientY,
                    nodeId: node.id,
                    nodeType,
                    path
                });
            };

            // Run validation when data changes
            useEffect(() => {
                if (runValidation) {
                    setValidationIssues(runValidation());
                }
            }, [data, runValidation]);

            useEffect(() => {
                const newNodes = [];
                const newEdges = [];
                let yOffset = 0;
                let xOffset = 0; // For vertical layout

                data.forEach((category, catIndex) => {
                    // Add category node
                    newNodes.push({
                        id: `cat-${catIndex}`,
                        type: 'default',
                        data: { 
                            label: (
                                <div>
                                    <div className="node-title">📁 {category.title}</div>
                                    <div className="node-subtitle">
                                        {category.subtitle}<br/>
                                        {category.threads.length} thread{category.threads.length !== 1 ? 's' : ''}
                                    </div>
                                </div>
                            )
                        },
                        position: { x: 50, y: yOffset },
                        className: 'category',
                        style: {
                            background: '#1e4d3a',
                            borderColor: '#4ec9b0'
                        }
                    });

                    let threadYOffset = yOffset;

                    category.threads.forEach((thread, threadIndex) => {
                        const threadId = `thread-${catIndex}-${threadIndex}`;
                        const isCollapsed = collapsedBranches.has(threadId);
                        
                        // Check for validation issues on this thread
                        const threadIssues = validationIssues.filter(issue => 
                            issue.path && issue.path[0] === catIndex && issue.path[1] === threadIndex && issue.path[2] === undefined
                        );
                        const hasErrors = threadIssues.some(i => i.type === 'error');
                        const hasWarnings = threadIssues.some(i => i.type === 'warning');
                        
                        // Build thread details
                        const threadDetails = [];
                        if (thread.pinned) threadDetails.push('📌 Pinned');
                        if (thread.conditions?.requires_flag) threadDetails.push(`🔒 ${thread.conditions.requires_flag}`);
                        if (thread.conditions?.min_day) threadDetails.push(`📅 Day ${thread.conditions.min_day}+`);
                        threadDetails.push(`${thread.posts.length} post${thread.posts.length !== 1 ? 's' : ''}`);
                        
                        // Add thread node
                        newNodes.push({
                            id: threadId,
                            type: 'default',
                            data: { 
                                label: (
                                    <div>
                                        <div className="node-title">
                                            💬 {thread.title}
                                            {hasErrors && <span style={{marginLeft: '4px', color: '#f48771', fontSize: '14px'}} title={threadIssues.filter(i => i.type === 'error').map(i => i.message).join('\n')}>❌</span>}
                                            {!hasErrors && hasWarnings && <span style={{marginLeft: '4px', color: '#dcdcaa', fontSize: '14px'}} title={threadIssues.filter(i => i.type === 'warning').map(i => i.message).join('\n')}>⚠️</span>}
                                            <button
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    const newCollapsed = new Set(collapsedBranches);
                                                    if (newCollapsed.has(threadId)) {
                                                        newCollapsed.delete(threadId);
                                                    } else {
                                                        newCollapsed.add(threadId);
                                                    }
                                                    setCollapsedBranches(newCollapsed);
                                                }}
                                                style={{
                                                    marginLeft: '8px',
                                                    padding: '2px 6px',
                                                    fontSize: '10px',
                                                    background: '#3e3e42',
                                                    border: 'none',
                                                    borderRadius: '3px',
                                                    color: '#d4d4d4',
                                                    cursor: 'pointer'
                                                }}
                                            >
                                                {isCollapsed ? '▶' : '▼'}
                                            </button>
                                        </div>
                                        <div className="node-subtitle">
                                            {threadDetails.join(' • ')}
                                        </div>
                                    </div>
                                )
                            },
                            position: { x: 400, y: threadYOffset },
                            className: 'thread',
                            style: {
                                background: '#3d3a1e',
                                borderColor: '#dcdcaa'
                            }
                        });

                        // Connect category to thread
                        newEdges.push({
                            id: `edge-cat-${catIndex}-thread-${threadIndex}`,
                            source: `cat-${catIndex}`,
                            target: threadId,
                            animated: false,
                            style: { stroke: '#666', strokeWidth: 2 }
                        });

                        // Skip posts if thread is collapsed
                        if (isCollapsed) {
                            threadYOffset += 200;
                            return;
                        }

                        // Build dependency graph - find direct parent for each post
                        const directParent = new Map(); // postIndex -> parentPostIndex
                        const children = new Map(); // postIndex -> [childIndices]
                        
                        thread.posts.forEach((post, postIndex) => {
                            if (!post.conditions?.requires_flag) return;
                            
                            // Find the most recent post that either sets this flag OR also requires it (chain)
                            for (let i = postIndex - 1; i >= 0; i--) {
                                const candidatePost = thread.posts[i];
                                
                                // Case 1: Parent sets the flag via options
                                if (candidatePost.options?.some(opt => opt.set_flag === post.conditions.requires_flag)) {
                                    directParent.set(postIndex, i);
                                    if (!children.has(i)) children.set(i, []);
                                    children.get(i).push(postIndex);
                                    break;
                                }
                                
                                // Case 2: Parent also requires same flag (forming a chain)
                                if (candidatePost.conditions?.requires_flag === post.conditions.requires_flag) {
                                    directParent.set(postIndex, i);
                                    if (!children.has(i)) children.set(i, []);
                                    children.get(i).push(postIndex);
                                    break;
                                }
                            }
                        });

                        // Calculate levels (horizontal depth in tree)
                        const levels = new Map();
                        const calculateLevel = (postIndex) => {
                            if (levels.has(postIndex)) return levels.get(postIndex);
                            
                            if (!directParent.has(postIndex)) {
                                levels.set(postIndex, 0);
                                return 0;
                            }
                            
                            const parentIdx = directParent.get(postIndex);
                            const level = calculateLevel(parentIdx) + 1;
                            levels.set(postIndex, level);
                            return level;
                        };
                        
                        thread.posts.forEach((_, idx) => calculateLevel(idx));

                        // Calculate positions
                        const positions = new Map();
                        const LEVEL_SPACING = 350;
                        const BRANCH_SPACING = 250;
                        const BASE_X = 800;
                        const BASE_Y = threadYOffset;
                        
                        thread.posts.forEach((post, postIndex) => {
                            const level = levels.get(postIndex) || 0;
                            const xPos = BASE_X + (level * LEVEL_SPACING);
                            
                            let yPos = BASE_Y;
                            
                            if (directParent.has(postIndex)) {
                                const parentIdx = directParent.get(postIndex);
                                const parentPos = positions.get(parentIdx);
                                const siblings = children.get(parentIdx) || [];
                                
                                if (parentPos && siblings.length > 0) {
                                    // Spread siblings vertically around parent
                                    const siblingIndex = siblings.indexOf(postIndex);
                                    const offset = (siblingIndex - (siblings.length - 1) / 2) * BRANCH_SPACING;
                                    yPos = parentPos.y + offset;
                                }
                            } else {
                                // Root posts
                                const rootPosts = Array.from({length: thread.posts.length}, (_, i) => i).filter(i => !directParent.has(i));
                                const rootIndex = rootPosts.indexOf(postIndex);
                                yPos = BASE_Y + (rootIndex * BRANCH_SPACING);
                            }
                            
                            positions.set(postIndex, { x: xPos, y: yPos });
                        });

                        // Create nodes for all posts
                        thread.posts.forEach((post, postIndex) => {
                            const postId = `post-${catIndex}-${threadIndex}-${postIndex}`;
                            const pos = positions.get(postIndex);
                            
                            // Check for validation issues on this post
                            const postIssues = validationIssues.filter(issue => 
                                issue.path && issue.path[0] === catIndex && issue.path[1] === threadIndex && issue.path[2] === postIndex
                            );
                            const hasErrors = postIssues.some(i => i.type === 'error');
                            const hasWarnings = postIssues.some(i => i.type === 'warning');
                            
                            const postDetails = [];
                            postDetails.push(`Type: ${post.type}`);
                            if (post.quote_user) postDetails.push(`↩️ Replies to ${post.quote_user}`);
                            if (post.conditions?.min_day) postDetails.push(`📅 Day ${post.conditions.min_day}+`);
                            if (post.options && post.options.length > 0) {
                                postDetails.push(`${post.options.length} choice${post.options.length !== 1 ? 's' : ''}`);
                            }

                            // Collect flags this post is involved with
                            const flagsSet = post.options ? post.options.map(opt => opt.set_flag) : [];
                            const flagRequired = post.conditions?.requires_flag;
                            
                            // Check if post is unreachable based on simulated flags
                            const isUnreachable = simulatedFlags.size > 0 && flagRequired && !simulatedFlags.has(flagRequired);
                            
                            newNodes.push({
                                id: postId,
                                type: 'default',
                                data: { 
                                    label: (
                                        <div>
                                            <div className="node-title">
                                                {post.type === 'reply' ? '↩️' : post.type === 'alert' ? '⚠️' : '💭'} {post.user_name}
                                                {hasErrors && <span style={{marginLeft: '4px', color: '#f48771', fontSize: '12px'}} title={postIssues.filter(i => i.type === 'error').map(i => i.message).join('\n')}>❌</span>}
                                                {!hasErrors && hasWarnings && <span style={{marginLeft: '4px', color: '#dcdcaa', fontSize: '12px'}} title={postIssues.filter(i => i.type === 'warning').map(i => i.message).join('\n')}>⚠️</span>}
                                                {notes[post.id] && <span style={{marginLeft: '4px', fontSize: '12px'}} title={notes[post.id]}>📝</span>}
                                                {itemTags[post.id] && itemTags[post.id].length > 0 && <span style={{marginLeft: '4px', fontSize: '12px'}} title={itemTags[post.id].join(', ')}>🏷️</span>}
                                                {flagsSet.length > 0 && flagsSet.map(flag => (
                                                    <span 
                                                        key={flag} 
                                                        className="flag-badge sets-flag"
                                                        onClick={(e) => { e.stopPropagation(); setHighlightedFlag(flag); }}
                                                    >
                                                        ⚑ {flag}
                                                    </span>
                                                ))}
                                                {flagRequired && (
                                                    <span 
                                                        className="flag-badge requires-flag"
                                                        onClick={(e) => { e.stopPropagation(); setHighlightedFlag(flagRequired); }}
                                                    >
                                                        🔒 {flagRequired}
                                                    </span>
                                                )}
                                            </div>
                                            <div className="node-subtitle">
                                                {post.body.substring(0, 50)}{post.body.length > 50 ? '...' : ''}<br/>
                                                <small>{postDetails.join(' • ')}</small>
                                            </div>
                                        </div>
                                    ),
                                    flagsSet,
                                    flagRequired
                                },
                                position: pos,
                                className: `post-${post.type}${isUnreachable ? ' dimmed' : ''}`,
                                style: {
                                    background: post.type === 'reply' ? '#4d2d3d' : 
                                               post.type === 'alert' ? '#4d3d1e' : 
                                               '#2d3d4d',
                                    borderColor: post.type === 'reply' ? '#ce9178' : 
                                                post.type === 'alert' ? '#dcdcaa' : 
                                                '#9cdcfe',
                                    opacity: isUnreachable ? 0.3 : 1
                                }
                            });
                        });

                        // Create edges
                        // Thread to first post
                        if (thread.posts.length > 0) {
                            newEdges.push({
                                id: `edge-thread-${catIndex}-${threadIndex}-post-0`,
                                source: threadId,
                                target: `post-${catIndex}-${threadIndex}-0`,
                                animated: false,
                                style: { stroke: '#666', strokeWidth: 2 }
                            });
                        }

                        // Parent to child connections
                        directParent.forEach((parentIdx, childIdx) => {
                            const parentPost = thread.posts[parentIdx];
                            const childPost = thread.posts[childIdx];
                            
                            // Check if parent has option that triggers this child
                            const triggeringOption = parentPost.options?.find(
                                opt => opt.set_flag === childPost.conditions?.requires_flag
                            );
                            
                            if (triggeringOption) {
                                // Branch connection (parent has option that sets the flag)
                                newEdges.push({
                                    id: `edge-branch-${catIndex}-${threadIndex}-${parentIdx}-${childIdx}`,
                                    source: `post-${catIndex}-${threadIndex}-${parentIdx}`,
                                    target: `post-${catIndex}-${threadIndex}-${childIdx}`,
                                    animated: true,
                                    label: `"${triggeringOption.text}"`,
                                    style: { stroke: '#4ec9b0', strokeWidth: 3 },
                                    markerEnd: { type: MarkerType.ArrowClosed, color: '#4ec9b0' },
                                    type: 'smoothstep'
                                });
                            } else {
                                // Chain connection (both have same flag requirement)
                                newEdges.push({
                                    id: `edge-chain-${catIndex}-${threadIndex}-${parentIdx}-${childIdx}`,
                                    source: `post-${catIndex}-${threadIndex}-${parentIdx}`,
                                    target: `post-${catIndex}-${threadIndex}-${childIdx}`,
                                    animated: false,
                                    style: { stroke: '#666', strokeWidth: 2 },
                                    type: 'smoothstep'
                                });
                            }
                        });

                        // Sequential connections for posts without conditions
                        thread.posts.forEach((post, postIndex) => {
                            if (postIndex === 0) return;
                            if (directParent.has(postIndex)) return;
                            if (post.conditions?.requires_flag) return;
                            
                            const prevPost = thread.posts[postIndex - 1];
                            if (!prevPost.options || prevPost.options.length === 0) {
                                newEdges.push({
                                    id: `edge-seq-${catIndex}-${threadIndex}-${postIndex-1}-${postIndex}`,
                                    source: `post-${catIndex}-${threadIndex}-${postIndex-1}`,
                                    target: `post-${catIndex}-${threadIndex}-${postIndex}`,
                                    animated: false,
                                    style: { stroke: '#666', strokeWidth: 2 },
                                    type: 'smoothstep'
                                });
                            }
                        });

                        // Calculate max Y for thread height
                        let maxY = BASE_Y;
                        positions.forEach(pos => {
                            maxY = Math.max(maxY, pos.y);
                        });
                        
                        threadYOffset = maxY + 400;
                    });

                    yOffset = threadYOffset + 150;
                });

                // Apply vertical layout transformation if needed
                if (layoutDirection === 'vertical') {
                    newNodes.forEach((node, index) => {
                        node.position = {
                            x: node.position.y,
                            y: node.position.x
                        };
                    });
                }

                setNodes(newNodes);
                setEdges(newEdges);
            }, [data, collapsedBranches, validationIssues, simulatedFlags, layoutDirection]);

            // Fit view when layout direction changes
            useEffect(() => {
                if (reactFlowInstance.current) {
                    // Use setTimeout to ensure nodes are positioned before fitting
                    setTimeout(() => {
                        reactFlowInstance.current.fitView({ padding: 0.2, duration: 400 });
                    }, 50);
                }
            }, [layoutDirection]);

            // Apply highlighting when a flag is selected
            useEffect(() => {
                if (!highlightedFlag) {
                    // Clear all highlighting
                    setNodes(prevNodes => prevNodes.map(node => ({
                        ...node,
                        className: node.className.replace(' highlighted', '').replace(' dimmed', '')
                    })));
                    return;
                }

                setNodes(prevNodes => prevNodes.map(node => {
                    const nodeData = node.data;
                    const isInvolved = nodeData.flagsSet?.includes(highlightedFlag) || 
                                      nodeData.flagRequired === highlightedFlag;
                    
                    let newClassName = node.className.replace(' highlighted', '').replace(' dimmed', '');
                    if (isInvolved) {
                        newClassName += ' highlighted';
                    } else {
                        newClassName += ' dimmed';
                    }
                    
                    return { ...node, className: newClassName };
                }));
            }, [highlightedFlag]);

            const onNodeClick = useCallback((event, node) => {
                const [type, ...indices] = node.id.split('-');
                const path = indices.map(i => parseInt(i));
                
                if (type === 'cat') {
                    setSelectedItem({ type: 'category', path });
                } else if (type === 'thread') {
                    setSelectedItem({ type: 'thread', path });
                } else if (type === 'post') {
                    setSelectedItem({ type: 'post', path });
                }
            }, [setSelectedItem]);

            const onNodeDoubleClickHandler = useCallback((event, node) => {
                if (!onNodeDoubleClick) return;
                
                const [type, ...indices] = node.id.split('-');
                const path = indices.map(i => parseInt(i));
                
                if (type === 'cat') {
                    onNodeDoubleClick({ type: 'category', path });
                } else if (type === 'thread') {
                    onNodeDoubleClick({ type: 'thread', path });
                } else if (type === 'post') {
                    onNodeDoubleClick({ type: 'post', path });
                }
            }, [onNodeDoubleClick]);

            return (
                <div className="graph-panel" style={{position: 'relative'}}>
                    {highlightedFlag && (
                        <div style={{
                            position: 'absolute',
                            top: '10px',
                            left: '10px',
                            background: '#0e639c',
                            padding: '12px 16px',
                            borderRadius: '6px',
                            zIndex: 10,
                            fontSize: '14px',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '12px'
                        }}>
                            <span>🔍 Highlighting: <strong>{highlightedFlag}</strong></span>
                            <button 
                                onClick={() => setHighlightedFlag(null)}
                                style={{background: '#252526', border: 'none', color: 'white', padding: '4px 12px', borderRadius: '4px', cursor: 'pointer'}}
                            >
                                Clear
                            </button>
                        </div>
                    )}

                    {/* Flag State Debugger */}
                    <div style={{
                        position: 'absolute',
                        top: '10px',
                        left: '10px',
                        zIndex: 10
                    }}>
                        <button
                            onClick={() => setShowFlagDebugger(!showFlagDebugger)}
                            style={{
                                background: showFlagDebugger ? '#0e639c' : '#252526',
                                border: '1px solid #3e3e42',
                                color: 'white',
                                padding: '8px 16px',
                                borderRadius: '6px',
                                cursor: 'pointer',
                                fontSize: '13px',
                                fontWeight: 'bold'
                            }}
                        >
                            🎮 Flag Debugger {showFlagDebugger ? '▼' : '▶'}
                        </button>

                        {showFlagDebugger && (() => {
                            const allFlags = new Set();
                            data.forEach(cat => {
                                cat.threads.forEach(thread => {
                                    if (thread.conditions?.requires_flag) allFlags.add(thread.conditions.requires_flag);
                                    thread.posts.forEach(post => {
                                        if (post.conditions?.requires_flag) allFlags.add(post.conditions.requires_flag);
                                        post.options?.forEach(opt => {
                                            if (opt.set_flag) allFlags.add(opt.set_flag);
                                        });
                                    });
                                });
                            });

                            return (
                                <div style={{
                                    marginTop: '8px',
                                    background: '#252526',
                                    padding: '16px',
                                    borderRadius: '6px',
                                    border: '1px solid #3e3e42',
                                    maxWidth: '300px',
                                    maxHeight: '400px',
                                    overflowY: 'auto'
                                }}>
                                    <div style={{marginBottom: '12px', fontSize: '12px', color: '#858585'}}>
                                        Simulate flag states to see which content would be accessible
                                    </div>
                                    
                                    <div style={{marginBottom: '12px'}}>
                                        <button
                                            onClick={() => setSimulatedFlags(new Set())}
                                            style={{
                                                background: '#3e3e42',
                                                border: 'none',
                                                color: '#d4d4d4',
                                                padding: '6px 12px',
                                                borderRadius: '4px',
                                                cursor: 'pointer',
                                                fontSize: '12px',
                                                marginRight: '8px'
                                            }}
                                        >
                                            Clear All
                                        </button>
                                        <button
                                            onClick={() => setSimulatedFlags(new Set(allFlags))}
                                            style={{
                                                background: '#3e3e42',
                                                border: 'none',
                                                color: '#d4d4d4',
                                                padding: '6px 12px',
                                                borderRadius: '4px',
                                                cursor: 'pointer',
                                                fontSize: '12px'
                                            }}
                                        >
                                            Set All
                                        </button>
                                    </div>

                                    <div style={{fontSize: '11px', color: '#4ec9b0', marginBottom: '8px', fontWeight: 'bold'}}>
                                        Active: {simulatedFlags.size} / {allFlags.size}
                                    </div>

                                    {Array.from(allFlags).sort().map(flag => (
                                        <label key={flag} style={{
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '8px',
                                            padding: '6px',
                                            marginBottom: '4px',
                                            background: simulatedFlags.has(flag) ? '#2d3d2d' : 'transparent',
                                            borderRadius: '4px',
                                            cursor: 'pointer',
                                            fontSize: '12px'
                                        }}>
                                            <input
                                                type="checkbox"
                                                checked={simulatedFlags.has(flag)}
                                                onChange={(e) => {
                                                    const newFlags = new Set(simulatedFlags);
                                                    if (e.target.checked) {
                                                        newFlags.add(flag);
                                                    } else {
                                                        newFlags.delete(flag);
                                                    }
                                                    setSimulatedFlags(newFlags);
                                                }}
                                                style={{cursor: 'pointer'}}
                                            />
                                            <span style={{color: simulatedFlags.has(flag) ? '#4ec9b0' : '#d4d4d4'}}>
                                                {flag}
                                            </span>
                                        </label>
                                    ))}
                                </div>
                            );
                        })()}
                    </div>
                    
                    {/* Layout Controls */}
                    <div style={{
                        position: 'absolute',
                        top: '10px',
                        right: '280px',
                        background: '#252526',
                        padding: '12px',
                        borderRadius: '6px',
                        border: '1px solid #3e3e42',
                        zIndex: 10
                    }}>
                        <div style={{fontWeight: 'bold', marginBottom: '8px', fontSize: '12px'}}>Layout:</div>
                        <button
                            onClick={() => setLayoutDirection(layoutDirection === 'horizontal' ? 'vertical' : 'horizontal')}
                            style={{
                                padding: '8px 12px',
                                background: '#0e639c',
                                border: 'none',
                                borderRadius: '4px',
                                color: 'white',
                                cursor: 'pointer',
                                fontSize: '12px',
                                width: '100%'
                            }}
                        >
                            {layoutDirection === 'horizontal' ? '⬇️ Vertical' : '➡️ Horizontal'}
                        </button>
                    </div>
                    
                    <div style={{
                        position: 'absolute',
                        top: '10px',
                        right: '10px',
                        background: '#252526',
                        padding: '12px',
                        borderRadius: '6px',
                        border: '1px solid #3e3e42',
                        zIndex: 10,
                        fontSize: '12px',
                        maxWidth: '250px'
                    }}>
                        <div style={{fontWeight: 'bold', marginBottom: '8px'}}>Legend:</div>
                        <div style={{display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '4px'}}>
                            <div style={{width: '20px', height: '20px', background: '#2d2d3d', border: '2px solid #9cdcfe', borderRadius: '3px'}}></div>
                            <span>Original Post</span>
                        </div>
                        <div style={{display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '4px'}}>
                            <div style={{width: '20px', height: '20px', background: '#3d2d2d', border: '2px solid #ce9178', borderRadius: '3px'}}></div>
                            <span>Reply Post</span>
                        </div>
                        <div style={{display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px'}}>
                            <div style={{width: '20px', height: '20px', background: '#3d2d1e', border: '2px solid #dcdcaa', borderRadius: '3px'}}></div>
                            <span>Alert Post</span>
                        </div>
                        <div style={{borderTop: '1px solid #3e3e42', paddingTop: '8px', marginTop: '8px'}}>
                            <div style={{display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '4px'}}>
                                <div style={{width: '30px', height: '3px', background: '#666'}}></div>
                                <span>Hierarchy</span>
                            </div>
                            <div style={{display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '4px'}}>
                                <div style={{width: '30px', height: '3px', background: '#4ec9b0'}}></div>
                                <span>Choice Branch</span>
                            </div>
                        </div>
                        <div style={{fontSize: '11px', color: '#858585', marginTop: '8px', paddingTop: '8px', borderTop: '1px solid #3e3e42'}}>
                            💡 Click flag badges to highlight dependencies
                        </div>
                    </div>
                    <ReactFlow.ReactFlow
                        nodes={nodes}
                        edges={edges}
                        onNodeClick={onNodeClick}
                        onNodeDoubleClick={onNodeDoubleClickHandler}
                        onNodeContextMenu={onNodeContextMenu}
                        onInit={(instance) => {
                            reactFlowInstance.current = instance;
                        }}
                        fitView
                        attributionPosition="bottom-left"
                    >
                        <ReactFlow.Background />
                        <ReactFlow.Controls />
                        <ReactFlow.MiniMap 
                            style={{
                                background: '#1e1e1e',
                                width: 250,
                                height: 180
                            }}
                            maskColor="rgba(30, 30, 30, 0.6)"
                            nodeColor={(node) => {
                                if (node.className?.includes('category')) return '#4ec9b0';
                                if (node.className?.includes('thread')) return '#dcdcaa';
                                if (node.className?.includes('post-reply')) return '#ce9178';
                                if (node.className?.includes('post-alert')) return '#dcdcaa';
                                if (node.className?.includes('post-original')) return '#9cdcfe';
                                return '#666';
                            }}
                            nodeStrokeWidth={3}
                            zoomable
                            pannable
                        />
                    </ReactFlow.ReactFlow>

                    {/* Context Menu */}
                    {contextMenu && (
                        <div
                            style={{
                                position: 'fixed',
                                left: contextMenu.x,
                                top: contextMenu.y,
                                background: '#252526',
                                border: '1px solid #3e3e42',
                                borderRadius: '4px',
                                padding: '4px 0',
                                zIndex: 1000,
                                minWidth: '180px',
                                boxShadow: '0 4px 12px rgba(0,0,0,0.5)'
                            }}
                            onClick={(e) => e.stopPropagation()}
                        >
                            <div style={{padding: '8px 12px', fontSize: '11px', color: '#858585', fontWeight: 'bold', borderBottom: '1px solid #3e3e42'}}>
                                {contextMenu.nodeType === 'category' && '📁 Category'}
                                {contextMenu.nodeType === 'thread' && '💬 Thread'}
                                {contextMenu.nodeType === 'post' && '📝 Post'}
                            </div>
                            
                            {contextMenu.nodeType === 'category' && (
                                <div
                                    style={{
                                        padding: '8px 16px',
                                        cursor: 'pointer',
                                        fontSize: '13px',
                                        color: '#d4d4d4'
                                    }}
                                    onMouseEnter={(e) => e.target.style.background = '#2a2d2e'}
                                    onMouseLeave={(e) => e.target.style.background = 'transparent'}
                                    onClick={() => {
                                        onAddThread(contextMenu.path[0]);
                                        setContextMenu(null);
                                    }}
                                >
                                    + Add Thread Here
                                </div>
                            )}
                            
                            {contextMenu.nodeType === 'thread' && (
                                <div
                                    style={{
                                        padding: '8px 16px',
                                        cursor: 'pointer',
                                        fontSize: '13px',
                                        color: '#d4d4d4'
                                    }}
                                    onMouseEnter={(e) => e.target.style.background = '#2a2d2e'}
                                    onMouseLeave={(e) => e.target.style.background = 'transparent'}
                                    onClick={() => {
                                        onAddPost(contextMenu.path[0], contextMenu.path[1]);
                                        setContextMenu(null);
                                    }}
                                >
                                    + Add Post Here
                                </div>
                            )}
                            
                            {contextMenu.nodeType === 'post' && (
                                <div
                                    style={{
                                        padding: '8px 16px',
                                        cursor: 'pointer',
                                        fontSize: '13px',
                                        color: '#d4d4d4'
                                    }}
                                    onMouseEnter={(e) => e.target.style.background = '#2a2d2e'}
                                    onMouseLeave={(e) => e.target.style.background = 'transparent'}
                                    onClick={() => {
                                        onAddPost(contextMenu.path[0], contextMenu.path[1]);
                                        setContextMenu(null);
                                    }}
                                >
                                    + Add Post to Thread
                                </div>
                            )}
                            
                            <div style={{borderTop: '1px solid #3e3e42', margin: '4px 0'}}></div>
                            
                            <div
                                style={{
                                    padding: '8px 16px',
                                    cursor: 'pointer',
                                    fontSize: '13px',
                                    color: '#858585'
                                }}
                                onMouseEnter={(e) => e.target.style.background = '#2a2d2e'}
                                onMouseLeave={(e) => e.target.style.background = 'transparent'}
                                onClick={() => setContextMenu(null)}
                            >
                                Cancel
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        function ScreenplayPanel({ data, setData, setSelectedItem, userLibrary, showMessage }) {
            const [selectedThread, setSelectedThread] = useState(null);
            const [editingPost, setEditingPost] = useState(null); // { catIndex, threadIndex, postIndex }
            const [editForm, setEditForm] = useState(null);

            // Get all threads from all categories
            const getAllThreads = () => {
                const threads = [];
                data.forEach((cat, catIndex) => {
                    cat.threads.forEach((thread, threadIndex) => {
                        threads.push({
                            ...thread,
                            categoryTitle: cat.title,
                            path: [catIndex, threadIndex]
                        });
                    });
                });
                return threads;
            };

            const threads = getAllThreads();
            const currentThread = selectedThread || (threads.length > 0 ? threads[0] : null);

            // Start editing a post
            const startEditing = (catIndex, threadIndex, postIndex) => {
                const post = data[catIndex].threads[threadIndex].posts[postIndex];
                setEditingPost({ catIndex, threadIndex, postIndex });
                setEditForm({
                    user_name: post.user_name,
                    user_rank: post.user_rank || '',
                    body: post.body
                });
            };

            // Save edited post
            const saveEdit = () => {
                if (!editingPost || !editForm) return;
                
                const { catIndex, threadIndex, postIndex } = editingPost;
                const newData = JSON.parse(JSON.stringify(data));
                newData[catIndex].threads[threadIndex].posts[postIndex] = {
                    ...newData[catIndex].threads[threadIndex].posts[postIndex],
                    user_name: editForm.user_name,
                    user_rank: editForm.user_rank,
                    body: editForm.body
                };
                
                setData(newData);
                setEditingPost(null);
                setEditForm(null);
                showMessage('Post updated', 'success');
            };

            // Cancel editing
            const cancelEdit = () => {
                setEditingPost(null);
                setEditForm(null);
            };

            // Select user from library
            const selectUser = (userId) => {
                const user = userLibrary.find(u => u.id === userId);
                if (user) {
                    setEditForm({
                        ...editForm,
                        user_name: user.name,
                        user_rank: user.rank
                    });
                }
            };

            // Render a post in screenplay format
            const renderPost = (post, postIndex) => {
                const isReply = post.type === 'reply';
                const isAlert = post.type === 'alert';
                const isEditing = editingPost && 
                    editingPost.catIndex === currentThread.path[0] && 
                    editingPost.threadIndex === currentThread.path[1] && 
                    editingPost.postIndex === postIndex;

                // Edit mode
                if (isEditing) {
                    return (
                        <div 
                            key={postIndex}
                            style={{
                                marginBottom: '24px',
                                padding: '20px',
                                background: '#2d3d2d',
                                borderRadius: '6px',
                                border: '2px solid #0e639c'
                            }}
                        >
                            <h4 style={{color: '#0e639c', marginBottom: '16px'}}>✏️ Editing Post</h4>
                            
                            {/* User picker */}
                            {userLibrary && userLibrary.length > 0 && (
                                <div style={{marginBottom: '12px'}}>
                                    <label style={{display: 'block', marginBottom: '4px', fontSize: '12px', color: '#858585'}}>
                                        Quick Select User:
                                    </label>
                                    <select 
                                        onChange={(e) => selectUser(e.target.value)}
                                        style={{
                                            width: '100%',
                                            padding: '8px',
                                            background: '#1e1e1e',
                                            border: '1px solid #3e3e42',
                                            color: 'white',
                                            borderRadius: '4px'
                                        }}
                                    >
                                        <option value="">-- Select from library --</option>
                                        {userLibrary.filter(u => u.status === 'active').map(user => (
                                            <option key={user.id} value={user.id}>
                                                {user.name} {user.rank ? `(${user.rank})` : ''}
                                            </option>
                                        ))}
                                    </select>
                                </div>
                            )}
                            
                            <div style={{marginBottom: '12px'}}>
                                <label style={{display: 'block', marginBottom: '4px', fontSize: '12px', color: '#858585'}}>
                                    User Name:
                                </label>
                                <input
                                    type="text"
                                    value={editForm.user_name}
                                    onChange={(e) => setEditForm({...editForm, user_name: e.target.value})}
                                    style={{
                                        width: '100%',
                                        padding: '8px',
                                        background: '#1e1e1e',
                                        border: '1px solid #3e3e42',
                                        color: 'white',
                                        borderRadius: '4px'
                                    }}
                                />
                            </div>
                            
                            <div style={{marginBottom: '12px'}}>
                                <label style={{display: 'block', marginBottom: '4px', fontSize: '12px', color: '#858585'}}>
                                    User Rank:
                                </label>
                                <input
                                    type="text"
                                    value={editForm.user_rank}
                                    onChange={(e) => setEditForm({...editForm, user_rank: e.target.value})}
                                    style={{
                                        width: '100%',
                                        padding: '8px',
                                        background: '#1e1e1e',
                                        border: '1px solid #3e3e42',
                                        color: 'white',
                                        borderRadius: '4px'
                                    }}
                                />
                            </div>
                            
                            <div style={{marginBottom: '16px'}}>
                                <label style={{display: 'block', marginBottom: '4px', fontSize: '12px', color: '#858585'}}>
                                    Post Body:
                                </label>
                                <textarea
                                    value={editForm.body}
                                    onChange={(e) => setEditForm({...editForm, body: e.target.value})}
                                    style={{
                                        width: '100%',
                                        padding: '8px',
                                        background: '#1e1e1e',
                                        border: '1px solid #3e3e42',
                                        color: 'white',
                                        borderRadius: '4px',
                                        minHeight: '120px',
                                        fontFamily: 'inherit',
                                        fontSize: '14px'
                                    }}
                                />
                            </div>
                            
                            <div style={{display: 'flex', gap: '8px'}}>
                                <button
                                    onClick={saveEdit}
                                    style={{
                                        padding: '8px 16px',
                                        background: '#0e639c',
                                        border: 'none',
                                        borderRadius: '4px',
                                        color: 'white',
                                        cursor: 'pointer',
                                        fontWeight: 'bold'
                                    }}
                                >
                                    ✓ Save Changes
                                </button>
                                <button
                                    onClick={cancelEdit}
                                    style={{
                                        padding: '8px 16px',
                                        background: '#3e3e42',
                                        border: 'none',
                                        borderRadius: '4px',
                                        color: 'white',
                                        cursor: 'pointer'
                                    }}
                                >
                                    Cancel
                                </button>
                            </div>
                        </div>
                    );
                }

                // View mode
                return (
                    <div 
                        key={postIndex}
                        style={{
                            marginBottom: '24px',
                            paddingLeft: isReply ? '40px' : '0',
                            borderLeft: isReply ? '3px solid #ce9178' : 'none',
                            cursor: 'pointer',
                            padding: '12px',
                            borderRadius: '6px',
                            transition: 'background 0.2s'
                        }}
                        onClick={() => startEditing(currentThread.path[0], currentThread.path[1], postIndex)}
                        onMouseEnter={(e) => e.currentTarget.style.background = '#2d2d30'}
                        onMouseLeave={(e) => e.currentTarget.style.background = 'transparent'}
                        title="Click to edit"
                    >
                        {/* Quote (for replies) */}
                        {isReply && post.quote_user && (
                            <div style={{
                                background: '#2d2d30',
                                padding: '12px',
                                borderRadius: '4px',
                                marginBottom: '12px',
                                borderLeft: '3px solid #858585',
                                fontSize: '13px',
                                color: '#858585',
                                fontStyle: 'italic'
                            }}>
                                <div style={{fontWeight: 'bold', marginBottom: '4px'}}>
                                    {post.quote_user} wrote:
                                </div>
                                {post.quote_text}
                            </div>
                        )}

                        {/* Post header */}
                        <div style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: '12px',
                            marginBottom: '8px'
                        }}>
                            <div style={{
                                fontWeight: 'bold',
                                color: isAlert ? '#dcdcaa' : isReply ? '#ce9178' : '#9cdcfe',
                                fontSize: '15px'
                            }}>
                                {post.user_name}
                            </div>
                            {post.user_rank && (
                                <div style={{
                                    fontSize: '12px',
                                    color: '#858585',
                                    padding: '2px 8px',
                                    background: '#2d2d30',
                                    borderRadius: '3px'
                                }}>
                                    {post.user_rank}
                                </div>
                            )}
                            <div style={{fontSize: '12px', color: '#858585'}}>
                                Day {Math.floor(post.timestamp / 100)}
                            </div>
                        </div>

                        {/* Post body */}
                        <div style={{
                            color: '#d4d4d4',
                            lineHeight: '1.6',
                            fontSize: '14px',
                            whiteSpace: 'pre-wrap'
                        }}>
                            {post.body}
                        </div>

                        {/* Options (choices) */}
                        {post.options && post.options.length > 0 && (
                            <div style={{
                                marginTop: '16px',
                                padding: '16px',
                                background: '#2d3d2d',
                                borderRadius: '6px',
                                borderLeft: '4px solid #4ec9b0'
                            }}>
                                <div style={{
                                    fontWeight: 'bold',
                                    color: '#4ec9b0',
                                    marginBottom: '12px',
                                    fontSize: '13px'
                                }}>
                                    PLAYER CHOICES:
                                </div>
                                {post.options.map((option, optIndex) => (
                                    <div key={optIndex} style={{
                                        marginBottom: '12px',
                                        paddingLeft: '16px'
                                    }}>
                                        <div style={{
                                            color: '#dcdcaa',
                                            fontWeight: 'bold',
                                            marginBottom: '4px'
                                        }}>
                                            ▸ {option.text}
                                        </div>
                                        {option.reply_body && (
                                            <div style={{
                                                color: '#9cdcfe',
                                                fontSize: '13px',
                                                paddingLeft: '12px',
                                                fontStyle: 'italic'
                                            }}>
                                                → "{option.reply_body}"
                                            </div>
                                        )}
                                        {option.set_flag && (
                                            <div style={{
                                                fontSize: '11px',
                                                color: '#858585',
                                                paddingLeft: '12px',
                                                marginTop: '2px'
                                            }}>
                                                Sets: {option.set_flag}
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* Flags */}
                        {(post.conditions?.requires_flag || post.set_flag) && (
                            <div style={{
                                marginTop: '12px',
                                fontSize: '11px',
                                color: '#858585',
                                display: 'flex',
                                gap: '12px'
                            }}>
                                {post.conditions?.requires_flag && (
                                    <span>🔒 Requires: {post.conditions.requires_flag}</span>
                                )}
                                {post.set_flag && (
                                    <span>🏁 Sets: {post.set_flag}</span>
                                )}
                            </div>
                        )}
                    </div>
                );
            };

            return (
                <div style={{
                    display: 'flex',
                    flex: 1,
                    height: '100%',
                    overflow: 'hidden'
                }}>
                    {/* Thread selector sidebar */}
                    <div style={{
                        width: '280px',
                        flexShrink: 0,
                        borderRight: '1px solid #3e3e42',
                        overflowY: 'auto',
                        background: '#1e1e1e',
                        padding: '16px'
                    }}>
                        <h3 style={{
                            color: '#4ec9b0',
                            marginBottom: '16px',
                            fontSize: '16px'
                        }}>
                            Select Thread
                        </h3>
                        <div style={{display: 'flex', flexDirection: 'column', gap: '8px'}}>
                            {threads.map((thread, index) => (
                                <div
                                    key={index}
                                    onClick={() => setSelectedThread(thread)}
                                    style={{
                                        padding: '12px',
                                        background: currentThread === thread ? '#2d3d2d' : '#2d2d30',
                                        borderRadius: '4px',
                                        cursor: 'pointer',
                                        border: currentThread === thread ? '2px solid #4ec9b0' : '2px solid transparent',
                                        transition: 'all 0.2s'
                                    }}
                                    onMouseEnter={(e) => {
                                        if (currentThread !== thread) {
                                            e.target.style.background = '#3e3e42';
                                        }
                                    }}
                                    onMouseLeave={(e) => {
                                        if (currentThread !== thread) {
                                            e.target.style.background = '#2d2d30';
                                        }
                                    }}
                                >
                                    <div style={{
                                        fontSize: '13px',
                                        color: '#dcdcaa',
                                        fontWeight: 'bold',
                                        marginBottom: '4px'
                                    }}>
                                        {thread.title}
                                    </div>
                                    <div style={{
                                        fontSize: '11px',
                                        color: '#858585'
                                    }}>
                                        {thread.categoryTitle} • {thread.posts.length} posts
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Screenplay content */}
                    <div style={{
                        flex: 1,
                        overflowY: 'auto',
                        padding: '32px 48px'
                    }}>
                        {currentThread ? (
                            <>
                                {/* Thread header */}
                                <div style={{
                                    marginBottom: '32px',
                                    paddingBottom: '24px',
                                    borderBottom: '2px solid #3e3e42'
                                }}>
                                    <div style={{
                                        fontSize: '11px',
                                        color: '#858585',
                                        textTransform: 'uppercase',
                                        letterSpacing: '1px',
                                        marginBottom: '8px'
                                    }}>
                                        {currentThread.categoryTitle}
                                    </div>
                                    <h1 style={{
                                        fontSize: '28px',
                                        color: '#dcdcaa',
                                        marginBottom: '8px'
                                    }}>
                                        {currentThread.title}
                                    </h1>
                                    <div style={{
                                        fontSize: '14px',
                                        color: '#9cdcfe'
                                    }}>
                                        {currentThread.subtitle}
                                    </div>
                                    <div style={{
                                        marginTop: '16px',
                                        fontSize: '12px',
                                        color: '#858585'
                                    }}>
                                        {currentThread.posts.length} posts
                                        {currentThread.conditions?.min_day && ` • Available from Day ${currentThread.conditions.min_day}`}
                                        {currentThread.conditions?.requires_flag && ` • Requires: ${currentThread.conditions.requires_flag}`}
                                    </div>
                                </div>

                                {/* Posts */}
                                <div>
                                    {currentThread.posts.map((post, index) => renderPost(post, index))}
                                </div>

                                {currentThread.posts.length === 0 && (
                                    <div style={{
                                        padding: '40px',
                                        textAlign: 'center',
                                        color: '#858585'
                                    }}>
                                        This thread has no posts yet.
                                    </div>
                                )}
                            </>
                        ) : (
                            <div style={{
                                padding: '40px',
                                textAlign: 'center',
                                color: '#858585'
                            }}>
                                No threads available. Create some threads to view them here!
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function JSONPanel({ data, setData, showMessage }) {
            const [jsonText, setJsonText] = useState(JSON.stringify(data, null, 2));
            const [error, setError] = useState(null);

            useEffect(() => {
                setJsonText(JSON.stringify(data, null, 2));
            }, [data]);

            const handleApply = () => {
                try {
                    const parsed = JSON.parse(jsonText);
                    setData(parsed);
                    setError(null);
                    showMessage('JSON applied successfully', 'success');
                } catch (e) {
                    setError(e.message);
                    showMessage('Invalid JSON: ' + e.message, 'error');
                }
            };

            return (
                <div className="editor-panel">
                    <h2 style={{marginBottom: '16px'}}>JSON Editor</h2>
                    {error && <div className="error-message">{error}</div>}
                    <textarea 
                        className="json-editor"
                        value={jsonText}
                        onChange={(e) => setJsonText(e.target.value)}
                        spellCheck={false}
                    />
                    <button 
                        className="add-button" 
                        onClick={handleApply}
                        style={{marginTop: '16px'}}
                    >
                        Apply Changes
                    </button>
                </div>
            );
        }

        function UserLibraryPanel({ userLibrary, setUserLibrary, data }) {
            const [editingUser, setEditingUser] = useState(null);
            const [showCreateForm, setShowCreateForm] = useState(false);
            const [newUser, setNewUser] = useState({
                name: '',
                rank: '',
                avatar: '',
                bio: '',
                status: 'active'
            });

            // Auto-detect users from existing posts
            const detectUsersFromData = () => {
                const detectedUsers = new Map();
                
                data.forEach(cat => {
                    cat.threads.forEach(thread => {
                        thread.posts.forEach(post => {
                            if (post.user_name && !detectedUsers.has(post.user_name)) {
                                detectedUsers.set(post.user_name, {
                                    id: `user_${post.user_name.toLowerCase().replace(/\s+/g, '_')}`,
                                    name: post.user_name,
                                    rank: post.user_rank || '',
                                    avatar: post.avatar || '',
                                    bio: '',
                                    status: 'active',
                                    firstAppearance: null,
                                    postCount: 0
                                });
                            }
                            if (detectedUsers.has(post.user_name)) {
                                detectedUsers.get(post.user_name).postCount++;
                            }
                        });
                    });
                });

                return Array.from(detectedUsers.values());
            };

            const createUser = (userData) => {
                const newUser = {
                    id: userData.id || `user_${Date.now()}`,
                    name: userData.name,
                    rank: userData.rank || '',
                    avatar: userData.avatar || '',
                    bio: userData.bio || '',
                    status: userData.status || 'active',
                    createdAt: new Date().toISOString()
                };
                setUserLibrary([...userLibrary, newUser]);
                setShowCreateForm(false);
            };

            const updateUser = (userId, updates) => {
                setUserLibrary(userLibrary.map(u => 
                    u.id === userId ? {...u, ...updates} : u
                ));
            };

            const deleteUser = (userId) => {
                if (confirm('Delete this user from the library?')) {
                    setUserLibrary(userLibrary.filter(u => u.id !== userId));
                }
            };

            const importDetectedUsers = () => {
                const detected = detectUsersFromData();
                const newUsers = detected.filter(d => 
                    !userLibrary.some(u => u.name === d.name)
                );
                
                if (newUsers.length > 0) {
                    setUserLibrary([...userLibrary, ...newUsers]);
                    alert(`Imported ${newUsers.length} new users`);
                } else {
                    alert('No new users detected');
                }
            };

            return (
                <div>
                    <h3 style={{marginBottom: '16px', color: '#4ec9b0'}}>User Library</h3>
                    <p style={{color: '#858585', marginBottom: '20px', fontSize: '14px'}}>
                        Manage characters/users for quick selection when creating posts.
                    </p>

                    {/* Action buttons */}
                    <div style={{display: 'flex', gap: '12px', marginBottom: '20px'}}>
                        <button
                            onClick={() => setShowCreateForm(!showCreateForm)}
                            style={{
                                padding: '8px 16px',
                                background: '#0e639c',
                                border: 'none',
                                borderRadius: '4px',
                                color: 'white',
                                cursor: 'pointer',
                                fontSize: '14px'
                            }}
                        >
                            + Create New User
                        </button>
                        <button
                            onClick={importDetectedUsers}
                            style={{
                                padding: '8px 16px',
                                background: '#3e3e42',
                                border: 'none',
                                borderRadius: '4px',
                                color: 'white',
                                cursor: 'pointer',
                                fontSize: '14px'
                            }}
                        >
                            📥 Import from Posts
                        </button>
                    </div>

                    {/* Create form */}
                    {showCreateForm && (
                        <div style={{
                            background: '#2d2d30',
                            padding: '20px',
                            borderRadius: '6px',
                            marginBottom: '20px',
                            border: '1px solid #3e3e42'
                        }}>
                            <h4 style={{marginBottom: '16px', color: '#dcdcaa'}}>Create New User</h4>
                            <div style={{marginBottom: '12px'}}>
                                <label style={{display: 'block', marginBottom: '4px', fontSize: '13px'}}>Name *</label>
                                <input
                                                type="text"
                                                value={newUser.name}
                                                onChange={(e) => setNewUser({...newUser, name: e.target.value})}
                                                style={{width: '100%', padding: '8px', background: '#1e1e1e', border: '1px solid #3e3e42', color: 'white', borderRadius: '4px'}}
                                                placeholder="Character name"
                                            />
                                        </div>
                                        <div style={{marginBottom: '12px'}}>
                                            <label style={{display: 'block', marginBottom: '4px', fontSize: '13px'}}>Rank</label>
                                            <input
                                                type="text"
                                                value={newUser.rank}
                                                onChange={(e) => setNewUser({...newUser, rank: e.target.value})}
                                                style={{width: '100%', padding: '8px', background: '#1e1e1e', border: '1px solid #3e3e42', color: 'white', borderRadius: '4px'}}
                                                placeholder="e.g., Moderator, Newbie"
                                            />
                                        </div>
                                        <div style={{marginBottom: '12px'}}>
                                            <label style={{display: 'block', marginBottom: '4px', fontSize: '13px'}}>Avatar</label>
                                            <input
                                                type="text"
                                                value={newUser.avatar}
                                                onChange={(e) => setNewUser({...newUser, avatar: e.target.value})}
                                                style={{width: '100%', padding: '8px', background: '#1e1e1e', border: '1px solid #3e3e42', color: 'white', borderRadius: '4px'}}
                                                placeholder="spr_avatar_name"
                                            />
                                        </div>
                                        <div style={{marginBottom: '12px'}}>
                                            <label style={{display: 'block', marginBottom: '4px', fontSize: '13px'}}>Biography</label>
                                            <textarea
                                                value={newUser.bio}
                                                onChange={(e) => setNewUser({...newUser, bio: e.target.value})}
                                                style={{width: '100%', padding: '8px', background: '#1e1e1e', border: '1px solid #3e3e42', color: 'white', borderRadius: '4px', minHeight: '80px'}}
                                                placeholder="Background, personality, etc."
                                            />
                                        </div>
                                        <div style={{display: 'flex', gap: '8px'}}>
                                            <button
                                                onClick={() => {
                                                    if (newUser.name) {
                                                        createUser(newUser);
                                                        setNewUser({
                                                            name: '',
                                                            rank: '',
                                                            avatar: '',
                                                            bio: '',
                                                            status: 'active'
                                                        });
                                                    } else {
                                                        alert('Name is required');
                                                    }
                                                }}
                                                style={{
                                                    padding: '8px 16px',
                                                    background: '#0e639c',
                                                    border: 'none',
                                                    borderRadius: '4px',
                                                    color: 'white',
                                                    cursor: 'pointer'
                                                }}
                                            >
                                                Create
                                            </button>
                                            <button
                                                onClick={() => {
                                                    setShowCreateForm(false);
                                                    setNewUser({
                                                        name: '',
                                                        rank: '',
                                                        avatar: '',
                                                        bio: '',
                                                        status: 'active'
                                                    });
                                                }}
                                                style={{
                                                    padding: '8px 16px',
                                                    background: '#3e3e42',
                                                    border: 'none',
                                                    borderRadius: '4px',
                                                    color: 'white',
                                                    cursor: 'pointer'
                                                }}
                                            >
                                                Cancel
                                            </button>
                                        </div>
                        </div>
                    )}

                    {/* User list */}
                    <div style={{
                        display: 'grid',
                        gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))',
                        gap: '16px'
                    }}>
                        {userLibrary.map(user => {
                            const isEditing = editingUser === user.id;
                            
                            if (isEditing) {
                                // Edit mode
                                return (
                                    <div key={user.id} style={{
                                        background: '#2d3d2d',
                                        padding: '16px',
                                        borderRadius: '6px',
                                        border: '2px solid #0e639c'
                                    }}>
                                        <h4 style={{marginBottom: '12px', color: '#dcdcaa'}}>Edit User</h4>
                                        <div style={{marginBottom: '8px'}}>
                                            <label style={{display: 'block', fontSize: '11px', marginBottom: '4px'}}>Name</label>
                                            <input
                                                type="text"
                                                value={user.name}
                                                onChange={(e) => updateUser(user.id, { name: e.target.value })}
                                                style={{width: '100%', padding: '6px', background: '#1e1e1e', border: '1px solid #3e3e42', color: 'white', borderRadius: '3px', fontSize: '13px'}}
                                            />
                                        </div>
                                        <div style={{marginBottom: '8px'}}>
                                            <label style={{display: 'block', fontSize: '11px', marginBottom: '4px'}}>Rank</label>
                                            <input
                                                type="text"
                                                value={user.rank || ''}
                                                onChange={(e) => updateUser(user.id, { rank: e.target.value })}
                                                style={{width: '100%', padding: '6px', background: '#1e1e1e', border: '1px solid #3e3e42', color: 'white', borderRadius: '3px', fontSize: '13px'}}
                                            />
                                        </div>
                                        <div style={{marginBottom: '8px'}}>
                                            <label style={{display: 'block', fontSize: '11px', marginBottom: '4px'}}>Avatar</label>
                                            <input
                                                type="text"
                                                value={user.avatar || ''}
                                                onChange={(e) => updateUser(user.id, { avatar: e.target.value })}
                                                style={{width: '100%', padding: '6px', background: '#1e1e1e', border: '1px solid #3e3e42', color: 'white', borderRadius: '3px', fontSize: '13px'}}
                                            />
                                        </div>
                                        <div style={{marginBottom: '12px'}}>
                                            <label style={{display: 'block', fontSize: '11px', marginBottom: '4px'}}>Bio</label>
                                            <textarea
                                                value={user.bio || ''}
                                                onChange={(e) => updateUser(user.id, { bio: e.target.value })}
                                                style={{width: '100%', padding: '6px', background: '#1e1e1e', border: '1px solid #3e3e42', color: 'white', borderRadius: '3px', fontSize: '13px', minHeight: '60px'}}
                                            />
                                        </div>
                                        <button
                                            onClick={() => setEditingUser(null)}
                                            style={{
                                                padding: '6px 12px',
                                                background: '#0e639c',
                                                border: 'none',
                                                borderRadius: '4px',
                                                color: 'white',
                                                cursor: 'pointer',
                                                fontSize: '12px',
                                                width: '100%'
                                            }}
                                        >
                                            ✓ Done Editing
                                        </button>
                                    </div>
                                );
                            }
                            
                            // View mode
                            return (
                            <div key={user.id} style={{
                                background: '#2d2d30',
                                padding: '16px',
                                borderRadius: '6px',
                                border: user.status === 'inactive' ? '2px solid #858585' : '2px solid #3e3e42'
                            }}>
                                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '12px'}}>
                                    <div>
                                        <h4 style={{color: '#dcdcaa', marginBottom: '4px'}}>{user.name}</h4>
                                        {user.rank && <div style={{fontSize: '12px', color: '#9cdcfe'}}>{user.rank}</div>}
                                    </div>
                                    {user.status === 'inactive' && (
                                        <span style={{
                                            background: '#3e3e42',
                                            padding: '2px 8px',
                                            borderRadius: '3px',
                                            fontSize: '11px',
                                            color: '#858585'
                                        }}>
                                            Inactive
                                        </span>
                                    )}
                                </div>
                                
                                {user.avatar && (
                                    <div style={{
                                        fontSize: '11px',
                                        color: '#858585',
                                        fontFamily: 'monospace',
                                        marginBottom: '8px'
                                    }}>
                                        Avatar: {user.avatar}
                                    </div>
                                )}
                                
                                {user.bio && (
                                    <div style={{
                                        fontSize: '13px',
                                        color: '#d4d4d4',
                                        marginBottom: '12px',
                                        lineHeight: '1.4'
                                    }}>
                                        {user.bio.substring(0, 100)}{user.bio.length > 100 ? '...' : ''}
                                    </div>
                                )}
                                
                                <div style={{display: 'flex', gap: '8px', marginTop: '12px'}}>
                                    <button
                                        onClick={() => setEditingUser(user.id)}
                                        style={{
                                            padding: '6px 12px',
                                            background: '#0e639c',
                                            border: 'none',
                                            borderRadius: '4px',
                                            color: 'white',
                                            cursor: 'pointer',
                                            fontSize: '12px'
                                        }}
                                    >
                                        ✏️ Edit
                                    </button>
                                    <button
                                        onClick={() => {
                                            const newStatus = user.status === 'active' ? 'inactive' : 'active';
                                            updateUser(user.id, { status: newStatus });
                                        }}
                                        style={{
                                            padding: '6px 12px',
                                            background: '#3e3e42',
                                            border: 'none',
                                            borderRadius: '4px',
                                            color: 'white',
                                            cursor: 'pointer',
                                            fontSize: '12px'
                                        }}
                                    >
                                        {user.status === 'active' ? '🚫 Deactivate' : '✅ Activate'}
                                    </button>
                                    <button
                                        onClick={() => deleteUser(user.id)}
                                        style={{
                                            padding: '6px 12px',
                                            background: '#5a1e1e',
                                            border: 'none',
                                            borderRadius: '4px',
                                            color: 'white',
                                            cursor: 'pointer',
                                            fontSize: '12px'
                                        }}
                                    >
                                        🗑️
                                    </button>
                                </div>
                            </div>
                            );
                        })}
                    </div>

                    {userLibrary.length === 0 && (
                        <div style={{
                            padding: '40px',
                            textAlign: 'center',
                            color: '#858585'
                        }}>
                            No users in library. Create one or import from existing posts.
                        </div>
                    )}
                </div>
            );
        }

        function UtilitiesPanel({ data, getAllFlags, getAllUsers, setSelectedItem, setView, runValidation, searchAndReplace, bulkEdit, notes, setNotes, itemTags, setItemTags, userLibrary, setUserLibrary, snapshots, onCreateSnapshot, onRestoreSnapshot, onDeleteSnapshot }) {
            const [activeTab, setActiveTab] = useState('flags');
            const [validationIssues, setValidationIssues] = useState(null);
            const [searchText, setSearchText] = useState('');
            const [replaceText, setReplaceText] = useState('');
            const [searchScope, setSearchScope] = useState('all');
            const [timelineSortBy, setTimelineSortBy] = useState('day');
            const [advSearchType, setAdvSearchType] = useState('keyword');
            const [advSearchValue, setAdvSearchValue] = useState('');
            const [advSearchResults, setAdvSearchResults] = useState(null);
            const [bulkOperation, setBulkOperation] = useState('avatar');
            const [bulkFindValue, setBulkFindValue] = useState('');
            const [bulkReplaceValue, setBulkReplaceValue] = useState('');
            const [bulkPreview, setBulkPreview] = useState(null);
            const [uploadedAssets, setUploadedAssets] = useState({});
            const [selectedAsset, setSelectedAsset] = useState(null);
            const flags = getAllFlags();
            const users = getAllUsers();

            // Load uploaded assets from localStorage on mount
            useEffect(() => {
                try {
                    const saved = localStorage.getItem('narrative-editor-assets');
                    if (saved) {
                        setUploadedAssets(JSON.parse(saved));
                    }
                } catch (err) {
                    console.error('Failed to load assets:', err);
                }
            }, []);

            const handleRunValidation = () => {
                const issues = runValidation();
                setValidationIssues(issues);
                setActiveTab('validation');
            };

            return (
                <div className="editor-panel" style={{padding: '20px'}}>
                    <h2 style={{marginBottom: '20px'}}>Utilities & Analytics</h2>
                    
                    <div style={{display: 'flex', gap: '12px', marginBottom: '20px', flexWrap: 'wrap'}}>
                        <button 
                            onClick={() => setActiveTab('flags')} 
                            className={activeTab === 'flags' ? '' : 'secondary'}
                        >
                            Flags ({flags.size})
                        </button>
                        <button 
                            onClick={() => setActiveTab('users')} 
                            className={activeTab === 'users' ? '' : 'secondary'}
                        >
                            Users & Assets ({users.size})
                        </button>
                        <button 
                            onClick={handleRunValidation} 
                            className={activeTab === 'validation' ? '' : 'secondary'}
                            style={{background: '#0e639c'}}
                        >
                            🔍 Run Validation
                        </button>
                        <button 
                            onClick={() => setActiveTab('search')} 
                            className={activeTab === 'search' ? '' : 'secondary'}
                        >
                            🔎 Search & Replace
                        </button>
                        <button 
                            onClick={() => setActiveTab('timeline')} 
                            className={activeTab === 'timeline' ? '' : 'secondary'}
                        >
                            📅 Timeline
                        </button>
                        <button 
                            onClick={() => setActiveTab('playthrough')} 
                            className={activeTab === 'playthrough' ? '' : 'secondary'}
                        >
                            🎮 Playthrough
                        </button>
                        <button 
                            onClick={() => setActiveTab('bulkedit')} 
                            className={activeTab === 'bulkedit' ? '' : 'secondary'}
                        >
                            ✏️ Bulk Edit
                        </button>
                        <button 
                            onClick={() => setActiveTab('assetbrowser')} 
                            className={activeTab === 'assetbrowser' ? '' : 'secondary'}
                        >
                            🎨 Asset Browser
                        </button>
                        <button 
                            onClick={() => setActiveTab('userlibrary')} 
                            className={activeTab === 'userlibrary' ? '' : 'secondary'}
                        >
                            👥 User Library
                        </button>
                        <button 
                            onClick={() => setActiveTab('snapshots')} 
                            className={activeTab === 'snapshots' ? '' : 'secondary'}
                        >
                            📸 Snapshots
                        </button>
                    </div>

                    {activeTab === 'snapshots' && (
                        <div>
                            <h3 style={{marginBottom: '16px', color: '#4ec9b0'}}>Snapshots</h3>
                            <p style={{color: '#858585', marginBottom: '20px', fontSize: '14px'}}>
                                Save named versions of your narrative. Perfect for milestones, experiments, or backups.
                            </p>

                            {/* Create snapshot */}
                            <div style={{marginBottom: '20px'}}>
                                <button
                                    onClick={() => {
                                        const name = prompt('Enter snapshot name:');
                                        if (name) {
                                            onCreateSnapshot(name);
                                        }
                                    }}
                                    style={{
                                        padding: '10px 20px',
                                        background: '#0e639c',
                                        border: 'none',
                                        borderRadius: '4px',
                                        color: 'white',
                                        cursor: 'pointer',
                                        fontSize: '14px'
                                    }}
                                >
                                    📸 Create Snapshot
                                </button>
                            </div>

                            {/* Snapshot list */}
                            {snapshots.length === 0 ? (
                                <div style={{
                                    padding: '40px',
                                    textAlign: 'center',
                                    color: '#858585'
                                }}>
                                    No snapshots yet. Create one to save the current state!
                                </div>
                            ) : (
                                <div style={{display: 'flex', flexDirection: 'column', gap: '12px'}}>
                                    {snapshots.slice().reverse().map(snapshot => (
                                        <div key={snapshot.id} style={{
                                            background: '#2d2d30',
                                            padding: '16px',
                                            borderRadius: '6px',
                                            border: '1px solid #3e3e42'
                                        }}>
                                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '8px'}}>
                                                <div>
                                                    <h4 style={{color: '#dcdcaa', marginBottom: '4px'}}>{snapshot.name}</h4>
                                                    <div style={{fontSize: '12px', color: '#858585'}}>
                                                        {new Date(snapshot.timestamp).toLocaleString()}
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div style={{fontSize: '13px', color: '#9cdcfe', marginBottom: '12px'}}>
                                                {snapshot.data.length} categories, {snapshot.data.reduce((sum, cat) => sum + cat.threads.length, 0)} threads
                                            </div>
                                            
                                            <div style={{display: 'flex', gap: '8px'}}>
                                                <button
                                                    onClick={() => onRestoreSnapshot(snapshot.id)}
                                                    style={{
                                                        padding: '6px 12px',
                                                        background: '#0e639c',
                                                        border: 'none',
                                                        borderRadius: '4px',
                                                        color: 'white',
                                                        cursor: 'pointer',
                                                        fontSize: '12px'
                                                    }}
                                                >
                                                    ↶ Restore
                                                </button>
                                                <button
                                                    onClick={() => onDeleteSnapshot(snapshot.id)}
                                                    style={{
                                                        padding: '6px 12px',
                                                        background: '#5a1e1e',
                                                        border: 'none',
                                                        borderRadius: '4px',
                                                        color: 'white',
                                                        cursor: 'pointer',
                                                        fontSize: '12px'
                                                    }}
                                                >
                                                    🗑️ Delete
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}

                            {/* Info */}
                            <div style={{
                                marginTop: '24px',
                                padding: '16px',
                                background: '#2d3d2d',
                                borderRadius: '6px',
                                fontSize: '13px',
                                color: '#d4d4d4'
                            }}>
                                <strong style={{color: '#4ec9b0'}}>💡 About Snapshots:</strong>
                                <ul style={{marginTop: '8px', marginLeft: '20px', lineHeight: '1.6'}}>
                                    <li>Snapshots save your data, notes, and tags</li>
                                    <li>Use them before major changes or experiments</li>
                                    <li>Restoring adds current work to undo history</li>
                                    <li>Snapshots persist across sessions</li>
                                </ul>
                            </div>
                        </div>
                    )}

                    {activeTab === 'userlibrary' && (
                        <UserLibraryPanel 
                            userLibrary={userLibrary}
                            setUserLibrary={setUserLibrary}
                            data={data}
                        />
                    )}

                    {activeTab === 'assetbrowser' && (
                        <div>
                            <h3 style={{marginBottom: '16px', color: '#4ec9b0'}}>Asset Browser</h3>
                            <p style={{color: '#858585', marginBottom: '20px', fontSize: '14px'}}>
                                Visual gallery of all avatars and icons used in your narrative. Click to copy the sprite name.
                            </p>

                            {(() => {
                                // Collect all unique avatars and icons
                                const avatars = new Set();
                                const icons = new Set();
                                
                                data.forEach(cat => {
                                    if (cat.icon) icons.add(cat.icon);
                                    cat.threads.forEach(thread => {
                                        if (thread.icon) icons.add(thread.icon);
                                        thread.posts.forEach(post => {
                                            if (post.avatar) avatars.add(post.avatar);
                                        });
                                    });
                                });

                                const handleImageUpload = (assetName, file) => {
                                    const reader = new FileReader();
                                    reader.onload = (e) => {
                                        setUploadedAssets(prev => ({
                                            ...prev,
                                            [assetName]: e.target.result
                                        }));
                                        // Save to localStorage
                                        try {
                                            const saved = JSON.parse(localStorage.getItem('narrative-editor-assets') || '{}');
                                            saved[assetName] = e.target.result;
                                            localStorage.setItem('narrative-editor-assets', JSON.stringify(saved));
                                        } catch (err) {
                                            console.error('Failed to save asset:', err);
                                        }
                                    };
                                    reader.readAsDataURL(file);
                                };

                                const copyToClipboard = (text) => {
                                    navigator.clipboard.writeText(text).then(() => {
                                        alert(`Copied "${text}" to clipboard!`);
                                    });
                                };

                                return (
                                    <div>
                                        {/* Avatars Section */}
                                        <div className="form-section" style={{marginBottom: '24px'}}>
                                            <h4 style={{color: '#9cdcfe', marginBottom: '12px', fontSize: '16px'}}>
                                                🎭 Avatars ({avatars.size})
                                            </h4>
                                            {avatars.size === 0 ? (
                                                <p style={{color: '#858585'}}>No avatars defined yet</p>
                                            ) : (
                                                <div style={{
                                                    display: 'grid',
                                                    gridTemplateColumns: 'repeat(auto-fill, minmax(140px, 1fr))',
                                                    gap: '12px'
                                                }}>
                                                    {Array.from(avatars).sort().map(avatar => (
                                                        <div 
                                                            key={avatar}
                                                            style={{
                                                                background: '#2d2d30',
                                                                borderRadius: '6px',
                                                                padding: '12px',
                                                                cursor: 'pointer',
                                                                border: selectedAsset === avatar ? '2px solid #0e639c' : '2px solid transparent',
                                                                transition: 'all 0.2s'
                                                            }}
                                                            onClick={() => setSelectedAsset(avatar)}
                                                        >
                                                            {/* Image placeholder */}
                                                            <div style={{
                                                                width: '100%',
                                                                height: '100px',
                                                                background: uploadedAssets[avatar] ? `url(${uploadedAssets[avatar]}) center/contain no-repeat` : '#3e3e42',
                                                                borderRadius: '4px',
                                                                marginBottom: '8px',
                                                                display: 'flex',
                                                                alignItems: 'center',
                                                                justifyContent: 'center',
                                                                fontSize: '40px',
                                                                border: '1px solid #505050'
                                                            }}>
                                                                {!uploadedAssets[avatar] && '🎭'}
                                                            </div>
                                                            
                                                            {/* Asset name */}
                                                            <div style={{
                                                                fontSize: '11px',
                                                                color: '#d4d4d4',
                                                                fontFamily: 'monospace',
                                                                wordBreak: 'break-all',
                                                                marginBottom: '8px',
                                                                textAlign: 'center'
                                                            }}>
                                                                {avatar}
                                                            </div>

                                                            {/* Action buttons */}
                                                            <div style={{display: 'flex', gap: '4px', flexDirection: 'column'}}>
                                                                <button
                                                                    onClick={(e) => {
                                                                        e.stopPropagation();
                                                                        copyToClipboard(avatar);
                                                                    }}
                                                                    style={{
                                                                        padding: '4px 8px',
                                                                        fontSize: '11px',
                                                                        background: '#0e639c',
                                                                        border: 'none',
                                                                        borderRadius: '3px',
                                                                        color: 'white',
                                                                        cursor: 'pointer'
                                                                    }}
                                                                >
                                                                    📋 Copy Name
                                                                </button>
                                                                <label style={{
                                                                    padding: '4px 8px',
                                                                    fontSize: '11px',
                                                                    background: '#3e3e42',
                                                                    border: 'none',
                                                                    borderRadius: '3px',
                                                                    color: 'white',
                                                                    cursor: 'pointer',
                                                                    textAlign: 'center'
                                                                }}>
                                                                    📁 Upload
                                                                    <input
                                                                        type="file"
                                                                        accept="image/*"
                                                                        style={{display: 'none'}}
                                                                        onChange={(e) => {
                                                                            if (e.target.files[0]) {
                                                                                handleImageUpload(avatar, e.target.files[0]);
                                                                            }
                                                                        }}
                                                                    />
                                                                </label>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>

                                        {/* Icons Section */}
                                        <div className="form-section">
                                            <h4 style={{color: '#9cdcfe', marginBottom: '12px', fontSize: '16px'}}>
                                                🎨 Icons ({icons.size})
                                            </h4>
                                            {icons.size === 0 ? (
                                                <p style={{color: '#858585'}}>No icons defined yet</p>
                                            ) : (
                                                <div style={{
                                                    display: 'grid',
                                                    gridTemplateColumns: 'repeat(auto-fill, minmax(140px, 1fr))',
                                                    gap: '12px'
                                                }}>
                                                    {Array.from(icons).sort().map(icon => (
                                                        <div 
                                                            key={icon}
                                                            style={{
                                                                background: '#2d2d30',
                                                                borderRadius: '6px',
                                                                padding: '12px',
                                                                cursor: 'pointer',
                                                                border: selectedAsset === icon ? '2px solid #0e639c' : '2px solid transparent',
                                                                transition: 'all 0.2s'
                                                            }}
                                                            onClick={() => setSelectedAsset(icon)}
                                                        >
                                                            {/* Image placeholder */}
                                                            <div style={{
                                                                width: '100%',
                                                                height: '80px',
                                                                background: uploadedAssets[icon] ? `url(${uploadedAssets[icon]}) center/contain no-repeat` : '#3e3e42',
                                                                borderRadius: '4px',
                                                                marginBottom: '8px',
                                                                display: 'flex',
                                                                alignItems: 'center',
                                                                justifyContent: 'center',
                                                                fontSize: '32px',
                                                                border: '1px solid #505050'
                                                            }}>
                                                                {!uploadedAssets[icon] && '🎨'}
                                                            </div>
                                                            
                                                            {/* Asset name */}
                                                            <div style={{
                                                                fontSize: '11px',
                                                                color: '#d4d4d4',
                                                                fontFamily: 'monospace',
                                                                wordBreak: 'break-all',
                                                                marginBottom: '8px',
                                                                textAlign: 'center'
                                                            }}>
                                                                {icon}
                                                            </div>

                                                            {/* Action buttons */}
                                                            <div style={{display: 'flex', gap: '4px', flexDirection: 'column'}}>
                                                                <button
                                                                    onClick={(e) => {
                                                                        e.stopPropagation();
                                                                        copyToClipboard(icon);
                                                                    }}
                                                                    style={{
                                                                        padding: '4px 8px',
                                                                        fontSize: '11px',
                                                                        background: '#0e639c',
                                                                        border: 'none',
                                                                        borderRadius: '3px',
                                                                        color: 'white',
                                                                        cursor: 'pointer'
                                                                    }}
                                                                >
                                                                    📋 Copy Name
                                                                </button>
                                                                <label style={{
                                                                    padding: '4px 8px',
                                                                    fontSize: '11px',
                                                                    background: '#3e3e42',
                                                                    border: 'none',
                                                                    borderRadius: '3px',
                                                                    color: 'white',
                                                                    cursor: 'pointer',
                                                                    textAlign: 'center'
                                                                }}>
                                                                    📁 Upload
                                                                    <input
                                                                        type="file"
                                                                        accept="image/*"
                                                                        style={{display: 'none'}}
                                                                        onChange={(e) => {
                                                                            if (e.target.files[0]) {
                                                                                handleImageUpload(icon, e.target.files[0]);
                                                                            }
                                                                        }}
                                                                    />
                                                                </label>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>

                                        {/* Info section */}
                                        <div style={{
                                            marginTop: '24px',
                                            padding: '16px',
                                            background: '#2d3d2d',
                                            borderRadius: '6px',
                                            fontSize: '13px',
                                            color: '#d4d4d4'
                                        }}>
                                            <strong style={{color: '#4ec9b0'}}>💡 How to use:</strong>
                                            <ul style={{marginTop: '8px', marginLeft: '20px', lineHeight: '1.6'}}>
                                                <li>Click "📋 Copy Name" to copy the sprite name to clipboard</li>
                                                <li>Click "📁 Upload" to upload a reference image for each asset</li>
                                                <li>Images are stored in browser localStorage (not exported with JSON)</li>
                                                <li>Use the copied names when setting avatars and icons in your game</li>
                                            </ul>
                                        </div>
                                    </div>
                                );
                            })()}
                        </div>
                    )}

                    {activeTab === 'bulkedit' && (
                        <div>
                            <h3 style={{marginBottom: '16px', color: '#4ec9b0'}}>Bulk Operations</h3>
                            <p style={{color: '#858585', marginBottom: '20px', fontSize: '14px'}}>
                                Change avatars, icons, flags, or other properties across multiple posts at once
                            </p>

                            <div className="form-section">
                                <div className="form-group">
                                    <label>Operation Type</label>
                                    <select 
                                        value={bulkOperation}
                                        onChange={(e) => {
                                            setBulkOperation(e.target.value);
                                            setBulkPreview(null);
                                        }}
                                        style={{
                                            width: '100%',
                                            padding: '8px',
                                            background: '#3c3c3c',
                                            border: '1px solid #3e3e42',
                                            color: '#d4d4d4',
                                            borderRadius: '4px'
                                        }}
                                    >
                                        <option value="avatar">Replace Avatar</option>
                                        <option value="user_rank">Replace User Rank</option>
                                        <option value="thread_icon">Replace Thread Icon</option>
                                        <option value="category_icon">Replace Category Icon</option>
                                        <option value="flag_rename_set">Rename Flag (in options that set it)</option>
                                        <option value="flag_rename_require">Rename Flag (in conditions that require it)</option>
                                    </select>
                                </div>

                                <div className="form-group">
                                    <label>Find</label>
                                    <input
                                        type="text"
                                        value={bulkFindValue}
                                        onChange={(e) => {
                                            setBulkFindValue(e.target.value);
                                            setBulkPreview(null);
                                        }}
                                        placeholder="Current value to find..."
                                        style={{
                                            width: '100%',
                                            padding: '8px',
                                            background: '#3c3c3c',
                                            border: '1px solid #3e3e42',
                                            color: '#d4d4d4',
                                            borderRadius: '4px'
                                        }}
                                    />
                                </div>

                                <div className="form-group">
                                    <label>Replace With</label>
                                    <input
                                        type="text"
                                        value={bulkReplaceValue}
                                        onChange={(e) => setBulkReplaceValue(e.target.value)}
                                        placeholder="New value..."
                                        style={{
                                            width: '100%',
                                            padding: '8px',
                                            background: '#3c3c3c',
                                            border: '1px solid #3e3e42',
                                            color: '#d4d4d4',
                                            borderRadius: '4px'
                                        }}
                                    />
                                </div>

                                <button
                                    onClick={() => {
                                        const affected = [];
                                        data.forEach((cat, catIdx) => {
                                            // Check category icons
                                            if (bulkOperation === 'category_icon' && cat.icon === bulkFindValue) {
                                                affected.push({
                                                    path: [catIdx],
                                                    category: cat.title,
                                                    thread: '',
                                                    itemType: 'category',
                                                    currentValue: cat.icon
                                                });
                                            }
                                            
                                            cat.threads.forEach((thread, threadIdx) => {
                                                // Check thread icons
                                                if (bulkOperation === 'thread_icon' && thread.icon === bulkFindValue) {
                                                    affected.push({
                                                        path: [catIdx, threadIdx],
                                                        category: cat.title,
                                                        thread: thread.title,
                                                        itemType: 'thread',
                                                        currentValue: thread.icon
                                                    });
                                                }
                                                
                                                // Check thread flag requirements
                                                if (bulkOperation === 'flag_rename_require' && thread.conditions?.requires_flag === bulkFindValue) {
                                                    affected.push({
                                                        path: [catIdx, threadIdx],
                                                        category: cat.title,
                                                        thread: thread.title,
                                                        itemType: 'thread',
                                                        currentValue: `Requires: ${bulkFindValue}`
                                                    });
                                                }
                                                
                                                thread.posts.forEach((post, postIdx) => {
                                                    let matches = false;
                                                    let currentValue = '';
                                                    
                                                    if (bulkOperation === 'avatar' && post.avatar === bulkFindValue) {
                                                        matches = true;
                                                        currentValue = post.avatar;
                                                    } else if (bulkOperation === 'user_rank' && post.user_rank === bulkFindValue) {
                                                        matches = true;
                                                        currentValue = post.user_rank;
                                                    } else if (bulkOperation === 'flag_rename_set') {
                                                        // Check if any option sets this flag
                                                        if (post.options?.some(opt => opt.set_flag === bulkFindValue)) {
                                                            matches = true;
                                                            currentValue = `Sets: ${bulkFindValue}`;
                                                        }
                                                    } else if (bulkOperation === 'flag_rename_require') {
                                                        // Check if post requires this flag
                                                        if (post.conditions?.requires_flag === bulkFindValue) {
                                                            matches = true;
                                                            currentValue = `Requires: ${bulkFindValue}`;
                                                        }
                                                    }
                                                    
                                                    if (matches) {
                                                        affected.push({
                                                            path: [catIdx, threadIdx, postIdx],
                                                            category: cat.title,
                                                            thread: thread.title,
                                                            post: post,
                                                            itemType: 'post',
                                                            currentValue
                                                        });
                                                    }
                                                });
                                            });
                                        });
                                        setBulkPreview(affected);
                                    }}
                                    disabled={!bulkFindValue}
                                    style={{
                                        padding: '10px 20px',
                                        background: bulkFindValue ? '#0e639c' : '#3e3e42',
                                        border: 'none',
                                        borderRadius: '4px',
                                        color: bulkFindValue ? '#fff' : '#858585',
                                        cursor: bulkFindValue ? 'pointer' : 'not-allowed',
                                        fontWeight: 'bold'
                                    }}
                                >
                                    🔍 Preview Changes
                                </button>
                            </div>

                            {bulkPreview !== null && (
                                <div style={{marginTop: '20px'}}>
                                    {bulkPreview.length === 0 ? (
                                        <p style={{color: '#858585'}}>No matches found</p>
                                    ) : (
                                        <div>
                                            <p style={{color: '#4ec9b0', marginBottom: '12px'}}>Found {bulkPreview.length} items</p>
                                            {bulkReplaceValue && (
                                                <button
                                                    onClick={() => {
                                                        // For flag operations, we need custom logic
                                                        if (bulkOperation === 'flag_rename_set' || bulkOperation === 'flag_rename_require') {
                                                            const newData = JSON.parse(JSON.stringify(data));
                                                            
                                                            bulkPreview.forEach(item => {
                                                                const [catIdx, threadIdx, postIdx] = item.path;
                                                                
                                                                if (bulkOperation === 'flag_rename_set' && postIdx !== undefined) {
                                                                    // Rename flag in options
                                                                    const post = newData[catIdx].threads[threadIdx].posts[postIdx];
                                                                    if (post.options) {
                                                                        post.options.forEach(opt => {
                                                                            if (opt.set_flag === bulkFindValue) {
                                                                                opt.set_flag = bulkReplaceValue;
                                                                            }
                                                                        });
                                                                    }
                                                                } else if (bulkOperation === 'flag_rename_require') {
                                                                    // Rename flag in conditions
                                                                    if (postIdx !== undefined) {
                                                                        const post = newData[catIdx].threads[threadIdx].posts[postIdx];
                                                                        if (post.conditions?.requires_flag === bulkFindValue) {
                                                                            post.conditions.requires_flag = bulkReplaceValue;
                                                                        }
                                                                    } else if (threadIdx !== undefined) {
                                                                        const thread = newData[catIdx].threads[threadIdx];
                                                                        if (thread.conditions?.requires_flag === bulkFindValue) {
                                                                            thread.conditions.requires_flag = bulkReplaceValue;
                                                                        }
                                                                    }
                                                                }
                                                            });
                                                            
                                                            setData(newData);
                                                            showMessage(`Renamed flag in ${bulkPreview.length} location(s)`, 'success');
                                                        } else {
                                                            // For simple field replacements, use the standard bulkEdit
                                                            let updates = {};
                                                            if (bulkOperation === 'avatar') {
                                                                updates = { avatar: bulkReplaceValue };
                                                            } else if (bulkOperation === 'user_rank') {
                                                                updates = { user_rank: bulkReplaceValue };
                                                            } else if (bulkOperation === 'thread_icon') {
                                                                updates = { icon: bulkReplaceValue };
                                                            } else if (bulkOperation === 'category_icon') {
                                                                updates = { icon: bulkReplaceValue };
                                                            }
                                                            
                                                            const paths = bulkPreview.map(item => item.path);
                                                            bulkEdit(paths, updates);
                                                        }
                                                        
                                                        setBulkPreview(null);
                                                        setBulkFindValue('');
                                                        setBulkReplaceValue('');
                                                    }}
                                                    style={{
                                                        padding: '10px 20px',
                                                        background: '#569cd6',
                                                        border: 'none',
                                                        borderRadius: '4px',
                                                        color: '#fff',
                                                        cursor: 'pointer',
                                                        fontWeight: 'bold',
                                                        marginBottom: '12px'
                                                    }}
                                                >
                                                    ✏️ Apply Changes
                                                </button>
                                            )}
                                            
                                            {/* Show the list of items */}
                                            <div style={{display: 'flex', flexDirection: 'column', gap: '8px', maxHeight: '400px', overflowY: 'auto'}}>
                                                {bulkPreview.map((item, idx) => (
                                                    <div 
                                                        key={idx}
                                                        className="form-section"
                                                        style={{
                                                            borderLeft: '4px solid #569cd6',
                                                            cursor: 'pointer'
                                                        }}
                                                        onClick={() => {
                                                            if (item.itemType === 'category') {
                                                                setSelectedItem({ type: 'category', path: item.path });
                                                            } else if (item.itemType === 'thread') {
                                                                setSelectedItem({ type: 'thread', path: item.path });
                                                            } else {
                                                                setSelectedItem({ type: 'post', path: item.path });
                                                            }
                                                            setView('tree');
                                                        }}
                                                    >
                                                        <div style={{fontSize: '12px', color: '#4ec9b0', marginBottom: '4px'}}>
                                                            {item.itemType === 'category' ? `📁 ${item.category}` : 
                                                             item.itemType === 'thread' ? `💬 ${item.category} → ${item.thread}` :
                                                             `${item.category} → ${item.thread}`}
                                                        </div>
                                                        {item.post && (
                                                            <div style={{fontSize: '13px', color: '#9cdcfe', marginBottom: '4px'}}>
                                                                <strong>{item.post.user_name}</strong>
                                                            </div>
                                                        )}
                                                        <div style={{fontSize: '12px', color: '#858585'}}>
                                                            Current: {item.currentValue}
                                                        </div>
                                                        {bulkReplaceValue && (
                                                            <div style={{fontSize: '12px', color: '#4ec9b0', marginTop: '4px'}}>
                                                                → New: {bulkOperation.includes('flag') ? `${bulkOperation.includes('set') ? 'Sets' : 'Requires'}: ${bulkReplaceValue}` : bulkReplaceValue}
                                                            </div>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    )}

                    {activeTab === 'search' && (
                        <div>
                            <h3 style={{marginBottom: '16px', color: '#4ec9b0'}}>Search & Replace</h3>
                            <p style={{color: '#858585', marginBottom: '20px', fontSize: '14px'}}>
                                Find content by flags, avatars, users, or keywords - optionally replace text
                            </p>

                            <div className="form-section">
                                <div className="form-group">
                                    <label>Search Type</label>
                                    <select 
                                        value={advSearchType}
                                        onChange={(e) => {
                                            setAdvSearchType(e.target.value);
                                            setAdvSearchResults(null);
                                        }}
                                        style={{
                                            width: '100%',
                                            padding: '8px',
                                            background: '#3c3c3c',
                                            border: '1px solid #3e3e42',
                                            color: '#d4d4d4',
                                            borderRadius: '4px'
                                        }}
                                    >
                                        <option value="keyword">Keyword (body, user, thread title)</option>
                                        <option value="text_replace">Text Replace (body text only)</option>
                                        <option value="flag_sets">Flag Sets (options that set a flag)</option>
                                        <option value="flag_requires">Flag Required (conditions)</option>
                                        <option value="avatar">Avatar</option>
                                        <option value="user">User Name</option>
                                    </select>
                                </div>

                                <div className="form-group">
                                    <label>Search Value</label>
                                    <input
                                        type="text"
                                        value={advSearchValue}
                                        onChange={(e) => setAdvSearchValue(e.target.value)}
                                        onKeyDown={(e) => {
                                            if (e.key === 'Enter') {
                                                // Perform search
                                                const results = [];
                                                data.forEach((cat, catIdx) => {
                                                    cat.threads.forEach((thread, threadIdx) => {
                                                        thread.posts.forEach((post, postIdx) => {
                                                            let matches = false;
                                                            let matchReason = '';

                                                            if (advSearchType === 'keyword' || advSearchType === 'text_replace') {
                                                                const searchLower = advSearchValue.toLowerCase();
                                                                if (post.body?.toLowerCase().includes(searchLower) ||
                                                                    (advSearchType === 'keyword' && (post.user_name?.toLowerCase().includes(searchLower) ||
                                                                    thread.title?.toLowerCase().includes(searchLower)))) {
                                                                    matches = true;
                                                                    matchReason = 'Contains keyword';
                                                                }
                                                            } else if (advSearchType === 'flag_sets') {
                                                                if (post.options?.some(opt => opt.set_flag === advSearchValue)) {
                                                                    matches = true;
                                                                    matchReason = `Sets flag: ${advSearchValue}`;
                                                                }
                                                            } else if (advSearchType === 'flag_requires') {
                                                                if (post.conditions?.requires_flag === advSearchValue || 
                                                                    thread.conditions?.requires_flag === advSearchValue) {
                                                                    matches = true;
                                                                    matchReason = `Requires flag: ${advSearchValue}`;
                                                                }
                                                            } else if (advSearchType === 'avatar') {
                                                                if (post.avatar === advSearchValue) {
                                                                    matches = true;
                                                                    matchReason = `Uses avatar: ${advSearchValue}`;
                                                                }
                                                            } else if (advSearchType === 'user') {
                                                                if (post.user_name === advSearchValue) {
                                                                    matches = true;
                                                                    matchReason = `Posted by: ${advSearchValue}`;
                                                                }
                                                            }

                                                            if (matches) {
                                                                results.push({
                                                                    category: cat.title,
                                                                    thread: thread.title,
                                                                    post: post,
                                                                    path: [catIdx, threadIdx, postIdx],
                                                                    matchReason
                                                                });
                                                            }
                                                        });
                                                    });
                                                });
                                                setAdvSearchResults(results);
                                            }
                                        }}
                                        placeholder={
                                            advSearchType === 'keyword' || advSearchType === 'text_replace' ? 'Enter text to search for...' :
                                            advSearchType.includes('flag') ? 'Enter flag name...' :
                                            advSearchType === 'avatar' ? 'Enter avatar name...' :
                                            'Enter user name...'
                                        }
                                        style={{
                                            width: '100%',
                                            padding: '8px',
                                            background: '#3c3c3c',
                                            border: '1px solid #3e3e42',
                                            color: '#d4d4d4',
                                            borderRadius: '4px'
                                        }}
                                    />
                                </div>

                                {advSearchType === 'text_replace' && (
                                    <div className="form-group">
                                        <label>Replace With</label>
                                        <input
                                            type="text"
                                            value={replaceText}
                                            onChange={(e) => setReplaceText(e.target.value)}
                                            placeholder="New text (leave empty to just search)"
                                            style={{
                                                width: '100%',
                                                padding: '8px',
                                                background: '#3c3c3c',
                                                border: '1px solid #3e3e42',
                                                color: '#d4d4d4',
                                                borderRadius: '4px'
                                            }}
                                        />
                                    </div>
                                )}

                                <div style={{display: 'flex', gap: '8px'}}>
                                    <button
                                        onClick={() => {
                                            const results = [];
                                            data.forEach((cat, catIdx) => {
                                                cat.threads.forEach((thread, threadIdx) => {
                                                    thread.posts.forEach((post, postIdx) => {
                                                        let matches = false;
                                                        let matchReason = '';

                                                        if (advSearchType === 'keyword' || advSearchType === 'text_replace') {
                                                            const searchLower = advSearchValue.toLowerCase();
                                                            if (post.body?.toLowerCase().includes(searchLower) ||
                                                                (advSearchType === 'keyword' && (post.user_name?.toLowerCase().includes(searchLower) ||
                                                                thread.title?.toLowerCase().includes(searchLower)))) {
                                                                matches = true;
                                                                matchReason = 'Contains keyword';
                                                            }
                                                        } else if (advSearchType === 'flag_sets') {
                                                            if (post.options?.some(opt => opt.set_flag === advSearchValue)) {
                                                                matches = true;
                                                                matchReason = `Sets flag: ${advSearchValue}`;
                                                            }
                                                        } else if (advSearchType === 'flag_requires') {
                                                            if (post.conditions?.requires_flag === advSearchValue || 
                                                                thread.conditions?.requires_flag === advSearchValue) {
                                                                matches = true;
                                                                matchReason = `Requires flag: ${advSearchValue}`;
                                                            }
                                                        } else if (advSearchType === 'avatar') {
                                                            if (post.avatar === advSearchValue) {
                                                                matches = true;
                                                                matchReason = `Uses avatar: ${advSearchValue}`;
                                                            }
                                                        } else if (advSearchType === 'user') {
                                                            if (post.user_name === advSearchValue) {
                                                                matches = true;
                                                                matchReason = `Posted by: ${advSearchValue}`;
                                                            }
                                                        }

                                                        if (matches) {
                                                            results.push({
                                                                category: cat.title,
                                                                thread: thread.title,
                                                                post: post,
                                                                path: [catIdx, threadIdx, postIdx],
                                                                matchReason
                                                            });
                                                        }
                                                    });
                                                });
                                            });
                                            setAdvSearchResults(results);
                                        }}
                                        disabled={!advSearchValue}
                                        style={{
                                            padding: '10px 20px',
                                            background: advSearchValue ? '#0e639c' : '#3e3e42',
                                            border: 'none',
                                            borderRadius: '4px',
                                            color: advSearchValue ? '#fff' : '#858585',
                                            cursor: advSearchValue ? 'pointer' : 'not-allowed',
                                            fontWeight: 'bold'
                                        }}
                                    >
                                        🔎 Search
                                    </button>

                                    {advSearchType === 'text_replace' && replaceText && advSearchResults && advSearchResults.length > 0 && (
                                        <button
                                            onClick={() => {
                                                searchAndReplace(advSearchValue, replaceText, 'body');
                                                setAdvSearchResults(null);
                                                setAdvSearchValue('');
                                                setReplaceText('');
                                            }}
                                            style={{
                                                padding: '10px 20px',
                                                background: '#569cd6',
                                                border: 'none',
                                                borderRadius: '4px',
                                                color: '#fff',
                                                cursor: 'pointer',
                                                fontWeight: 'bold'
                                            }}
                                        >
                                            ✏️ Replace All ({advSearchResults.length})
                                        </button>
                                    )}
                                </div>
                            </div>

                            {advSearchResults !== null && (
                                <div style={{marginTop: '20px'}}>
                                    <div style={{padding: '12px', background: '#2d2d30', borderRadius: '6px', marginBottom: '16px'}}>
                                        <strong>Found {advSearchResults.length} result{advSearchResults.length !== 1 ? 's' : ''}</strong>
                                    </div>

                                    {advSearchResults.length === 0 ? (
                                        <div style={{padding: '40px', textAlign: 'center', color: '#858585'}}>
                                            No results found
                                        </div>
                                    ) : (
                                        <div style={{display: 'flex', flexDirection: 'column', gap: '12px'}}>
                                            {advSearchResults.map((result, idx) => (
                                                <div 
                                                    key={idx} 
                                                    className="form-section" 
                                                    style={{
                                                        borderLeft: '4px solid #569cd6',
                                                        cursor: 'pointer'
                                                    }}
                                                    onClick={() => {
                                                        setSelectedItem({
                                                            type: 'post',
                                                            path: result.path
                                                        });
                                                        setView('tree');
                                                    }}
                                                >
                                                    <div style={{marginBottom: '8px'}}>
                                                        <span style={{
                                                            background: '#4ec9b0',
                                                            color: '#1e1e1e',
                                                            padding: '2px 8px',
                                                            borderRadius: '3px',
                                                            fontSize: '11px',
                                                            fontWeight: 'bold',
                                                            marginRight: '8px'
                                                        }}>
                                                            {result.matchReason}
                                                        </span>
                                                    </div>
                                                    <div style={{fontSize: '13px', color: '#4ec9b0', marginBottom: '4px'}}>
                                                        {result.category} → {result.thread}
                                                    </div>
                                                    <div style={{fontSize: '14px', color: '#9cdcfe', marginBottom: '4px'}}>
                                                        <strong>{result.post.user_name}</strong>
                                                    </div>
                                                    <div style={{fontSize: '13px', color: '#d4d4d4'}}>
                                                        {result.post.body.substring(0, 100)}{result.post.body.length > 100 ? '...' : ''}
                                                    </div>
                                                    {itemTags[result.post.id] && itemTags[result.post.id].length > 0 && (
                                                        <div style={{marginTop: '8px', display: 'flex', gap: '4px', flexWrap: 'wrap'}}>
                                                            {itemTags[result.post.id].map((tag, tidx) => (
                                                                <span key={tidx} style={{
                                                                    background: '#dcdcaa',
                                                                    color: '#1e1e1e',
                                                                    padding: '2px 6px',
                                                                    borderRadius: '8px',
                                                                    fontSize: '10px'
                                                                }}>
                                                                    {tag}
                                                                </span>
                                                            ))}
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    )}

                    {activeTab === 'playthrough' && (
                        <div>
                            <h3 style={{marginBottom: '16px', color: '#4ec9b0'}}>Story Path Generator</h3>
                            <p style={{color: '#858585', marginBottom: '20px', fontSize: '14px'}}>
                                This feature generates all possible story paths but is complex with large datasets.
                            </p>
                            <div style={{padding: '20px', background: '#2d2d30', borderRadius: '6px', marginBottom: '16px'}}>
                                <h4 style={{margin: '0 0 12px 0', color: '#dcdcaa'}}>💡 Recommended Alternatives</h4>
                                <ul style={{margin: 0, paddingLeft: '20px', lineHeight: '1.8'}}>
                                    <li><strong>Preview</strong> - Interactively play through your narrative with full control</li>
                                    <li><strong>Validation</strong> - Analyze structure, find dead ends, and check dependencies</li>
                                    <li><strong>Timeline</strong> - See when content unlocks day-by-day</li>
                                </ul>
                            </div>
                        </div>
                    )}

                    {activeTab === 'timeline' && (
                        <div>
                            <h3 style={{marginBottom: '16px', color: '#4ec9b0'}}>Content Timeline</h3>
                            <p style={{color: '#858585', marginBottom: '16px', fontSize: '14px'}}>
                                Shows when content becomes available based on day and flag requirements
                            </p>

                            {(() => {
                                // Build timeline data
                                const timelineItems = [];
                                
                                data.forEach((cat, catIdx) => {
                                    cat.threads.forEach((thread, threadIdx) => {
                                        // Thread unlocks
                                        if (thread.conditions?.min_day !== undefined) {
                                            timelineItems.push({
                                                type: 'thread',
                                                day: thread.conditions.min_day,
                                                category: cat.title,
                                                thread: thread.title,
                                                flag: thread.conditions?.requires_flag,
                                                user: null
                                            });
                                        }

                                        // Post unlocks
                                        thread.posts.forEach((post, postIdx) => {
                                            if (post.conditions?.min_day !== undefined) {
                                                timelineItems.push({
                                                    type: 'post',
                                                    day: post.conditions.min_day,
                                                    category: cat.title,
                                                    thread: thread.title,
                                                    user: post.user_name,
                                                    body: post.body?.substring(0, 60) + '...',
                                                    flag: post.conditions?.requires_flag
                                                });
                                            }
                                        });
                                    });
                                });

                                // Sort by day, then category
                                const sortedItems = [...timelineItems].sort((a, b) => {
                                    return a.day - b.day || a.category.localeCompare(b.category);
                                });

                                return (
                                    <div>
                                        <div style={{marginBottom: '20px', padding: '12px', background: '#2d2d30', borderRadius: '6px'}}>
                                            <strong>{timelineItems.length} item{timelineItems.length !== 1 ? 's' : ''}</strong> with day-based conditions
                                        </div>

                                        {sortedItems.length === 0 ? (
                                            <div style={{padding: '40px', textAlign: 'center', color: '#858585'}}>
                                                No day-based content unlocks found
                                            </div>
                                        ) : (
                                            <div style={{display: 'flex', flexDirection: 'column', gap: '8px'}}>
                                                {sortedItems.map((item, idx) => (
                                                    <div key={idx} className="form-section" style={{
                                                        borderLeft: item.type === 'thread' ? '4px solid #dcdcaa' : '4px solid #9cdcfe',
                                                        padding: '12px'
                                                    }}>
                                                        <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '6px'}}>
                                                            <div style={{display: 'flex', gap: '12px', alignItems: 'center'}}>
                                                                <span style={{
                                                                    background: '#4ec9b0',
                                                                    color: '#1e1e1e',
                                                                    padding: '2px 8px',
                                                                    borderRadius: '3px',
                                                                    fontSize: '12px',
                                                                    fontWeight: 'bold'
                                                                }}>
                                                                    Day {item.day}
                                                                </span>
                                                                <span style={{
                                                                    background: item.type === 'thread' ? '#dcdcaa' : '#9cdcfe',
                                                                    color: '#1e1e1e',
                                                                    padding: '2px 8px',
                                                                    borderRadius: '3px',
                                                                    fontSize: '11px',
                                                                    fontWeight: 'bold'
                                                                }}>
                                                                    {item.type === 'thread' ? '📋 THREAD' : '💬 POST'}
                                                                </span>
                                                            </div>
                                                            {item.flag && (
                                                                <span style={{
                                                                    color: '#ce9178',
                                                                    fontSize: '11px',
                                                                    background: '#2d2d30',
                                                                    padding: '2px 8px',
                                                                    borderRadius: '3px'
                                                                }}>
                                                                    🔒 {item.flag}
                                                                </span>
                                                            )}
                                                        </div>
                                                        
                                                        <div style={{fontSize: '13px', color: '#d4d4d4', marginBottom: '4px'}}>
                                                            <strong style={{color: '#4ec9b0'}}>{item.category}</strong>
                                                            <span style={{color: '#858585', margin: '0 6px'}}>→</span>
                                                            <strong style={{color: '#9cdcfe'}}>{item.thread}</strong>
                                                        </div>

                                                        {item.user && (
                                                            <div style={{fontSize: '12px', color: '#858585'}}>
                                                                <strong style={{color: '#ce9178'}}>{item.user}:</strong> {item.body}
                                                            </div>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                );
                            })()}
                        </div>
                    )}

                    {activeTab === 'tools' && (
                        <div>
                            <div className="form-section">
                                <h3 style={{marginBottom: '16px', color: '#4ec9b0'}}>Search & Replace</h3>
                                <div style={{marginBottom: '12px'}}>
                                    <label style={{display: 'block', marginBottom: '4px', fontSize: '13px'}}>Search for:</label>
                                    <input 
                                        type="text" 
                                        value={searchText}
                                        onChange={(e) => setSearchText(e.target.value)}
                                        placeholder="Enter text to find..."
                                        style={{width: '100%', padding: '8px', background: '#3c3c3c', border: '1px solid #3e3e42', color: '#d4d4d4', borderRadius: '4px'}}
                                    />
                                </div>
                                <div style={{marginBottom: '12px'}}>
                                    <label style={{display: 'block', marginBottom: '4px', fontSize: '13px'}}>Replace with:</label>
                                    <input 
                                        type="text" 
                                        value={replaceText}
                                        onChange={(e) => setReplaceText(e.target.value)}
                                        placeholder="Enter replacement text..."
                                        style={{width: '100%', padding: '8px', background: '#3c3c3c', border: '1px solid #3e3e42', color: '#d4d4d4', borderRadius: '4px'}}
                                    />
                                </div>
                                <div style={{marginBottom: '12px'}}>
                                    <label style={{display: 'block', marginBottom: '4px', fontSize: '13px'}}>Scope:</label>
                                    <select 
                                        value={searchScope}
                                        onChange={(e) => setSearchScope(e.target.value)}
                                        style={{width: '100%', padding: '8px', background: '#3c3c3c', border: '1px solid #3e3e42', color: '#d4d4d4', borderRadius: '4px'}}
                                    >
                                        <option value="all">All content</option>
                                        <option value="categories">Categories only</option>
                                        <option value="threads">Threads only</option>
                                        <option value="posts">Posts only</option>
                                    </select>
                                </div>
                                <button 
                                    onClick={() => {
                                        const count = searchAndReplace(searchText, replaceText, searchScope);
                                        alert(`Replaced ${count} occurrence(s)`);
                                    }}
                                    disabled={!searchText}
                                    style={{background: '#0e639c', color: 'white', border: 'none', padding: '10px 20px', borderRadius: '4px', cursor: searchText ? 'pointer' : 'not-allowed', opacity: searchText ? 1 : 0.5}}
                                >
                                    Replace All
                                </button>
                            </div>

                            <div className="form-section" style={{marginTop: '24px'}}>
                                <h3 style={{marginBottom: '16px', color: '#4ec9b0'}}>Quick Stats</h3>
                                <div style={{fontSize: '14px', color: '#d4d4d4', lineHeight: '1.8'}}>
                                    <div><strong>Categories:</strong> {data.length}</div>
                                    <div><strong>Total Threads:</strong> {data.reduce((sum, cat) => sum + cat.threads.length, 0)}</div>
                                    <div><strong>Total Posts:</strong> {data.reduce((sum, cat) => sum + cat.threads.reduce((s, t) => s + t.posts.length, 0), 0)}</div>
                                    <div><strong>Flags Defined:</strong> {flags.size}</div>
                                    <div><strong>Unique Characters:</strong> {users.size}</div>
                                </div>
                            </div>
                        </div>
                    )}

                    {activeTab === 'validation' && validationIssues && (
                        <div>
                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px'}}>
                                <h3 style={{color: '#4ec9b0', margin: 0}}>Validation Results</h3>
                                <div style={{fontSize: '14px', color: '#d4d4d4'}}>
                                    <span style={{color: '#f48771', marginRight: '12px'}}>
                                        {validationIssues.filter(i => i.type === 'error').length} errors
                                    </span>
                                    <span style={{color: '#dcdcaa', marginRight: '12px'}}>
                                        {validationIssues.filter(i => i.type === 'warning').length} warnings
                                    </span>
                                    <span style={{color: '#9cdcfe'}}>
                                        {validationIssues.filter(i => i.type === 'info').length} info
                                    </span>
                                </div>
                            </div>

                            {validationIssues.length === 0 ? (
                                <div className="success-message">
                                    ✅ No issues found! Your narrative structure looks good.
                                </div>
                            ) : (
                                <div style={{display: 'flex', flexDirection: 'column', gap: '8px'}}>
                                    {validationIssues.sort((a, b) => {
                                        // Sort by severity: error > warning > info
                                        const severityOrder = { error: 0, warning: 1, info: 2 };
                                        return severityOrder[a.type] - severityOrder[b.type];
                                    }).map((issue, idx) => (
                                        <div 
                                            key={idx} 
                                            className="form-section"
                                            style={{
                                                borderLeft: `4px solid ${issue.type === 'error' ? '#f48771' : issue.type === 'warning' ? '#dcdcaa' : '#9cdcfe'}`,
                                                cursor: issue.path ? 'pointer' : 'default'
                                            }}
                                            onClick={() => {
                                                if (issue.path) {
                                                    const [catIdx, threadIdx, postIdx] = issue.path;
                                                    if (postIdx !== undefined) {
                                                        setSelectedItem({ type: 'post', path: issue.path });
                                                    } else if (threadIdx !== undefined) {
                                                        setSelectedItem({ type: 'thread', path: issue.path });
                                                    } else {
                                                        setSelectedItem({ type: 'category', path: issue.path });
                                                    }
                                                    setView('tree');
                                                }
                                            }}
                                        >
                                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start'}}>
                                                <div>
                                                    <div style={{
                                                        fontSize: '12px', 
                                                        fontWeight: 'bold', 
                                                        color: issue.type === 'error' ? '#f48771' : issue.type === 'warning' ? '#dcdcaa' : '#9cdcfe',
                                                        marginBottom: '4px'
                                                    }}>
                                                        {issue.type === 'error' ? '❌' : issue.type === 'warning' ? '⚠️' : 'ℹ️'} {issue.category}
                                                    </div>
                                                    <div style={{fontSize: '14px', color: '#d4d4d4'}}>
                                                        {issue.message}
                                                    </div>
                                                </div>
                                                {issue.path && (
                                                    <div style={{fontSize: '11px', color: '#858585', marginLeft: '12px'}}>
                                                        Click to view →
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}

                    {activeTab === 'flags' && (
                        <div>
                            <h3 style={{marginBottom: '16px', color: '#4ec9b0'}}>Flag Usage</h3>
                            {flags.size === 0 ? (
                                <p style={{color: '#858585'}}>No flags defined yet.</p>
                            ) : (
                                <div style={{display: 'flex', flexDirection: 'column', gap: '12px'}}>
                                    {Array.from(flags.entries()).map(([flag, usage]) => (
                                        <div key={flag} className="form-section">
                                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px'}}>
                                                <h4 style={{color: '#dcdcaa', margin: 0}}>{flag}</h4>
                                                <div style={{display: 'flex', gap: '8px'}}>
                                                    <span style={{fontSize: '12px', color: '#4ec9b0'}}>
                                                        Set by: {usage.setBy.length}
                                                    </span>
                                                    <span style={{fontSize: '12px', color: '#ce9178'}}>
                                                        Required by: {usage.requiredBy.length}
                                                    </span>
                                                </div>
                                            </div>
                                            
                                            {usage.setBy.length > 0 && (
                                                <div style={{marginBottom: '8px'}}>
                                                    <div style={{fontSize: '12px', color: '#858585', marginBottom: '4px'}}>Set by:</div>
                                                    {usage.setBy.map((item, idx) => (
                                                        <div 
                                                            key={idx} 
                                                            style={{fontSize: '13px', padding: '4px 8px', background: '#1e1e1e', borderRadius: '3px', marginBottom: '2px', cursor: 'pointer'}}
                                                            onClick={() => {
                                                                setSelectedItem({ type: item.type, path: item.path });
                                                                setView('tree');
                                                            }}
                                                        >
                                                            → {item.title}
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                            
                                            {usage.requiredBy.length > 0 && (
                                                <div>
                                                    <div style={{fontSize: '12px', color: '#858585', marginBottom: '4px'}}>Required by:</div>
                                                    {usage.requiredBy.map((item, idx) => (
                                                        <div 
                                                            key={idx} 
                                                            style={{fontSize: '13px', padding: '4px 8px', background: '#1e1e1e', borderRadius: '3px', marginBottom: '2px', cursor: 'pointer'}}
                                                            onClick={() => {
                                                                setSelectedItem({ type: item.type, path: item.path });
                                                                setView('tree');
                                                            }}
                                                        >
                                                            🔒 {item.title}
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                            
                                            {usage.setBy.length === 0 && (
                                                <div style={{color: '#c73131', fontSize: '13px'}}>⚠️ Flag is required but never set!</div>
                                            )}
                                            {usage.requiredBy.length === 0 && (
                                                <div style={{color: '#ce9178', fontSize: '13px'}}>⚠️ Flag is set but never used</div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}

                    {activeTab === 'users' && (
                        <div>
                            <h3 style={{marginBottom: '16px', color: '#4ec9b0'}}>Asset Lists</h3>
                            <p style={{color: '#858585', marginBottom: '20px', fontSize: '14px'}}>
                                Overview of all avatars, users, and ranks used in your narrative
                            </p>

                            {/* Avatars Section */}
                            <div className="form-section" style={{marginBottom: '20px'}}>
                                <h4 style={{color: '#9cdcfe', marginBottom: '12px', fontSize: '16px'}}>🎨 Avatars Needed</h4>
                                {(() => {
                                    const avatars = new Map(); // avatar -> count
                                    data.forEach(cat => {
                                        cat.threads.forEach(thread => {
                                            thread.posts.forEach(post => {
                                                if (post.avatar) {
                                                    avatars.set(post.avatar, (avatars.get(post.avatar) || 0) + 1);
                                                }
                                            });
                                        });
                                    });

                                    if (avatars.size === 0) {
                                        return <p style={{color: '#858585'}}>No avatars defined</p>;
                                    }

                                    return (
                                        <div>
                                            <div style={{marginBottom: '12px', color: '#858585', fontSize: '13px'}}>
                                                Total unique avatars: <strong>{avatars.size}</strong>
                                            </div>
                                            <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(200px, 1fr))', gap: '8px'}}>
                                                {Array.from(avatars.entries()).sort((a, b) => b[1] - a[1]).map(([avatar, count]) => (
                                                    <div key={avatar} style={{
                                                        padding: '8px 12px',
                                                        background: '#2d2d30',
                                                        borderRadius: '4px',
                                                        borderLeft: '3px solid #9cdcfe'
                                                    }}>
                                                        <div style={{fontSize: '13px', color: '#d4d4d4', marginBottom: '4px', fontFamily: 'monospace'}}>
                                                            {avatar}
                                                        </div>
                                                        <div style={{fontSize: '11px', color: '#858585'}}>
                                                            Used {count} time{count !== 1 ? 's' : ''}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    );
                                })()}
                            </div>

                            {/* Users Section */}
                            <div className="form-section" style={{marginBottom: '20px'}}>
                                <h4 style={{color: '#9cdcfe', marginBottom: '12px', fontSize: '16px'}}>👤 Characters/Users</h4>
                                {users.size === 0 ? (
                                    <p style={{color: '#858585'}}>No users found</p>
                                ) : (
                                    <div>
                                        <div style={{marginBottom: '12px', color: '#858585', fontSize: '13px'}}>
                                            Total unique users: <strong>{users.size}</strong>
                                        </div>
                                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(250px, 1fr))', gap: '12px'}}>
                                            {Array.from(users.entries()).sort((a, b) => b[1].postCount - a[1].postCount).map(([userName, info]) => (
                                                <div key={userName} style={{
                                                    padding: '12px',
                                                    background: '#2d2d30',
                                                    borderRadius: '4px',
                                                    borderLeft: '3px solid #ce9178'
                                                }}>
                                                    <div style={{fontSize: '14px', color: '#9cdcfe', fontWeight: 'bold', marginBottom: '8px'}}>
                                                        {userName}
                                                    </div>
                                                    <div style={{fontSize: '12px', color: '#d4d4d4', marginBottom: '4px'}}>
                                                        <strong>{info.postCount}</strong> post{info.postCount !== 1 ? 's' : ''}
                                                    </div>
                                                    <div style={{fontSize: '12px', color: '#858585', marginBottom: '6px'}}>
                                                        Ranks: {Array.from(info.ranks).join(', ')}
                                                    </div>
                                                    <div style={{fontSize: '11px', color: '#858585'}}>
                                                        Avatars: {Array.from(info.avatars).join(', ')}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Ranks Section */}
                            <div className="form-section">
                                <h4 style={{color: '#9cdcfe', marginBottom: '12px', fontSize: '16px'}}>⭐ User Ranks</h4>
                                {(() => {
                                    const ranks = new Map(); // rank -> count
                                    data.forEach(cat => {
                                        cat.threads.forEach(thread => {
                                            thread.posts.forEach(post => {
                                                if (post.user_rank) {
                                                    ranks.set(post.user_rank, (ranks.get(post.user_rank) || 0) + 1);
                                                }
                                            });
                                        });
                                    });

                                    if (ranks.size === 0) {
                                        return <p style={{color: '#858585'}}>No ranks defined</p>;
                                    }

                                    return (
                                        <div>
                                            <div style={{marginBottom: '12px', color: '#858585', fontSize: '13px'}}>
                                                Total unique ranks: <strong>{ranks.size}</strong>
                                            </div>
                                            <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(150px, 1fr))', gap: '8px'}}>
                                                {Array.from(ranks.entries()).sort((a, b) => b[1] - a[1]).map(([rank, count]) => (
                                                    <div key={rank} style={{
                                                        padding: '8px 12px',
                                                        background: '#2d2d30',
                                                        borderRadius: '4px',
                                                        borderLeft: '3px solid #dcdcaa'
                                                    }}>
                                                        <div style={{fontSize: '13px', color: '#dcdcaa', fontWeight: 'bold', marginBottom: '4px'}}>
                                                            {rank}
                                                        </div>
                                                        <div style={{fontSize: '11px', color: '#858585'}}>
                                                            {count} post{count !== 1 ? 's' : ''}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    );
                                })()}
                            </div>

                            {/* Icons Section */}
                            <div className="form-section" style={{marginTop: '20px'}}>
                                <h4 style={{color: '#9cdcfe', marginBottom: '12px', fontSize: '16px'}}>🎭 Icons Needed</h4>
                                {(() => {
                                    const icons = new Set();
                                    data.forEach(cat => {
                                        if (cat.icon) icons.add(cat.icon);
                                        cat.threads.forEach(thread => {
                                            if (thread.icon) icons.add(thread.icon);
                                        });
                                    });

                                    if (icons.size === 0) {
                                        return <p style={{color: '#858585'}}>No icons defined</p>;
                                    }

                                    return (
                                        <div>
                                            <div style={{marginBottom: '12px', color: '#858585', fontSize: '13px'}}>
                                                Total unique icons: <strong>{icons.size}</strong>
                                            </div>
                                            <div style={{display: 'flex', flexWrap: 'wrap', gap: '8px'}}>
                                                {Array.from(icons).sort().map(icon => (
                                                    <div key={icon} style={{
                                                        padding: '6px 12px',
                                                        background: '#2d2d30',
                                                        borderRadius: '4px',
                                                        fontSize: '12px',
                                                        color: '#d4d4d4',
                                                        fontFamily: 'monospace'
                                                    }}>
                                                        {icon}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    );
                                })()}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function ForumPreviewPanel({ data, simulatedDay, setSimulatedDay, simulatedFlags, setSimulatedFlags }) {
            const [expandedCategories, setExpandedCategories] = useState(new Set());
            const [selectedThread, setSelectedThread] = useState(null); // {catIndex, threadIndex}

            // Filter content based on simulated state
            const getVisibleData = () => {
                return data.map((cat, catIdx) => ({
                    ...cat,
                    catIndex: catIdx,
                    threads: cat.threads.map((thread, threadIdx) => ({
                        ...thread,
                        threadIndex: threadIdx,
                        visible: (() => {
                            if (thread.conditions) {
                                if (thread.conditions.min_day && simulatedDay < thread.conditions.min_day) return false;
                                if (thread.conditions.requires_flag && !simulatedFlags.has(thread.conditions.requires_flag)) return false;
                            }
                            return true;
                        })(),
                        posts: thread.posts.filter(post => {
                            if (post.conditions) {
                                if (post.conditions.min_day && simulatedDay < post.conditions.min_day) return false;
                                if (post.conditions.requires_flag && !simulatedFlags.has(post.conditions.requires_flag)) return false;
                            }
                            return true;
                        })
                    })).filter(t => t.visible)
                })).filter(cat => cat.threads.length > 0);
            };

            const visibleData = getVisibleData();

            const handleOptionClick = (option) => {
                if (option.set_flag) {
                    setSimulatedFlags(new Set([...simulatedFlags, option.set_flag]));
                }
            };

            // Get currently selected thread data
            const getSelectedThreadData = () => {
                if (!selectedThread) return null;
                const cat = visibleData.find(c => c.catIndex === selectedThread.catIndex);
                if (!cat) return null;
                const thread = cat.threads.find(t => t.threadIndex === selectedThread.threadIndex);
                return thread;
            };

            const selectedThreadData = getSelectedThreadData();

            return (
                <div style={{display: 'flex', flexDirection: 'column', height: '100%', width: '100%', background: '#1e1e1e'}}>
                    {/* Top Controls Bar */}
                    <div style={{display: 'flex', gap: '20px', padding: '16px 20px', background: '#252526', borderBottom: '1px solid #3e3e42', alignItems: 'center'}}>
                        <h2 style={{margin: 0, color: '#4ec9b0'}}>Forum Preview</h2>
                        
                        <div style={{display: 'flex', gap: '12px', alignItems: 'center'}}>
                            <label style={{fontSize: '14px', fontWeight: 'bold'}}>Day:</label>
                            <input 
                                type="number" 
                                value={simulatedDay}
                                onChange={(e) => setSimulatedDay(parseInt(e.target.value) || 0)}
                                style={{width: '80px', padding: '6px', background: '#3c3c3c', border: '1px solid #3e3e42', color: '#d4d4d4', borderRadius: '4px'}}
                            />
                        </div>

                        <div style={{display: 'flex', gap: '8px', alignItems: 'center', flex: 1}}>
                            <label style={{fontSize: '14px', fontWeight: 'bold'}}>Flags:</label>
                            {simulatedFlags.size === 0 ? (
                                <span style={{color: '#858585', fontSize: '13px'}}>None</span>
                            ) : (
                                <div style={{display: 'flex', gap: '4px', flexWrap: 'wrap'}}>
                                    {Array.from(simulatedFlags).map(flag => (
                                        <div key={flag} style={{
                                            padding: '4px 8px',
                                            background: '#0e639c',
                                            borderRadius: '3px',
                                            fontSize: '12px',
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '6px'
                                        }}>
                                            <span>{flag}</span>
                                            <button 
                                                onClick={() => {
                                                    const newFlags = new Set(simulatedFlags);
                                                    newFlags.delete(flag);
                                                    setSimulatedFlags(newFlags);
                                                }}
                                                style={{background: 'transparent', border: 'none', color: 'white', cursor: 'pointer', fontSize: '14px', padding: 0, lineHeight: 1}}
                                            >
                                                ×
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            )}
                            <button 
                                onClick={() => setSimulatedFlags(new Set())}
                                style={{marginLeft: 'auto', padding: '6px 12px', background: '#3e3e42', border: 'none', color: '#d4d4d4', borderRadius: '4px', cursor: 'pointer', fontSize: '12px'}}
                            >
                                Clear Flags
                            </button>
                        </div>

                        <div style={{fontSize: '12px', color: '#858585'}}>
                            {visibleData.reduce((sum, cat) => sum + cat.threads.length, 0)} threads • {visibleData.reduce((sum, cat) => sum + cat.threads.reduce((s, t) => s + t.posts.length, 0), 0)} posts
                        </div>
                    </div>

                    {/* Main Content Area */}
                    <div style={{display: 'flex', flex: 1, overflow: 'hidden'}}>
                        {/* Left: Categories & Threads List */}
                        <div style={{width: '400px', background: '#252526', borderRight: '1px solid #3e3e42', overflowY: 'auto'}}>
                            {visibleData.map((cat) => (
                                <div key={cat.id}>
                                    <div 
                                        style={{
                                            padding: '12px 20px',
                                            background: '#2d2d30',
                                            borderBottom: '1px solid #4ec9b0',
                                            cursor: 'pointer',
                                            display: 'flex',
                                            justifyContent: 'space-between',
                                            alignItems: 'center'
                                        }}
                                        onClick={() => {
                                            const newExpanded = new Set(expandedCategories);
                                            if (newExpanded.has(cat.id)) {
                                                newExpanded.delete(cat.id);
                                            } else {
                                                newExpanded.add(cat.id);
                                            }
                                            setExpandedCategories(newExpanded);
                                        }}
                                    >
                                        <div>
                                            <div style={{fontSize: '16px', fontWeight: 'bold', color: '#4ec9b0'}}>{cat.title}</div>
                                            <div style={{fontSize: '12px', color: '#858585', marginTop: '2px'}}>{cat.subtitle}</div>
                                        </div>
                                        <span style={{fontSize: '16px'}}>{expandedCategories.has(cat.id) ? '▼' : '▶'}</span>
                                    </div>

                                    {expandedCategories.has(cat.id) && cat.threads.map((thread) => (
                                        <div 
                                            key={thread.id}
                                            style={{
                                                padding: '10px 20px',
                                                background: selectedThread?.catIndex === cat.catIndex && selectedThread?.threadIndex === thread.threadIndex ? '#3e3e42' : '#1e1e1e',
                                                borderBottom: '1px solid #2d2d30',
                                                cursor: 'pointer'
                                            }}
                                            onClick={() => setSelectedThread({ catIndex: cat.catIndex, threadIndex: thread.threadIndex })}
                                        >
                                            <div style={{fontSize: '14px', color: '#9cdcfe', fontWeight: '500'}}>
                                                {thread.pinned && '📌 '}{thread.title}
                                            </div>
                                            <div style={{fontSize: '11px', color: '#858585', marginTop: '2px'}}>
                                                {thread.subtitle} • {thread.posts.length} posts
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            ))}
                        </div>

                        {/* Right: Thread Posts Display */}
                        <div style={{flex: 1, overflowY: 'auto', padding: '20px', background: '#1e1e1e'}}>
                            {!selectedThreadData ? (
                                <div style={{textAlign: 'center', padding: '60px', color: '#858585'}}>
                                    <h3>Select a thread to view posts</h3>
                                    <p>Click on any thread from the list on the left</p>
                                </div>
                            ) : (
                                <div style={{width: '100%', maxWidth: 'none'}}>
                                    <div style={{marginBottom: '30px', paddingBottom: '20px', borderBottom: '2px solid #3e3e42'}}>
                                        <h2 style={{margin: 0, color: '#9cdcfe', fontSize: '24px'}}>{selectedThreadData.pinned && '📌 '}{selectedThreadData.title}</h2>
                                        <p style={{margin: '8px 0 0 0', color: '#858585'}}>{selectedThreadData.subtitle}</p>
                                    </div>

                                    {selectedThreadData.posts.map((post, postIdx) => (
                                        <div key={post.id} style={{
                                            marginBottom: '20px',
                                            padding: '20px',
                                            background: '#252526',
                                            borderRadius: '8px',
                                            borderLeft: post.type === 'reply' ? '4px solid #ce9178' : post.type === 'alert' ? '4px solid #dcdcaa' : '4px solid #9cdcfe',
                                            width: '100%'
                                        }}>
                                            <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '12px'}}>
                                                <div>
                                                    <strong style={{color: '#9cdcfe', fontSize: '16px'}}>{post.user_name}</strong>
                                                    <span style={{marginLeft: '10px', fontSize: '13px', color: '#858585'}}>{post.user_rank}</span>
                                                </div>
                                                <span style={{fontSize: '12px', color: '#858585'}}>TS: {post.timestamp}</span>
                                            </div>

                                            {post.quote_text && (
                                                <div style={{
                                                    padding: '10px 15px',
                                                    marginBottom: '12px',
                                                    background: '#1e1e1e',
                                                    borderLeft: '4px solid #569cd6',
                                                    fontSize: '14px',
                                                    color: '#d4d4d4'
                                                }}>
                                                    <div style={{color: '#9cdcfe', fontWeight: 'bold', marginBottom: '4px'}}>{post.quote_user}:</div>
                                                    {post.quote_text}
                                                </div>
                                            )}

                                            <p style={{margin: 0, lineHeight: '1.7', fontSize: '15px'}}>{post.body}</p>

                                            {post.options && post.options.length > 0 && (
                                                <div style={{marginTop: '16px', display: 'flex', flexWrap: 'wrap', gap: '10px'}}>
                                                    {post.options.map((opt, optIdx) => (
                                                        <button 
                                                            key={optIdx}
                                                            onClick={() => handleOptionClick(opt)}
                                                            disabled={simulatedFlags.has(opt.set_flag)}
                                                            style={{
                                                                padding: '10px 20px',
                                                                background: simulatedFlags.has(opt.set_flag) ? '#3e3e42' : '#0e639c',
                                                                border: 'none',
                                                                borderRadius: '4px',
                                                                color: 'white',
                                                                cursor: simulatedFlags.has(opt.set_flag) ? 'not-allowed' : 'pointer',
                                                                fontSize: '14px',
                                                                fontWeight: '500',
                                                                opacity: simulatedFlags.has(opt.set_flag) ? 0.5 : 1
                                                            }}
                                                        >
                                                            {opt.text} {simulatedFlags.has(opt.set_flag) && '✓'}
                                                        </button>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        function DetailModal({ item, onClose, data, updateItem, notes, itemTags, runValidation }) {
            if (!item) return null;

            const [catIndex, threadIndex, postIndex] = item.path;
            let itemData;
            let itemType = item.type;

            if (itemType === 'category') {
                itemData = data[catIndex];
            } else if (itemType === 'thread') {
                itemData = data[catIndex].threads[threadIndex];
            } else if (itemType === 'post') {
                itemData = data[catIndex].threads[threadIndex].posts[postIndex];
            }

            const allFields = itemType === 'post' 
                ? ['id', 'type', 'timestamp', 'user_name', 'user_rank', 'avatar', 'body', 'quote_user', 'quote_text', 'conditions', 'options']
                : itemType === 'thread'
                ? ['id', 'title', 'subtitle', 'icon', 'pinned', 'conditions', 'posts']
                : ['id', 'title', 'subtitle', 'icon', 'threads'];

            return (
                <div style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    background: 'rgba(0,0,0,0.8)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    zIndex: 1000
                }}>
                    <div style={{
                        background: '#1e1e1e',
                        border: '1px solid #3e3e42',
                        borderRadius: '8px',
                        width: '90%',
                        maxWidth: '800px',
                        maxHeight: '80vh',
                        overflow: 'auto',
                        padding: '24px'
                    }}>
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px'}}>
                            <h2 style={{color: '#4ec9b0', margin: 0}}>
                                {itemType === 'post' ? '💭' : itemType === 'thread' ? '💬' : '📁'} {itemType.toUpperCase()} Details
                            </h2>
                            <button onClick={onClose} style={{background: '#3e3e42', border: 'none', color: '#d4d4d4', padding: '8px 16px', borderRadius: '4px', cursor: 'pointer'}}>
                                Close
                            </button>
                        </div>

                        {/* Validation Issues Section */}
                        {runValidation && (() => {
                            const issues = runValidation();
                            const itemIssues = issues.filter(issue => {
                                if (!issue.path) return false;
                                
                                if (itemType === 'category') {
                                    return issue.path[0] === catIndex && issue.path[1] === undefined;
                                } else if (itemType === 'thread') {
                                    return issue.path[0] === catIndex && issue.path[1] === threadIndex && issue.path[2] === undefined;
                                } else if (itemType === 'post') {
                                    return issue.path[0] === catIndex && issue.path[1] === threadIndex && issue.path[2] === postIndex;
                                }
                                return false;
                            });
                            
                            if (itemIssues.length === 0) return null;
                            
                            return (
                                <div style={{marginBottom: '20px', padding: '16px', background: '#2d2d30', borderRadius: '6px'}}>
                                    <h3 style={{margin: '0 0 12px 0', color: '#f48771', fontSize: '14px'}}>⚠️ Validation Issues</h3>
                                    {itemIssues.map((issue, idx) => (
                                        <div key={idx} style={{
                                            padding: '8px 12px',
                                            marginBottom: '8px',
                                            background: issue.type === 'error' ? '#3e1e1e' : issue.type === 'warning' ? '#3e3e1e' : '#1e2e3e',
                                            borderLeft: `4px solid ${issue.type === 'error' ? '#f48771' : issue.type === 'warning' ? '#dcdcaa' : '#569cd6'}`,
                                            borderRadius: '4px'
                                        }}>
                                            <div style={{
                                                color: issue.type === 'error' ? '#f48771' : issue.type === 'warning' ? '#dcdcaa' : '#569cd6',
                                                fontSize: '12px',
                                                fontWeight: 'bold',
                                                marginBottom: '4px'
                                            }}>
                                                {issue.type === 'error' ? '❌ ERROR' : issue.type === 'warning' ? '⚠️ WARNING' : 'ℹ️ INFO'}: {issue.category}
                                            </div>
                                            <div style={{color: '#d4d4d4', fontSize: '13px'}}>
                                                {issue.message}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            );
                        })()}

                        {/* Tags Section */}
                        {itemTags[itemData.id] && itemTags[itemData.id].length > 0 && (
                            <div style={{marginBottom: '20px', padding: '16px', background: '#2d2d30', borderRadius: '6px'}}>
                                <h3 style={{margin: '0 0 12px 0', color: '#dcdcaa', fontSize: '14px'}}>🏷️ Tags</h3>
                                <div style={{display: 'flex', flexWrap: 'wrap', gap: '8px'}}>
                                    {itemTags[itemData.id].map((tag, idx) => (
                                        <div key={idx} style={{
                                            padding: '6px 12px',
                                            background: '#dcdcaa',
                                            color: '#1e1e1e',
                                            borderRadius: '12px',
                                            fontSize: '13px',
                                            fontWeight: '500'
                                        }}>
                                            {tag}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Notes Section */}
                        {notes[itemData.id] && (
                            <div style={{marginBottom: '20px', padding: '16px', background: '#2d2d30', borderRadius: '6px'}}>
                                <h3 style={{margin: '0 0 12px 0', color: '#569cd6', fontSize: '14px'}}>📝 Internal Notes</h3>
                                <div style={{
                                    padding: '12px',
                                    background: '#1e1e1e',
                                    borderRadius: '4px',
                                    color: '#d4d4d4',
                                    fontSize: '13px',
                                    whiteSpace: 'pre-wrap',
                                    lineHeight: '1.6'
                                }}>
                                    {notes[itemData.id]}
                                </div>
                            </div>
                        )}

                        <table style={{width: '100%', borderCollapse: 'collapse'}}>
                            <thead>
                                <tr style={{borderBottom: '2px solid #3e3e42'}}>
                                    <th style={{textAlign: 'left', padding: '12px', color: '#9cdcfe', width: '30%'}}>Field</th>
                                    <th style={{textAlign: 'left', padding: '12px', color: '#9cdcfe'}}>Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                {allFields.map(field => {
                                    let value = itemData[field];
                                    let displayValue;

                                    if (value === undefined || value === null) {
                                        displayValue = <span style={{color: '#858585', fontStyle: 'italic'}}>empty</span>;
                                    } else if (typeof value === 'object') {
                                        displayValue = <pre style={{margin: 0, fontSize: '12px', color: '#ce9178'}}>{JSON.stringify(value, null, 2)}</pre>;
                                    } else if (typeof value === 'boolean') {
                                        displayValue = <span style={{color: value ? '#4ec9b0' : '#858585'}}>{value ? 'true' : 'false'}</span>;
                                    } else {
                                        displayValue = <span style={{color: '#d4d4d4'}}>{value}</span>;
                                    }

                                    return (
                                        <tr key={field} style={{borderBottom: '1px solid #2d2d30'}}>
                                            <td style={{padding: '12px', color: '#dcdcaa', fontWeight: '500'}}>{field}</td>
                                            <td style={{padding: '12px', wordBreak: 'break-word'}}>{displayValue}</td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        // Render the app
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
